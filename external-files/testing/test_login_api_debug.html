<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–ª–∞–¥–∫–∞ API –ª–æ–≥–∏–Ω–∞ - Tire Service</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1976d2;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-case {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
        }
        .result {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #1565c0;
        }
        .input {
            width: 200px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –û—Ç–ª–∞–¥–∫–∞ API –ª–æ–≥–∏–Ω–∞</h1>
        
        <div class="test-section">
            <h3>üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API</h3>
            <button class="button" onclick="checkApiHealth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/v1/health</button>
            <div id="healthResult" class="result">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
        </div>

        <div class="test-section">
            <h3>üîê –¢–µ—Å—Ç –ª–æ–≥–∏–Ω–∞</h3>
            <div>
                <input type="text" id="loginEmail" class="input" value="admin@test.com" placeholder="Email">
                <input type="password" id="loginPassword" class="input" value="admin123" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="button" onclick="testLogin()">–¢–µ—Å—Ç –ª–æ–≥–∏–Ω–∞</button>
            </div>
            <div id="loginResult" class="result">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É</div>
        </div>

        <div class="test-section">
            <h3>üì± –¢–µ—Å—Ç –ª–æ–≥–∏–Ω–∞ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º</h3>
            <div>
                <input type="text" id="phoneLogin" class="input" value="+380672220000" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
                <input type="password" id="phonePassword" class="input" value="admin123" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="button" onclick="testPhoneLogin()">–¢–µ—Å—Ç —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º</button>
            </div>
            <div id="phoneLoginResult" class="result">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É</div>
        </div>

        <div class="test-section">
            <h3>üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <button class="button" onclick="checkCurrentUser()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/v1/auth/me</button>
            <div id="currentUserResult" class="result">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
        </div>

        <div class="test-section">
            <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</h3>
            <div id="configInfo" class="result">
API URL: http://localhost:8000/api/v1
–¢–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω: ${window.location.origin}
User Agent: ${navigator.userAgent}
            </div>
        </div>

        <div class="test-section">
            <h3>üìä –°–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã</h3>
            <p>–û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Network tab –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤</p>
            <button class="button" onclick="clearResults()">–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';

        function updateResult(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = isError ? 'result error' : 'result success';
        }

        async function checkApiHealth() {
            try {
                updateResult('healthResult', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API...');
                
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    credentials: 'include',
                });

                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    url: response.url,
                    ok: response.ok
                };

                updateResult('healthResult', 
                    `‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω\n` +
                    `Status: ${result.status} ${result.statusText}\n` +
                    `URL: ${result.url}\n` +
                    `Headers: ${JSON.stringify(result.headers, null, 2)}`
                );
            } catch (error) {
                updateResult('healthResult', 
                    `‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API:\n${error.message}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –ó–∞–ø—É—â–µ–Ω –ª–∏ backend –Ω–∞ –ø–æ—Ä—Ç—É 8000\n2. –ù–µ—Ç –ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ CORS`, 
                    true
                );
            }
        }

        async function testLogin() {
            try {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                updateResult('loginResult', '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –ª–æ–≥–∏–Ω–∞...');

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        auth: {
                            login: email,
                            password: password
                        }
                    })
                });

                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }

                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    url: response.url,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: responseData
                };

                if (response.ok) {
                    updateResult('loginResult', 
                        `‚úÖ –õ–æ–≥–∏–Ω —É—Å–ø–µ—à–µ–Ω!\n` +
                        `Status: ${result.status}\n` +
                        `User: ${responseData.user?.email}\n` +
                        `Role: ${responseData.user?.role}\n` +
                        `Token: ${responseData.access_token ? '–ø–æ–ª—É—á–µ–Ω' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}\n` +
                        `Full response: ${JSON.stringify(result, null, 2)}`
                    );
                } else {
                    updateResult('loginResult', 
                        `‚ùå –û—à–∏–±–∫–∞ –ª–æ–≥–∏–Ω–∞\n` +
                        `Status: ${result.status} ${result.statusText}\n` +
                        `URL: ${result.url}\n` +
                        `Response: ${JSON.stringify(result, null, 2)}`, 
                        true
                    );
                }
            } catch (error) {
                updateResult('loginResult', 
                    `‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:\n${error.message}\n\n–¢–∏–ø –æ—à–∏–±–∫–∏: ${error.name}\nStack: ${error.stack}`, 
                    true
                );
            }
        }

        async function testPhoneLogin() {
            try {
                const phone = document.getElementById('phoneLogin').value;
                const password = document.getElementById('phonePassword').value;
                
                updateResult('phoneLoginResult', '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –ª–æ–≥–∏–Ω–∞ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º...');

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        auth: {
                            login: phone,
                            password: password
                        }
                    })
                });

                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }

                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    url: response.url,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: responseData
                };

                if (response.ok) {
                    updateResult('phoneLoginResult', 
                        `‚úÖ –õ–æ–≥–∏–Ω —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º —É—Å–ø–µ—à–µ–Ω!\n` +
                        `Status: ${result.status}\n` +
                        `User: ${responseData.user?.email || responseData.user?.phone}\n` +
                        `Role: ${responseData.user?.role}\n` +
                        `Full response: ${JSON.stringify(result, null, 2)}`
                    );
                } else {
                    updateResult('phoneLoginResult', 
                        `‚ùå –û—à–∏–±–∫–∞ –ª–æ–≥–∏–Ω–∞ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º\n` +
                        `Status: ${result.status} ${result.statusText}\n` +
                        `Response: ${JSON.stringify(result, null, 2)}`, 
                        true
                    );
                }
            } catch (error) {
                updateResult('phoneLoginResult', 
                    `‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:\n${error.message}`, 
                    true
                );
            }
        }

        async function checkCurrentUser() {
            try {
                updateResult('currentUserResult', '–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');

                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    credentials: 'include',
                });

                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }

                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    url: response.url,
                    ok: response.ok,
                    data: responseData
                };

                if (response.ok) {
                    updateResult('currentUserResult', 
                        `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!\n` +
                        `User: ${responseData.user?.email}\n` +
                        `Role: ${responseData.user?.role}\n` +
                        `Full response: ${JSON.stringify(result, null, 2)}`
                    );
                } else {
                    updateResult('currentUserResult', 
                        `‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω\n` +
                        `Status: ${result.status} ${result.statusText}\n` +
                        `Response: ${JSON.stringify(result, null, 2)}`, 
                        true
                    );
                }
            } catch (error) {
                updateResult('currentUserResult', 
                    `‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:\n${error.message}`, 
                    true
                );
            }
        }

        function clearResults() {
            const results = document.querySelectorAll('.result');
            results.forEach(result => {
                result.textContent = '–û—á–∏—â–µ–Ω–æ';
                result.className = 'result';
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            checkApiHealth();
        });
    </script>
</body>
</html> 