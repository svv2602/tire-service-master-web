<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîë –¢–µ—Å—Ç Google OAuth –Ω–∞—Å—Ç—Ä–æ–µ–∫</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #4285f4;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4285f4;
        }
        .button {
            background: linear-gradient(45deg, #4285f4 30%, #34a853 90%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.4);
        }
        .result {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #d32f2f;
        }
        .info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1976d2;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .checkbox {
            margin: 10px 0;
        }
        .status-chip {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .status-production { background: #4caf50; color: white; }
        .status-configured { background: #2196f3; color: white; }
        .status-misconfigured { background: #f44336; color: white; }
        .status-disabled { background: #9e9e9e; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîë –¢–µ—Å—Ç Google OAuth –Ω–∞—Å—Ç—Ä–æ–µ–∫</h1>
        
        <div class="test-section">
            <h3>üìã –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <button class="button" onclick="loadSettings()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <div id="settingsResult"></div>
        </div>

        <div class="test-section">
            <h3>‚öôÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫</h3>
            <form id="settingsForm">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" id="enabled"> –í–∫–ª—é—á–∏—Ç—å Google OAuth
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="clientId">Client ID:</label>
                    <input type="text" id="clientId" placeholder="xxxxxx.apps.googleusercontent.com">
                </div>
                
                <div class="form-group">
                    <label for="clientSecret">Client Secret:</label>
                    <input type="password" id="clientSecret" placeholder="–í–≤–µ–¥–∏—Ç–µ Client Secret">
                </div>
                
                <div class="form-group">
                    <label for="redirectUri">Redirect URI:</label>
                    <input type="text" id="redirectUri" value="http://localhost:3008/auth/google/callback">
                </div>
                
                <div class="checkbox">
                    <label>
                        <input type="checkbox" id="allowRegistration" checked> –†–∞–∑—Ä–µ—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
                    </label>
                </div>
                
                <div class="checkbox">
                    <label>
                        <input type="checkbox" id="autoVerifyEmail" checked> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å email
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="scopesList">Scopes (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                    <input type="text" id="scopesList" value="email,profile">
                </div>
                
                <button type="button" class="button" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </form>
            <div id="saveResult"></div>
        </div>

        <div class="test-section">
            <h3>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
            <button class="button" onclick="testConnection()">üîó –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
            <div id="testResult"></div>
        </div>

        <div class="test-section">
            <h3>üîß –ü–æ–ª—É—á–µ–Ω–∏–µ URL –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
            <button class="button" onclick="getAuthUrl()">üåê –ü–æ–ª—É—á–∏—Ç—å Authorization URL</button>
            <div id="authUrlResult"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è API –∑–∞–ø—Ä–æ—Å–æ–≤
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayResult(elementId, result, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${isError ? 'error' : ''}">${JSON.stringify(result, null, 2)}</div>`;
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function loadSettings() {
            console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Google OAuth...');
            
            const result = await apiRequest('/google_oauth_settings');
            
            if (result.success) {
                console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', result.data);
                
                const settings = result.data.google_oauth_settings;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('enabled').checked = settings.enabled;
                document.getElementById('clientId').value = settings.client_id || '';
                document.getElementById('clientSecret').value = settings.client_secret || '';
                document.getElementById('redirectUri').value = settings.redirect_uri || '';
                document.getElementById('allowRegistration').checked = settings.allow_registration;
                document.getElementById('autoVerifyEmail').checked = settings.auto_verify_email;
                document.getElementById('scopesList').value = settings.scopes_list || '';
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å
                let statusHtml = `
                    <h4>üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h4>
                    <div class="status-chip status-${settings.system_status}">${settings.status_text}</div>
                    <p><strong>–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:</strong> ${settings.ready_for_production ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</p>
                    <p><strong>–í–∞–ª–∏–¥–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:</strong> ${settings.valid_configuration ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</p>
                    <p><strong>–°–æ–∑–¥–∞–Ω–æ:</strong> ${settings.created_at}</p>
                    <p><strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong> ${settings.updated_at}</p>
                `;
                
                displayResult('settingsResult', statusHtml);
                document.getElementById('settingsResult').innerHTML = `<div class="result info">${statusHtml}</div>`;
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', result);
                displayResult('settingsResult', result, true);
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function saveSettings() {
            console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Google OAuth...');
            
            const settings = {
                enabled: document.getElementById('enabled').checked,
                client_id: document.getElementById('clientId').value,
                client_secret: document.getElementById('clientSecret').value,
                redirect_uri: document.getElementById('redirectUri').value,
                allow_registration: document.getElementById('allowRegistration').checked,
                auto_verify_email: document.getElementById('autoVerifyEmail').checked,
                scopes_list: document.getElementById('scopesList').value
            };
            
            console.log('üì§ –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', settings);
            
            const result = await apiRequest('/google_oauth_settings', {
                method: 'PATCH',
                body: JSON.stringify({ google_oauth_settings: settings })
            });
            
            if (result.success) {
                console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', result.data);
                displayResult('saveResult', '‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                setTimeout(loadSettings, 1000);
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', result);
                displayResult('saveResult', result, true);
            }
        }
        
        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function testConnection() {
            console.log('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
            
            const result = await apiRequest('/google_oauth_settings/test_connection', {
                method: 'POST'
            });
            
            if (result.success) {
                console.log('‚úÖ –¢–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω:', result.data);
                let testHtml = `<strong>‚úÖ ${result.data.message}</strong>`;
                
                if (result.data.authorization_url) {
                    testHtml += `
                        <br><br><strong>üîó URL –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:</strong><br>
                        <a href="${result.data.authorization_url}" target="_blank">${result.data.authorization_url}</a>
                    `;
                }
                
                document.getElementById('testResult').innerHTML = `<div class="result">${testHtml}</div>`;
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞:', result);
                displayResult('testResult', result, true);
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ URL –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function getAuthUrl() {
            console.log('üåê –ü–æ–ª—É—á–µ–Ω–∏–µ Authorization URL...');
            
            const result = await apiRequest('/google_oauth_settings/authorization_url');
            
            if (result.success) {
                console.log('‚úÖ URL –ø–æ–ª—É—á–µ–Ω:', result.data);
                
                const urlHtml = `
                    <strong>üîó Authorization URL:</strong><br>
                    <a href="${result.data.authorization_url}" target="_blank">${result.data.authorization_url}</a>
                    <br><br>
                    <strong>üîë State:</strong> ${result.data.state}
                `;
                
                document.getElementById('authUrlResult').innerHTML = `<div class="result info">${urlHtml}</div>`;
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è URL:', result);
                displayResult('authUrlResult', result, true);
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...');
            loadSettings();
        });
    </script>
</body>
</html> 