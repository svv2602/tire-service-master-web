<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ - –ü–æ–∏—Å–∫ —à–∏–Ω –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—é</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-title {
            color: #1976d2;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .api-response {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-success { border-left-color: #28a745; }
        .status-warning { border-left-color: #ffc107; }
        .status-error { border-left-color: #dc3545; }
        
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
        .log {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .model-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            min-width: 200px;
        }
        .model-card:hover {
            background: #f0f0f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .model-card h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        .diameter-group {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
            display: inline-block;
            min-width: 250px;
            vertical-align: top;
        }
        .diameter-group h3 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        .tire-size {
            background: #e3f2fd;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 4px;
            display: inline-block;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó –¢–µ—Å—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ - –ü–æ–∏—Å–∫ —à–∏–Ω –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—é</h1>
        <p><strong>–¶–µ–ª—å:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø–æ–∏—Å–∫–∞ "–º–µ—Ä—Å–µ–¥–µ—Å –∂–ª–µ" –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ</p>
        
        <!-- –¢–µ—Å—Ç 1: –ù–∞—á–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ -->
        <div class="test-section">
            <div class="test-title">1. –ù–∞—á–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ "–º–µ—Ä—Å–µ–¥–µ—Å –∂–ª–µ"</div>
            <button onclick="searchCarTires()">üîç –ü–æ–∏—Å–∫ —à–∏–Ω –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—é</button>
            <div id="search-log" class="log">–õ–æ–≥–∏ –ø–æ–∏—Å–∫–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</div>
            <div id="search-response" class="api-response">–û—Ç–≤–µ—Ç API –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</div>
        </div>

        <!-- –¢–µ—Å—Ç 2: –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ -->
        <div class="test-section">
            <div class="test-title">2. –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ GLE-Class</div>
            <div id="models-container">–ú–æ–¥–µ–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞...</div>
        </div>

        <!-- –¢–µ—Å—Ç 3: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–∑–º–µ—Ä–æ–≤ -->
        <div class="test-section">
            <div class="test-title">3. –†–∞–∑–º–µ—Ä—ã —à–∏–Ω –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∏–∞–º–µ—Ç—Ä–∞–º</div>
            <div id="sizes-container">–†–∞–∑–º–µ—Ä—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏...</div>
        </div>

        <!-- –¢–µ—Å—Ç 4: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="test-section">
            <div class="test-title">4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
            <div id="stats-container">
                <p><strong>–í—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> <span id="test-time">-</span></p>
                <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤:</strong> <span id="request-count">0</span></p>
                <p><strong>–£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:</strong> <span id="success-count">0</span></p>
                <p><strong>–û—à–∏–±–æ–∫:</strong> <span id="error-count">0</span></p>
            </div>
        </div>
    </div>

    <script>
        let requestCount = 0;
        let successCount = 0;
        let errorCount = 0;
        let currentSearchResult = null;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤
        function updateStats() {
            document.getElementById('request-count').textContent = requestCount;
            document.getElementById('success-count').textContent = successCount;
            document.getElementById('error-count').textContent = errorCount;
            document.getElementById('test-time').textContent = new Date().toLocaleString();
        }

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message, type = 'info') {
            const logElement = document.getElementById('search-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[CarSearch] ${message}`);
        }

        // –ù–∞—á–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
        async function searchCarTires() {
            requestCount++;
            updateStats();
            
            log('üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ "–º–µ—Ä—Å–µ–¥–µ—Å –∂–ª–µ"...');
            
            const searchData = {
                query: "–º–µ—Ä—Å–µ–¥–µ—Å –∂–ª–µ",
                locale: "ru"
            };

            try {
                const response = await fetch('http://localhost:8000/api/v1/car_tire_search/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(searchData)
                });

                const result = await response.json();
                currentSearchResult = result;
                
                log(`‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º: ${result.status}`);
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
                const responseElement = document.getElementById('search-response');
                responseElement.textContent = JSON.stringify(result, null, 2);
                responseElement.className = `api-response status-${result.status === 'model_ambiguous' ? 'warning' : 'success'}`;
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                if (result.status === 'model_ambiguous') {
                    log(`‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–æ ${result.models?.length || 0} –º–æ–¥–µ–ª–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞`);
                    displayModels(result.models || []);
                    successCount++;
                } else if (result.status === 'success') {
                    log(`üéâ –°—Ä–∞–∑—É –Ω–∞–π–¥–µ–Ω—ã —Ä–∞–∑–º–µ—Ä—ã —à–∏–Ω: ${result.tire_sizes?.length || 0}`);
                    displayTireSizes(result);
                    successCount++;
                } else {
                    log(`‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å: ${result.status}`);
                    errorCount++;
                }
                
            } catch (error) {
                errorCount++;
                log(`üö´ –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
                console.error('Search error:', error);
            }
            
            updateStats();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞
        function displayModels(models) {
            const container = document.getElementById('models-container');
            container.innerHTML = '';
            
            if (!models || models.length === 0) {
                container.innerHTML = '<p>–ú–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            log(`üìã –û—Ç–æ–±—Ä–∞–∂–∞–µ–º ${models.length} –º–æ–¥–µ–ª–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞`);
            
            models.forEach(model => {
                const modelCard = document.createElement('div');
                modelCard.className = 'model-card';
                modelCard.onclick = () => selectModel(model.id, model.name);
                
                modelCard.innerHTML = `
                    <h4>${model.name}</h4>
                    <p><strong>–ë—Ä–µ–Ω–¥:</strong> ${model.brand_name}</p>
                    <p><strong>–†–∞–∑–º–µ—Ä–æ–≤:</strong> ${model.configs_count}</p>
                    <p><strong>ID:</strong> ${model.id}</p>
                `;
                
                container.appendChild(modelCard);
            });
        }

        // –í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏
        async function selectModel(modelId, modelName) {
            requestCount++;
            updateStats();
            
            log(`üéØ –í—ã–±–∏—Ä–∞–µ–º –º–æ–¥–µ–ª—å: ${modelName} (ID: ${modelId})`);

            const resolveData = {
                model_id: modelId,
                locale: "ru"
            };

            try {
                const response = await fetch('http://localhost:8000/api/v1/car_tire_search/resolve_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(resolveData)
                });

                const result = await response.json();
                
                log(`‚úÖ –ü–æ–ª—É—á–µ–Ω—ã —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è ${modelName}: ${result.tire_sizes?.length || 0} —Ä–∞–∑–º–µ—Ä–æ–≤`);
                
                if (result.status === 'success') {
                    displayTireSizes(result);
                    successCount++;
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–æ–≤: ${result.message || result.status}`);
                    errorCount++;
                }
                
            } catch (error) {
                errorCount++;
                log(`üö´ –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏: ${error.message}`);
                console.error('Model selection error:', error);
            }
            
            updateStats();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ —à–∏–Ω —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ –¥–∏–∞–º–µ—Ç—Ä–∞–º
        function displayTireSizes(result) {
            const container = document.getElementById('sizes-container');
            container.innerHTML = '';
            
            if (!result.tire_sizes || result.tire_sizes.length === 0) {
                container.innerHTML = '<p>–†–∞–∑–º–µ—Ä—ã —à–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            log(`üìè –ì—Ä—É–ø–ø–∏—Ä—É–µ–º ${result.tire_sizes.length} —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–æ –¥–∏–∞–º–µ—Ç—Ä–∞–º`);
            
            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∏–∞–º–µ—Ç—Ä–∞–º
            const diameterGroups = {};
            result.tire_sizes.forEach(size => {
                if (!diameterGroups[size.diameter]) {
                    diameterGroups[size.diameter] = [];
                }
                diameterGroups[size.diameter].push(size);
            });
            
            log(`üìä –ù–∞–π–¥–µ–Ω–æ ${Object.keys(diameterGroups).length} –¥–∏–∞–º–µ—Ç—Ä–æ–≤`);
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä—É–ø–ø
            Object.keys(diameterGroups).sort((a, b) => parseInt(a) - parseInt(b)).forEach(diameter => {
                const sizes = diameterGroups[diameter];
                
                const diameterGroup = document.createElement('div');
                diameterGroup.className = 'diameter-group';
                
                diameterGroup.innerHTML = `
                    <h3>–î–∏–∞–º–µ—Ç—Ä R${diameter} ‚Ä¢ ${result.brand?.name} ${result.model?.name}</h3>
                    <p><strong>${sizes.length} —Ä–∞–∑–º–µ—Ä${sizes.length > 1 ? '–∞' : ''} –≤ –Ω–∞–ª–∏—á–∏–∏</strong></p>
                    <div>
                        ${sizes.map(size => 
                            `<span class="tire-size">${size.width}/${size.height}R${size.diameter}</span>`
                        ).join('')}
                    </div>
                    <p><small>–ì–æ–¥—ã: ${sizes[0].year_from}-${sizes[0].year_to || '–Ω.–≤.'}</small></p>
                `;
                
                container.appendChild(diameterGroup);
            });
            
            log(`üéâ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!`);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            log('‚ÑπÔ∏è  –ù–∞–∂–º–∏—Ç–µ "–ü–æ–∏—Å–∫ —à–∏–Ω –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—é" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            updateStats();
        });
    </script>
</body>
</html>