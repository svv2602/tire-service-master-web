<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫—ç—à–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 400px;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input {
            width: 150px;
            padding: 5px;
            margin: 5px;
        }
        .exception-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .exception-details {
            flex: 1;
        }
        .exception-actions {
            display: flex;
            gap: 10px;
        }
        .active { border-left: 4px solid #28a745; }
        .inactive { border-left: 4px solid #dc3545; opacity: 0.7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫—ç—à–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏</h1>
        
        <div class="test-section info">
            <h3>üìã –ü—Ä–æ–±–ª–µ–º–∞</h3>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ –µ—â–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π</p>
            <p><strong>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong></p>
            <ul>
                <li>Frontend –∫—ç—à –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è</li>
                <li>RTK Query —Ç–µ–≥–∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</li>
                <li>Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏</li>
                <li>–í–∞–ª–∏–¥–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            
            <div class="form-group">
                <label>–î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å ID:</label>
                <input type="number" id="agreement_id" value="2" min="1">
                <button onclick="loadExceptions()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è</button>
                <button onclick="clearResults()" class="danger">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
            </div>
        </div>

        <div id="exceptions-list"></div>
        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let currentExceptions = [];

        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function renderExceptionsList(exceptions) {
            const container = document.getElementById('exceptions-list');
            container.innerHTML = '';
            
            if (exceptions.length === 0) {
                container.innerHTML = '<div class="test-section info"><h3>üìã –ù–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π</h3><p>–í —ç—Ç–æ–π –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π</p></div>';
                return;
            }

            const div = document.createElement('div');
            div.className = 'test-section';
            div.innerHTML = `<h3>üìã –¢–µ–∫—É—â–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è (${exceptions.length})</h3>`;
            
            exceptions.forEach(exception => {
                const brandText = exception.tire_brand_id ? `–ë—Ä–µ–Ω–¥ ID: ${exception.tire_brand_id}` : '–í—Å–µ –±—Ä–µ–Ω–¥—ã';
                const diameterText = exception.tire_diameter ? `R${exception.tire_diameter}` : '–í—Å–µ –¥–∏–∞–º–µ—Ç—Ä—ã';
                const typeText = exception.exception_type === 'fixed_amount' ? '–§–∏–∫—Å.' : '–ü—Ä–æ—Ü.';
                const valueText = exception.exception_type === 'fixed_amount' 
                    ? `${exception.exception_amount} –≥—Ä–Ω` 
                    : `${exception.exception_percentage}%`;
                const statusClass = exception.active ? 'active' : 'inactive';
                const statusText = exception.active ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–æ' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω–æ';
                
                const exceptionDiv = document.createElement('div');
                exceptionDiv.className = `exception-item ${statusClass}`;
                exceptionDiv.innerHTML = `
                    <div class="exception-details">
                        <strong>#${exception.id}:</strong> ${brandText} + ${diameterText} | ${typeText} ${valueText} | ${statusText}
                        <br><small>–°–æ–∑–¥–∞–Ω–æ: ${new Date(exception.created_at).toLocaleString()}</small>
                    </div>
                    <div class="exception-actions">
                        <button onclick="toggleExceptionActive(${exception.id}, ${!exception.active})" 
                                style="background-color: ${exception.active ? '#ffc107' : '#28a745'}">
                            ${exception.active ? '‚è∏Ô∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '‚ñ∂Ô∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                        </button>
                        <button onclick="deleteException(${exception.id})" class="danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        <button onclick="checkConflictsForException(${exception.id})" style="background-color: #6f42c1">
                            üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
                        </button>
                    </div>
                `;
                div.appendChild(exceptionDiv);
            });
            
            container.appendChild(div);
        }

        async function loadExceptions() {
            const agreementId = document.getElementById('agreement_id').value;
            
            try {
                addResult('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π', `–ó–∞–ø—Ä–æ—Å: GET /api/v1/agreements/${agreementId}/exceptions`, 'info');
                
                const response = await fetch(`${API_BASE}/agreements/${agreementId}/exceptions`, {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentExceptions = result.data;
                    
                    const summary = {
                        total: currentExceptions.length,
                        active: currentExceptions.filter(e => e.active).length,
                        inactive: currentExceptions.filter(e => !e.active).length,
                        details: currentExceptions.map(e => ({
                            id: e.id,
                            active: e.active,
                            tire_brand_id: e.tire_brand_id,
                            tire_diameter: e.tire_diameter,
                            created_at: e.created_at
                        }))
                    };
                    
                    addResult('‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã', JSON.stringify(summary, null, 2), 'success');
                    renderExceptionsList(currentExceptions);
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', JSON.stringify(result, null, 2), 'error');
                }
            } catch (error) {
                addResult('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', error.message, 'error');
            }
        }

        async function deleteException(exceptionId) {
            const agreementId = document.getElementById('agreement_id').value;
            
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ #${exceptionId}?`)) {
                return;
            }
            
            try {
                addResult('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è', `–£–¥–∞–ª—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ #${exceptionId}`, 'info');
                
                const response = await fetch(`${API_BASE}/agreements/${agreementId}/exceptions/${exceptionId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', result.message, 'success');
                    
                    // –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    setTimeout(() => {
                        addResult('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è', '–ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –ª–∏ –¥–∞–Ω–Ω—ã–µ...', 'info');
                        loadExceptions();
                    }, 1000);
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', JSON.stringify(result, null, 2), 'error');
                }
            } catch (error) {
                addResult('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', error.message, 'error');
            }
        }

        async function toggleExceptionActive(exceptionId, newActiveState) {
            const agreementId = document.getElementById('agreement_id').value;
            
            try {
                addResult('üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞', `–ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è #${exceptionId} –Ω–∞ ${newActiveState ? '–∞–∫—Ç–∏–≤–Ω–æ' : '–Ω–µ–∞–∫—Ç–∏–≤–Ω–æ'}`, 'info');
                
                const response = await fetch(`${API_BASE}/agreements/${agreementId}/exceptions/${exceptionId}`, {
                    method: 'PATCH',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        exception: {
                            active: newActiveState
                        }
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω', JSON.stringify(result.data, null, 2), 'success');
                    loadExceptions(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', JSON.stringify(result, null, 2), 'error');
                }
            } catch (error) {
                addResult('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', error.message, 'error');
            }
        }

        function checkConflictsForException(exceptionId) {
            const exception = currentExceptions.find(e => e.id === exceptionId);
            if (!exception) {
                addResult('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', `–ò—Å–∫–ª—é—á–µ–Ω–∏–µ #${exceptionId} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Å–ø–∏—Å–∫–µ`, 'error');
                return;
            }
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
            const conflicts = currentExceptions.filter(other => {
                if (other.id === exceptionId) return false; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∞–º–æ —Å–µ–±—è
                if (!other.active) return false; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ
                
                // –õ–æ–≥–∏–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
                const brandConflict = (exception.tire_brand_id === other.tire_brand_id) ||
                                    (exception.tire_brand_id === null || other.tire_brand_id === null);
                
                const diameterConflict = (exception.tire_diameter === other.tire_diameter) ||
                                       (exception.tire_diameter === null || other.tire_diameter === null);
                
                return brandConflict && diameterConflict;
            });
            
            const conflictInfo = {
                exceptionId,
                exceptionDetails: {
                    tire_brand_id: exception.tire_brand_id,
                    tire_diameter: exception.tire_diameter,
                    active: exception.active
                },
                conflictsFound: conflicts.length,
                conflicts: conflicts.map(c => ({
                    id: c.id,
                    tire_brand_id: c.tire_brand_id,
                    tire_diameter: c.tire_diameter,
                    active: c.active
                }))
            };
            
            const resultType = conflicts.length > 0 ? 'warning' : 'success';
            const title = conflicts.length > 0 
                ? `‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è #${exceptionId}` 
                : `‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è #${exceptionId} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`;
            
            addResult(title, JSON.stringify(conflictInfo, null, 2), resultType);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            setTimeout(loadExceptions, 500);
        });
    </script>
</body>
</html>