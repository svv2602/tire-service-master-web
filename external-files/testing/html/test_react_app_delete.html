<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω–∏—è –≤ React App</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid; }
        .success { background: #d4f6d4; border-color: #28a745; color: #155724; }
        .error { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .info { background: #d1ecf1; border-color: #17a2b8; color: #0c5460; }
        .warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
        button { padding: 12px 24px; margin: 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 12px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; }
        .counter { font-size: 18px; font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <h1>üß™ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç React App - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏</h1>
    
    <div class="test-section">
        <h3>üéØ –¶–µ–ª—å —Ç–µ—Å—Ç–∞</h3>
        <p>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è RTK Query deleteService —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.</p>
        <p>–ú—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–µ–º:</p>
        <ul>
            <li>‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ localStorage</li>
            <li>‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—Å–ª—É–≥</li>
            <li>‚úÖ –°–∏–º—É–ª—è—Ü–∏—é RTK Query deleteService –º—É—Ç–∞—Ü–∏–∏</li>
            <li>‚úÖ –ü—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è URL</li>
            <li>‚úÖ –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API</li>
        </ul>
    </div>

    <div id="status" class="status info">
        üîÑ –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...
    </div>

    <div class="test-section">
        <h3>üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞–º–∏</h3>
        <button onclick="runReactSimulation()" class="btn-primary">üß™ –°–∏–º—É–ª—è—Ü–∏—è React App</button>
        <button onclick="testRTKQueryLogic()" class="btn-success">‚öôÔ∏è –¢–µ—Å—Ç RTK Query –ª–æ–≥–∏–∫–∏</button>
        <button onclick="checkCurrentCount()" class="btn-warning">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥</button>
        <button onclick="clearResults()" class="btn-danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
    </div>

    <div class="test-section">
        <h3>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <p>–£—Å–ª—É–≥ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ 3: <span id="servicesCount" class="counter">-</span></p>
        <p>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å: <span id="lastStatus">–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span></p>
    </div>

    <div class="test-section">
        <h3>üìù –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏</h3>
        <pre id="logs"></pre>
    </div>

    <script>
        let logs = [];
        let authToken = null;
        let currentServicesCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–∏
            document.getElementById('logs').textContent = logs.join('\n');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<strong>${message}</strong>`;
            statusDiv.className = `status ${type}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å
            document.getElementById('lastStatus').textContent = message;
            
            console.log(logEntry);
        }
        
        function clearResults() {
            logs = [];
            document.getElementById('logs').textContent = '';
            document.getElementById('servicesCount').textContent = '-';
            document.getElementById('lastStatus').textContent = '–û—á–∏—â–µ–Ω–æ';
            log('üßπ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã', 'info');
        }
        
        async function authenticate() {
            log('üîê –í—ã–ø–æ–ª–Ω—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...', 'info');
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        auth: {
                            login: 'admin@test.com',
                            password: 'admin123'
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                authToken = data.tokens.access;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∫–∞–∫ –≤ React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
                localStorage.setItem('tvoya_shina_token', authToken);
                localStorage.setItem('auth_token', authToken);
                localStorage.setItem('token', authToken);
                
                log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. –¢–æ–∫–µ–Ω: ${authToken.substring(0, 30)}...`, 'success');
                return authToken;
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                throw error;
            }
        }
        
        async function checkCurrentCount() {
            try {
                if (!authToken) {
                    await authenticate();
                }
                
                log('üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥...', 'info');
                
                const response = await fetch('http://localhost:8000/api/v1/service_categories/3/services', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                currentServicesCount = data.data.length;
                
                document.getElementById('servicesCount').textContent = currentServicesCount;
                log(`üìà –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥: ${currentServicesCount}`, 'success');
                
                return data.data;
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å–ª—É–≥: ${error.message}`, 'error');
                throw error;
            }
        }
        
        async function testRTKQueryLogic() {
            try {
                log('‚öôÔ∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É RTK Query deleteService...', 'info');
                
                const services = await checkCurrentCount();
                
                if (services.length === 0) {
                    log('‚ö†Ô∏è –ù–µ—Ç —É—Å–ª—É–≥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'warning');
                    return;
                }
                
                const serviceToDelete = services[0];
                log(`üéØ –í—ã–±—Ä–∞–Ω–∞ —É—Å–ª—É–≥–∞: "${serviceToDelete.name}" (ID: ${serviceToDelete.id})`, 'info');
                
                // –°–∏–º—É–ª–∏—Ä—É–µ–º —Ç–æ—á–Ω—É—é –ª–æ–≥–∏–∫—É –∏–∑ ServicesList.tsx
                const categoryId = '3';
                const serviceId = String(serviceToDelete.id);
                
                log(`üîç –ò—Å—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: categoryId="${categoryId}", serviceId="${serviceId}"`, 'info');
                log(`üîç –¢–∏–ø—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: categoryId=${typeof categoryId}, serviceId=${typeof serviceId}`, 'info');
                
                // –°–∏–º—É–ª–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –∏–∑ servicesList.api.ts
                const catId = String(categoryId);
                const servId = String(serviceId);
                
                log(`üîÑ –ü–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: catId="${catId}", servId="${servId}"`, 'info');
                log(`üîç –¢–∏–ø—ã –ø–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: catId=${typeof catId}, servId=${typeof servId}`, 'info');
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –∫–∞–∫ –≤ RTK Query
                const url = `service_categories/${catId}/services/${servId}`;
                log(`üîó –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π URL: ${url}`, 'info');
                
                // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ [object Object]
                if (url.includes('[object') || url.includes('undefined') || url.includes('null')) {
                    log(`‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL! ${url}`, 'error');
                    throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: ${url}`);
                }
                
                log('‚úÖ URL –ø—Ä–æ—à–µ–ª –≤–∞–ª–∏–¥–∞—Ü–∏—é - –Ω–µ—Ç [object Object]', 'success');
                
                // –°–æ–∑–¥–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–∞–∫ –≤ React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
                const deleteArgs = {
                    categoryId: catId,
                    id: servId,
                };
                
                log(`üì¶ –ê—Ä–≥—É–º–µ–Ω—Ç—ã deleteService: ${JSON.stringify(deleteArgs)}`, 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
                if (!deleteArgs.categoryId || !deleteArgs.id) {
                    throw new Error('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã categoryId –∏–ª–∏ id');
                }
                
                if (deleteArgs.categoryId.includes('[object') || deleteArgs.id.includes('[object')) {
                    throw new Error('–ê—Ä–≥—É–º–µ–Ω—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç [object Object]');
                }
                
                log('‚úÖ –ê—Ä–≥—É–º–µ–Ω—Ç—ã –ø—Ä–æ—à–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é', 'success');
                log('üéâ RTK Query –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!', 'success');
                
                return { url, deleteArgs, serviceToDelete };
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤ RTK Query –ª–æ–≥–∏–∫–µ: ${error.message}`, 'error');
                throw error;
            }
        }
        
        async function runReactSimulation() {
            try {
                log('üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω—É—é —Å–∏–º—É–ª—è—Ü–∏—é React App...', 'info');
                
                // 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                await authenticate();
                
                // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ RTK Query –ª–æ–≥–∏–∫–∏
                const { url, deleteArgs, serviceToDelete } = await testRTKQueryLogic();
                
                // 3. –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
                log('üóëÔ∏è –í—ã–ø–æ–ª–Ω—è–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ...', 'info');
                
                const fullUrl = `http://localhost:8000/api/v1/${url}`;
                log(`üåê –ü–æ–ª–Ω—ã–π URL –∑–∞–ø—Ä–æ—Å–∞: ${fullUrl}`, 'info');
                
                const deleteResponse = await fetch(fullUrl, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${deleteResponse.status} ${deleteResponse.statusText}`, 'info');

                if (!deleteResponse.ok) {
                    const errorText = await deleteResponse.text();
                    throw new Error(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${deleteResponse.status} - ${errorText}`);
                }
                
                log('‚úÖ –£—Å–ª—É–≥–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!', 'success');
                
                // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è...', 'info');
                const newServices = await checkCurrentCount();
                
                const stillExists = newServices.find(s => s.id === serviceToDelete.id);
                if (stillExists) {
                    log('‚ùå –û–®–ò–ë–ö–ê: –£—Å–ª—É–≥–∞ –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', 'error');
                } else {
                    log(`‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û: –£—Å–ª—É–≥–∞ "${serviceToDelete.name}" —É–¥–∞–ª–µ–Ω–∞!`, 'success');
                    log(`üìä –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥: ${newServices.length}`, 'success');
                }
                
                log('üéâ –°–ò–ú–£–õ–Ø–¶–ò–Ø REACT APP –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!', 'success');
                
            } catch (error) {
                log(`‚ùå –û–®–ò–ë–ö–ê –°–ò–ú–£–õ–Ø–¶–ò–ò: ${error.message}`, 'error');
                console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error);
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = async function() {
            log('üîß –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω
            const existingToken = localStorage.getItem('tvoya_shina_token') || 
                                localStorage.getItem('auth_token') || 
                                localStorage.getItem('token');
            
            if (existingToken) {
                authToken = existingToken;
                log(`‚ÑπÔ∏è –ù–∞–π–¥–µ–Ω —Ç–æ–∫–µ–Ω –≤ localStorage: ${existingToken.substring(0, 30)}...`, 'info');
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥
            try {
                await checkCurrentCount();
            } catch (error) {
                log('‚ÑπÔ∏è –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª—É–≥ –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'info');
            }
        };
    </script>
</body>
</html>
