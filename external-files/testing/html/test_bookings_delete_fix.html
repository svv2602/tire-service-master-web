<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .success { color: #4CAF50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .info { color: #2196F3; font-weight: bold; }
        .warning { color: #FF9800; font-weight: bold; }
        button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #1976D2; }
        button.danger { background-color: #f44336; }
        button.danger:hover { background-color: #d32f2f; }
        .log {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .booking-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: white;
        }
        .booking-actions {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h1>
        <p class="info">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /admin/bookings</p>

        <div class="test-section">
            <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API</h2>
            <button onclick="testHealthCheck()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ API</button>
            <button onclick="testAuth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
            <div id="health-log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>2. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h2>
            <button onclick="loadBookings()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
            <div id="bookings-log" class="log"></div>
            <div id="bookings-list"></div>
        </div>

        <div class="test-section">
            <h2>3. –¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <p class="warning">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö!</p>
            <input type="number" id="booking-id-input" placeholder="ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è" min="1">
            <button class="danger" onclick="testDeleteBooking()">–£–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <div id="delete-log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>4. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <div id="results-log" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let authToken = null;
        let currentBookings = [];

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è API
        async function testHealthCheck() {
            try {
                log('health-log', 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API...', 'info');
                
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    log('health-log', `‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω: ${JSON.stringify(data)}`, 'success');
                    return true;
                } else {
                    log('health-log', `‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                log('health-log', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API: ${error.message}`, 'error');
                return false;
            }
        }

        // –¢–µ—Å—Ç–æ–≤–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        async function testAuth() {
            try {
                log('health-log', 'üîê –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...', 'info');
                
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'admin@test.com',
                        password: 'admin123'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.token) {
                    authToken = data.token;
                    log('health-log', `‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. Token –ø–æ–ª—É—á–µ–Ω.`, 'success');
                    return true;
                } else {
                    log('health-log', `‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${JSON.stringify(data)}`, 'error');
                    return false;
                }
            } catch (error) {
                log('health-log', `‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                return false;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
        async function loadBookings() {
            try {
                log('bookings-log', 'üìã –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π...', 'info');
                
                if (!authToken) {
                    log('bookings-log', '‚ö†Ô∏è –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –í—ã–ø–æ–ª–Ω—è—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...', 'warning');
                    const authSuccess = await testAuth();
                    if (!authSuccess) {
                        log('bookings-log', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è', 'error');
                        return;
                    }
                }

                const response = await fetch(`${API_BASE}/bookings?page=1&per_page=10`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentBookings = data.data || [];
                    log('bookings-log', `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${currentBookings.length} –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π`, 'success');
                    displayBookings(currentBookings);
                } else {
                    log('bookings-log', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status} - ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log('bookings-log', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: ${error.message}`, 'error');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
        function displayBookings(bookings) {
            const container = document.getElementById('bookings-list');
            if (bookings.length === 0) {
                container.innerHTML = '<p class="info">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            container.innerHTML = bookings.map(booking => `
                <div class="booking-card">
                    <strong>ID: ${booking.id}</strong><br>
                    –ö–ª–∏–µ–Ω—Ç: ${booking.client?.user?.first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} ${booking.client?.user?.last_name || ''}<br>
                    –¢–æ—á–∫–∞: ${booking.service_point?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>
                    –î–∞—Ç–∞: ${booking.booking_date}<br>
                    –°—Ç–∞—Ç—É—Å: ${booking.status?.name || booking.status_id}<br>
                    <div class="booking-actions">
                        <button class="danger" onclick="deleteBookingById(${booking.id})">–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
                    </div>
                </div>
            `).join('');
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ ID
        async function deleteBookingById(bookingId) {
            if (!confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ #${bookingId}?`)) {
                return;
            }

            try {
                log('delete-log', `üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è #${bookingId}...`, 'info');
                
                if (!authToken) {
                    log('delete-log', '‚ö†Ô∏è –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –í—ã–ø–æ–ª–Ω—è—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...', 'warning');
                    const authSuccess = await testAuth();
                    if (!authSuccess) {
                        log('delete-log', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è', 'error');
                        return;
                    }
                }

                const response = await fetch(`${API_BASE}/bookings/${bookingId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log('delete-log', `‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ #${bookingId} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ: ${JSON.stringify(data)}`, 'success');
                    log('results-log', `‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù: –£–¥–∞–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ`, 'success');
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                    await loadBookings();
                } else {
                    const errorData = await response.json();
                    log('delete-log', `‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${response.status} - ${JSON.stringify(errorData)}`, 'error');
                    log('results-log', `‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù: –û—à–∏–±–∫–∞ ${response.status}`, 'error');
                }
            } catch (error) {
                log('delete-log', `‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`, 'error');
                log('results-log', `‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ - ${error.message}`, 'error');
            }
        }

        // –¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ input
        async function testDeleteBooking() {
            const bookingId = document.getElementById('booking-id-input').value;
            if (!bookingId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            await deleteBookingById(parseInt(bookingId));
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', async () => {
            log('results-log', 'üöÄ –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π', 'info');
            
            const healthOk = await testHealthCheck();
            if (healthOk) {
                const authOk = await testAuth();
                if (authOk) {
                    await loadBookings();
                }
            }
        });
    </script>
</body>
</html> 