<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç: –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–æ–ª—å—é</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f5f5; 
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .success { 
            background-color: #d4edda; 
            border-color: #c3e6cb; 
            color: #155724; 
        }
        .error { 
            background-color: #f8d7da; 
            border-color: #f5c6cb; 
            color: #721c24; 
        }
        .info { 
            background-color: #d1ecf1; 
            border-color: #bee5eb; 
            color: #0c5460; 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto; 
            white-space: pre-wrap; 
        }
        .role-mapping { 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç: –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–æ–ª—å—é</h1>
        
        <div class="test-section info">
            <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–µ</h3>
            <p><strong>–¶–µ–ª—å:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ä–æ–ª—å 'partner' (ID=4)</p>
            <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> –†–∞–Ω–µ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–ª —Ä–æ–ª—å 'operator' (ID=3) –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞ –≤ roles.utils.ts</p>
            <p><strong>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> –û–±–Ω–æ–≤–ª–µ–Ω –º–∞–ø–ø–∏–Ω–≥ —Ä–æ–ª–µ–π –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö</p>
        </div>

        <div class="role-mapping">
            <h4>üîÑ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ —Ä–æ–ª–µ–π:</h4>
            <ul>
                <li>admin: ID=1</li>
                <li>manager: ID=2</li>
                <li>operator: ID=3</li>
                <li><strong>partner: ID=4</strong></li>
                <li>client: ID=5</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API</h3>
            <button onclick="testCreatePartner()">1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞</button>
            <button onclick="testRoleMapping()">2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ —Ä–æ–ª–µ–π</button>
            <button onclick="checkAllRoles()">3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ä–æ–ª–∏ –≤ –ë–î</button>
            <div id="api-results"></div>
        </div>

        <div class="test-section">
            <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <div id="test-results"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            resultsDiv.innerHTML += `<div class="test-section ${className}">
                <strong>[${timestamp}]</strong> ${message}
            </div>`;
        }

        function displayApiResult(title, data, isError = false) {
            const resultsDiv = document.getElementById('api-results');
            const className = isError ? 'error' : 'success';
            resultsDiv.innerHTML += `<div class="test-section ${className}">
                <h4>${title}</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>`;
        }

        async function testCreatePartner() {
            try {
                log('üöÄ –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞...');
                
                const partnerData = {
                    partner: {
                        company_name: `–¢–µ—Å—Ç –ö–æ–º–ø–∞–Ω–∏—è ${Date.now()}`,
                        company_description: '–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π',
                        contact_person: '–¢–µ—Å—Ç –ö–æ–Ω—Ç–∞–∫—Ç',
                        legal_address: '—É–ª. –¢–µ—Å—Ç–æ–≤–∞—è, 123',
                        user_attributes: {
                            email: `test_partner_${Date.now()}@example.com`,
                            password: 'password123',
                            first_name: '–¢–µ—Å—Ç',
                            last_name: '–ü–∞—Ä—Ç–Ω–µ—Ä',
                            phone: '+380671234567'
                        }
                    }
                };

                const response = await fetch(`${API_BASE}/partners`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(partnerData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    displayApiResult('‚úÖ –ü–∞—Ä—Ç–Ω–µ—Ä —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', result);
                    log(`‚úÖ –ü–∞—Ä—Ç–Ω–µ—Ä —Å–æ–∑–¥–∞–Ω: ID=${result.id}, User ID=${result.user_id}`, 'success');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await checkUserRole(result.user_id);
                } else {
                    displayApiResult('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞', result, true);
                    log(`‚ùå –û—à–∏–±–∫–∞: ${result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
                displayApiResult('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', { error: error.message }, true);
            }
        }

        async function checkUserRole(userId) {
            try {
                log(`üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID=${userId}...`);
                
                const response = await fetch(`${API_BASE}/users/${userId}`);
                const user = await response.json();
                
                if (response.ok) {
                    const expectedRoleId = 4; // partner
                    const actualRoleId = user.role_id;
                    
                    if (actualRoleId === expectedRoleId) {
                        log(`‚úÖ –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞: role_id=${actualRoleId} (partner)`, 'success');
                        displayApiResult('‚úÖ –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞', {
                            user_id: userId,
                            role_id: actualRoleId,
                            expected: expectedRoleId,
                            status: 'CORRECT'
                        });
                    } else {
                        log(`‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–æ–ª—å: –æ–∂–∏–¥–∞–ª–æ—Å—å ${expectedRoleId}, –ø–æ–ª—É—á–µ–Ω–æ ${actualRoleId}`, 'error');
                        displayApiResult('‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', {
                            user_id: userId,
                            role_id: actualRoleId,
                            expected: expectedRoleId,
                            status: 'INCORRECT'
                        }, true);
                    }
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${user.message}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏: ${error.message}`, 'error');
            }
        }

        async function testRoleMapping() {
            log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–∞–ø–ø–∏–Ω–≥ —Ä–æ–ª–µ–π...');
            
            // –°–∏–º—É–ª—è—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ roles.utils.ts
            const getRoleId = (role) => {
                switch (role) {
                    case 'admin': return 1;
                    case 'manager': return 2;
                    case 'operator': return 3;
                    case 'partner': return 4;
                    case 'client': return 5;
                    default: return 5;
                }
            };

            const getRoleFromId = (roleId) => {
                switch (roleId) {
                    case 1: return 'ADMIN';
                    case 2: return 'MANAGER';
                    case 3: return 'OPERATOR';
                    case 4: return 'PARTNER';
                    case 5: return 'CLIENT';
                    default: return 'CLIENT';
                }
            };

            const testCases = [
                { role: 'partner', expectedId: 4 },
                { role: 'operator', expectedId: 3 },
                { role: 'admin', expectedId: 1 },
                { role: 'manager', expectedId: 2 },
                { role: 'client', expectedId: 5 }
            ];

            let allCorrect = true;
            const results = [];

            testCases.forEach(({ role, expectedId }) => {
                const actualId = getRoleId(role);
                const roleFromId = getRoleFromId(actualId);
                const isCorrect = actualId === expectedId;
                
                results.push({
                    role,
                    expected_id: expectedId,
                    actual_id: actualId,
                    role_from_id: roleFromId,
                    correct: isCorrect
                });

                if (!isCorrect) {
                    allCorrect = false;
                    log(`‚ùå –ú–∞–ø–ø–∏–Ω–≥ —Ä–æ–ª–∏ '${role}': –æ–∂–∏–¥–∞–ª–æ—Å—å ${expectedId}, –ø–æ–ª—É—á–µ–Ω–æ ${actualId}`, 'error');
                } else {
                    log(`‚úÖ –ú–∞–ø–ø–∏–Ω–≥ —Ä–æ–ª–∏ '${role}': ${actualId} ‚úì`, 'success');
                }
            });

            displayApiResult(
                allCorrect ? '‚úÖ –í—Å–µ –º–∞–ø–ø–∏–Ω–≥–∏ —Ä–æ–ª–µ–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã' : '‚ùå –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ –º–∞–ø–ø–∏–Ω–≥–µ —Ä–æ–ª–µ–π',
                results,
                !allCorrect
            );
        }

        async function checkAllRoles() {
            try {
                log('üîç –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ä–æ–ª–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');
                
                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
                const authResponse = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'admin@test.com',
                        password: 'admin123'
                    })
                });

                if (!authResponse.ok) {
                    log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–µ–π', 'error');
                    return;
                }

                const authData = await authResponse.json();
                
                // –ü–æ–ª—É—á–∞–µ–º —Ä–æ–ª–∏ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ –µ—Å—Ç—å —Ç–∞–∫–æ–π endpoint)
                const rolesResponse = await fetch(`${API_BASE}/user_roles`, {
                    headers: {
                        'Authorization': `Bearer ${authData.tokens?.access}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (rolesResponse.ok) {
                    const roles = await rolesResponse.json();
                    displayApiResult('üìã –†–æ–ª–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö', roles);
                    log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${roles.length} —Ä–æ–ª–µ–π –∏–∑ –ë–î`, 'success');
                } else {
                    log('‚ÑπÔ∏è Endpoint /user_roles –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ä–æ–ª–∏');
                    displayApiResult('üìã –ò–∑–≤–µ—Å—Ç–Ω—ã–µ —Ä–æ–ª–∏ (–∏–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)', [
                        { id: 1, name: 'admin' },
                        { id: 2, name: 'manager' },
                        { id: 3, name: 'operator' },
                        { id: 4, name: 'partner' },
                        { id: 5, name: 'client' }
                    ]);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–µ–π: ${error.message}`, 'error');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            log('üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –Ω–∞—á–∞—Ç–æ');
            testRoleMapping();
        };
    </script>
</body>
</html> 