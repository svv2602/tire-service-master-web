<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–æ—Å—Ç–µ–≤—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –∞–¥–º–∏–Ω–∫–µ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #1976d2;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .api-test {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #28a745;
            margin: 10px 0;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1565c0; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .booking-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }
        .booking-field {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .field-label {
            font-weight: bold;
            color: #495057;
        }
        .field-value {
            color: #212529;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üéØ –¢–µ—Å—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–æ—Å—Ç–µ–≤—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –∞–¥–º–∏–Ω–∫–µ</h1>
    
    <div class="test-section">
        <h2 class="test-title">1. –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div class="api-test">
            <p><strong>–¶–µ–ª—å:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            <button onclick="testGetGuestBooking()">–ü–æ–ª—É—á–∏—Ç—å –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <div id="getBookingResult"></div>
        </div>
    </div>

    <div class="test-section">
        <h2 class="test-title">2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div class="api-test">
            <p><strong>–¶–µ–ª—å:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è —É—Å–ª—É–≥–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</p>
            <button onclick="testUpdateGuestBooking()">–û–±–Ω–æ–≤–∏—Ç—å –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <div id="updateBookingResult"></div>
        </div>
    </div>

    <div class="test-section">
        <h2 class="test-title">3. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É</h2>
        <div class="api-test">
            <p><strong>–¶–µ–ª—å:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å client_id = null</p>
            <button onclick="testCreateGuestBooking()">–°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <div id="createBookingResult"></div>
        </div>
    </div>

    <div class="test-section">
        <h2 class="test-title">4. –¢–µ—Å—Ç UI –∞–¥–º–∏–Ω—Å–∫–æ–π —Ñ–æ—Ä–º—ã</h2>
        <div class="api-test">
            <p><strong>–¶–µ–ª—å:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–µ–π –¥–ª—è –≥–æ—Å—Ç–µ–≤—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –∞–¥–º–∏–Ω–∫–µ</p>
            <button onclick="testAdminUI()">–û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω—Å–∫—É—é —Ñ–æ—Ä–º—É</button>
            <div id="adminUIResult"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let guestBookingId = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                const data = await response.json();
                return { status: response.status, data, ok: response.ok };
            } catch (error) {
                return { status: 0, data: { error: error.message }, ok: false };
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayResult(elementId, result, title) {
            const element = document.getElementById(elementId);
            const statusClass = result.ok ? 'success' : 'error';
            
            element.innerHTML = `
                <div class="test-result ${statusClass}">
                    <h4>${title}</h4>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${result.status}</p>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                </div>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function displayBookingData(booking) {
            const isGuest = booking.is_guest_booking || !booking.client_id;
            
            return `
                <div class="booking-data">
                    <div class="booking-field">
                        <div class="field-label">–¢–∏–ø –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</div>
                        <div class="field-value">${isGuest ? 'üé≠ –ì–æ—Å—Ç–µ–≤–æ–µ' : 'üë§ –ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ'}</div>
                    </div>
                    <div class="booking-field">
                        <div class="field-label">Client ID:</div>
                        <div class="field-value">${booking.client_id || 'null'}</div>
                    </div>
                    <div class="booking-field">
                        <div class="field-label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å —É—Å–ª—É–≥–∏:</div>
                        <div class="field-value">${booking.service_recipient?.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                    </div>
                    <div class="booking-field">
                        <div class="field-label">–¢–µ–ª–µ—Ñ–æ–Ω:</div>
                        <div class="field-value">${booking.service_recipient?.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                    </div>
                    <div class="booking-field">
                        <div class="field-label">Email:</div>
                        <div class="field-value">${booking.service_recipient?.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                    </div>
                    <div class="booking-field">
                        <div class="field-label">–ê–≤—Ç–æ–º–æ–±–∏–ª—å:</div>
                        <div class="field-value">${booking.car_brand || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'} ${booking.car_model || ''}</div>
                    </div>
                    <div class="booking-field">
                        <div class="field-label">–ù–æ–º–µ—Ä –∞–≤—Ç–æ:</div>
                        <div class="field-value">${booking.license_plate || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                    </div>
                    <div class="booking-field">
                        <div class="field-label">–î–∞—Ç–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</div>
                        <div class="field-value">${booking.booking_date} ${booking.start_time}</div>
                    </div>
                </div>
            `;
        }

        // –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        async function testGetGuestBooking() {
            const result = await apiRequest(`${API_BASE}/bookings`);
            
            if (result.ok && result.data.data) {
                // –ò—â–µ–º –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                const guestBooking = result.data.data.find(booking => 
                    booking.is_guest_booking || !booking.client_id
                );
                
                if (guestBooking) {
                    guestBookingId = guestBooking.id;
                    document.getElementById('getBookingResult').innerHTML = `
                        <div class="test-result success">
                            <h4>‚úÖ –ì–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
                            <p><strong>ID:</strong> ${guestBooking.id}</p>
                            ${displayBookingData(guestBooking)}
                        </div>
                    `;
                } else {
                    document.getElementById('getBookingResult').innerHTML = `
                        <div class="test-result info">
                            <h4>‚ÑπÔ∏è –ì–æ—Å—Ç–µ–≤—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                            <p>–°–æ–∑–¥–∞–π—Ç–µ –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é —Ñ–æ—Ä–º—É —Å–Ω–∞—á–∞–ª–∞</p>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        </div>
                    `;
                }
            } else {
                displayResult('getBookingResult', result, '‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π');
            }
        }

        // –¢–µ—Å—Ç 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        async function testUpdateGuestBooking() {
            if (!guestBookingId) {
                document.getElementById('updateBookingResult').innerHTML = `
                    <div class="test-result error">
                        <h4>‚ùå –û—à–∏–±–∫–∞</h4>
                        <p>–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–¢–µ—Å—Ç 1)</p>
                    </div>
                `;
                return;
            }

            const updateData = {
                booking: {
                    service_recipient_first_name: "–ò–≤–∞–Ω",
                    service_recipient_last_name: "–ü–µ—Ç—Ä–æ–≤", 
                    service_recipient_phone: "+380671234567",
                    service_recipient_email: "ivan.petrov@example.com",
                    car_brand: "Toyota",
                    car_model: "Camry",
                    license_plate: "–ê–ê1234–í–í",
                    notes: "–û–±–Ω–æ–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É"
                }
            };

            const result = await apiRequest(`${API_BASE}/bookings/${guestBookingId}`, {
                method: 'PATCH',
                body: JSON.stringify(updateData)
            });

            if (result.ok) {
                document.getElementById('updateBookingResult').innerHTML = `
                    <div class="test-result success">
                        <h4>‚úÖ –ì–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ</h4>
                        ${displayBookingData(result.data)}
                    </div>
                `;
            } else {
                displayResult('updateBookingResult', result, '‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
            }
        }

        // –¢–µ—Å—Ç 3: –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
        async function testCreateGuestBooking() {
            const bookingData = {
                booking: {
                    client_id: null, // –ì–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                    service_point_id: 1,
                    car_type_id: 1,
                    booking_date: "2025-01-15",
                    start_time: "14:00",
                    end_time: "15:00",
                    status_id: 1,
                    service_recipient_first_name: "–ú–∞—Ä–∏—è",
                    service_recipient_last_name: "–°–∏–¥–æ—Ä–æ–≤–∞",
                    service_recipient_phone: "+380509876543",
                    service_recipient_email: "maria.sidorova@example.com",
                    car_brand: "BMW",
                    car_model: "X5",
                    license_plate: "–ö–ö5678–ú–ú",
                    notes: "–°–æ–∑–¥–∞–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∫–∞–∫ –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
                }
            };

            const result = await apiRequest(`${API_BASE}/bookings`, {
                method: 'POST',
                body: JSON.stringify(bookingData)
            });

            if (result.ok) {
                document.getElementById('createBookingResult').innerHTML = `
                    <div class="test-result success">
                        <h4>‚úÖ –ì–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ</h4>
                        <p><strong>ID:</strong> ${result.data.id}</p>
                        ${displayBookingData(result.data)}
                    </div>
                `;
            } else {
                displayResult('createBookingResult', result, '‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
            }
        }

        // –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ UI –∞–¥–º–∏–Ω—Å–∫–æ–π —Ñ–æ—Ä–º—ã
        function testAdminUI() {
            const adminUrl = 'http://localhost:3008/admin/bookings/new';
            window.open(adminUrl, '_blank');
            
            document.getElementById('adminUIResult').innerHTML = `
                <div class="test-result info">
                    <h4>üåê –ê–¥–º–∏–Ω—Å–∫–∞—è —Ñ–æ—Ä–º–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</h4>
                    <p><strong>URL:</strong> <a href="${adminUrl}" target="_blank">${adminUrl}</a></p>
                    <div style="margin-top: 15px;">
                        <h5>–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ —Ñ–æ—Ä–º–µ:</h5>
                        <ul>
                            <li>‚úÖ –í —Å–µ–ª–µ–∫—Ç–µ "–ö–ª–∏–µ–Ω—Ç" –µ—Å—Ç—å –æ–ø—Ü–∏—è "–ì–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)"</li>
                            <li>‚úÖ –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å–µ–∫—Ü–∏—è "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è —É—Å–ª—É–≥–∏"</li>
                            <li>‚úÖ –ü–æ–ª—è: –ò–º—è, –§–∞–º–∏–ª–∏—è, –¢–µ–ª–µ—Ñ–æ–Ω, Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è —É—Å–ª—É–≥–∏</li>
                            <li>‚úÖ –ü–æ–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è: –ú–∞—Ä–∫–∞, –ú–æ–¥–µ–ª—å, –ù–æ–º–µ—Ä</li>
                            <li>‚úÖ –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø–µ—Ä–≤–æ–≥–æ —Ç–µ—Å—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            console.log('üéØ –¢–µ—Å—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–æ—Å—Ç–µ–≤—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –∞–¥–º–∏–Ω–∫–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        };
    </script>
</body>
</html> 