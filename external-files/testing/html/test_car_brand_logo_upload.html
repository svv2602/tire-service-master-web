<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–∞ –±—Ä–µ–Ω–¥–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .step h3 {
            margin-top: 0;
            color: #666;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè∑Ô∏è –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–∞ –±—Ä–µ–Ω–¥–∞ –∞–≤—Ç–æ</h1>
        <p>–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø–æ–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–æ–≤ –¥–ª—è –±—Ä–µ–Ω–¥–æ–≤ –∞–≤—Ç–æ.</p>
        
        <div class="step">
            <h3>–®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
            <button onclick="authorize()">–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω</button>
            <div id="authStatus"></div>
        </div>
        
        <div class="step">
            <h3>–®–∞–≥ 2: –í—ã–±–æ—Ä –ª–æ–≥–æ—Ç–∏–ø–∞</h3>
            <input type="file" id="logoFile" accept="image/*" onchange="handleFileSelect()">
            <div id="fileStatus"></div>
        </div>
        
        <div class="step">
            <h3>–®–∞–≥ 3: –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <button onclick="testFormDataUpload()" id="formDataBtn" disabled>–¢–µ—Å—Ç FormData (–∫–∞–∫ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ)</button>
            <button onclick="testDirectUpload()" id="directBtn" disabled>–¢–µ—Å—Ç —á–µ—Ä–µ–∑ fetch API</button>
            <div id="uploadStatus"></div>
        </div>
        
        <div class="step">
            <h3>–õ–æ–≥–∏</h3>
            <div id="logs" class="log"></div>
            <button onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>
    </div>

    <script>
        let authToken = null;
        let selectedFile = null;

        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.textContent += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').textContent = '';
        }

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function authorize() {
            try {
                log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...');
                const response = await fetch('http://localhost:8000/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: 'admin@test.com',
                        password: 'admin123'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.tokens.access;
                    log(`–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–æ–∫–µ–Ω: ${authToken.substring(0, 20)}...`);
                    showStatus('authStatus', '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                    updateButtons();
                } else {
                    const errorText = await response.text();
                    log(`–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${response.status} - ${errorText}`);
                    showStatus('authStatus', `–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`);
                showStatus('authStatus', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        function handleFileSelect() {
            const fileInput = document.getElementById('logoFile');
            selectedFile = fileInput.files[0];
            
            if (selectedFile) {
                log(`–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${selectedFile.name} (${selectedFile.size} –±–∞–π—Ç, ${selectedFile.type})`);
                showStatus('fileStatus', `–í—ã–±—Ä–∞–Ω: ${selectedFile.name}`, 'success');
                updateButtons();
            } else {
                log('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');
                showStatus('fileStatus', '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω', 'error');
                updateButtons();
            }
        }

        function updateButtons() {
            const canTest = authToken && selectedFile;
            document.getElementById('formDataBtn').disabled = !canTest;
            document.getElementById('directBtn').disabled = !canTest;
        }

        async function testFormDataUpload() {
            if (!authToken || !selectedFile) {
                showStatus('uploadStatus', '–ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞', 'error');
                return;
            }

            try {
                log('=== –¢–µ—Å—Ç FormData –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–∏–º—É–ª—è—Ü–∏—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞) ===');
                
                // –°–æ–∑–¥–∞–µ–º FormData –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                const formData = new FormData();
                formData.append('car_brand[name]', 'BMW Updated via Web Interface Test');
                formData.append('car_brand[logo]', selectedFile);
                formData.append('car_brand[is_active]', 'true');
                
                log('FormData —Å–æ–∑–¥–∞–Ω–∞:');
                for (let [key, value] of formData.entries()) {
                    if (value instanceof File) {
                        log(`  ${key}: File(${value.name}, ${value.size} bytes)`);
                    } else {
                        log(`  ${key}: ${value}`);
                    }
                }
                
                log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º PATCH –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/v1/car_brands/4...');
                const response = await fetch('http://localhost:8000/api/v1/car_brands/4', {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Content-Type –¥–ª—è FormData!
                    },
                    credentials: 'include',
                    body: formData
                });
                
                log(`–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω: ${response.status} ${response.statusText}`);
                log(`Content-Type –æ—Ç–≤–µ—Ç–∞: ${response.headers.get('content-type')}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`–£—Å–ø–µ—Ö! –û—Ç–≤–µ—Ç: ${JSON.stringify(result, null, 2)}`);
                    showStatus('uploadStatus', 'FormData –∑–∞–≥—Ä—É–∑–∫–∞ —É—Å–ø–µ—à–Ω–∞!', 'success');
                } else {
                    const errorText = await response.text();
                    log(`–û—à–∏–±–∫–∞: ${response.status} - ${errorText}`);
                    showStatus('uploadStatus', `–û—à–∏–±–∫–∞ FormData: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`);
                showStatus('uploadStatus', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function testDirectUpload() {
            if (!authToken || !selectedFile) {
                showStatus('uploadStatus', '–ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞', 'error');
                return;
            }

            try {
                log('=== –¢–µ—Å—Ç –ø—Ä—è–º–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ fetch ===');
                
                const formData = new FormData();
                formData.append('car_brand[name]', 'BMW Updated via Direct Test');
                formData.append('car_brand[logo]', selectedFile);
                formData.append('car_brand[is_active]', 'true');
                
                log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º PATCH –∑–∞–ø—Ä–æ—Å...');
                const response = await fetch('http://localhost:8000/api/v1/car_brands/4', {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                    },
                    credentials: 'include',
                    body: formData
                });
                
                log(`–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`–£—Å–ø–µ—Ö! –û—Ç–≤–µ—Ç: ${JSON.stringify(result, null, 2)}`);
                    showStatus('uploadStatus', '–ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —É—Å–ø–µ—à–Ω–∞!', 'success');
                } else {
                    const errorText = await response.text();
                    log(`–û—à–∏–±–∫–∞: ${response.status} - ${errorText}`);
                    showStatus('uploadStatus', `–û—à–∏–±–∫–∞ –ø—Ä—è–º–æ–π –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`);
                showStatus('uploadStatus', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        log('–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        log('–î–æ—Å—Ç—É–ø–Ω—ã —Ç–µ—Å—Ç—ã:');
        log('1. FormData —á–µ—Ä–µ–∑ —Å–∏–º—É–ª—è—Ü–∏—é –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞');
        log('2. –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ fetch API');
        log('');
        log('–ù–∞—á–Ω–∏—Ç–µ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞.');
    </script>
</body>
</html>
