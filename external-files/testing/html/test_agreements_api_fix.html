<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ AgreementsPage</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 400px;
        }
        .agreement-card {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .missing-data {
            color: #dc3545;
            font-weight: bold;
        }
        .valid-data {
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ AgreementsPage</h1>
        
        <div class="test-section info">
            <h3>üìã –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏</h3>
            <p><strong>–û—à–∏–±–∫–∞:</strong> Cannot read properties of undefined (reading 'company_name')</p>
            <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∏–º–µ—é—Ç partner_info –∏–ª–∏ supplier_info —Ä–∞–≤–Ω—ã–º–∏ null/undefined</p>
            <p><strong>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> –î–æ–±–∞–≤–ª–µ–Ω optional chaining (?.) –≤ frontend –∏ –∑–∞—â–∏—Ç–∞ –≤ backend</p>
        </div>

        <div class="test-section">
            <h3>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
            
            <button onclick="testAgreementsAPI()">üì• –¢–µ—Å—Ç API /agreements</button>
            <button onclick="testPartnersAPI()">üë• –¢–µ—Å—Ç API /agreements/partners</button>
            <button onclick="testSuppliersAPI()">üè≠ –¢–µ—Å—Ç API /agreements/suppliers</button>
            <button onclick="clearResults()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';

        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testAgreementsAPI() {
            try {
                addResult('üöÄ –ó–∞–ø—Ä–æ—Å –∫ /api/v1/agreements', '–ó–∞–≥—Ä—É–∑–∫–∞...', 'info');

                const response = await fetch(`${API_BASE}/agreements`, {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    const agreements = result.data;
                    
                    addResult('üìä –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—è—Ö', 
                        `–í—Å–µ–≥–æ: ${agreements.length}\n–°—Ç—Ä–∞–Ω–∏—Ü–∞: ${result.meta.page}\n–í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü: ${result.meta.total_pages}`, 
                        'success');
                    
                    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ –Ω–∞–ª–∏—á–∏–µ partner_info –∏ supplier_info
                    let validCount = 0;
                    let invalidCount = 0;
                    let analysisResults = [];
                    
                    agreements.forEach(agreement => {
                        const analysis = {
                            id: agreement.id,
                            partner_info: agreement.partner_info ? '–û–ö' : '‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢',
                            supplier_info: agreement.supplier_info ? '–û–ö' : '‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢',
                            partner_name: agreement.partner_info?.company_name || '–ù–ï –£–ö–ê–ó–ê–ù–û',
                            supplier_name: agreement.supplier_info?.name || '–ù–ï –£–ö–ê–ó–ê–ù–û'
                        };
                        
                        if (agreement.partner_info && agreement.supplier_info) {
                            validCount++;
                        } else {
                            invalidCount++;
                        }
                        
                        analysisResults.push(analysis);
                    });
                    
                    addResult('üîç –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π', 
                        `‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö: ${validCount}\n‚ùå –° –ø—Ä–æ–±–ª–µ–º–∞–º–∏: ${invalidCount}`, 
                        invalidCount > 0 ? 'warning' : 'success');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
                    if (analysisResults.length > 0) {
                        const detailedAnalysis = analysisResults.map(a => 
                            `ID: ${a.id} | –ü–∞—Ä—Ç–Ω–µ—Ä: ${a.partner_info} (${a.partner_name}) | –ü–æ—Å—Ç–∞–≤—â–∏–∫: ${a.supplier_info} (${a.supplier_name})`
                        ).join('\n');
                        
                        addResult('üìã –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ ID', detailedAnalysis, 'info');
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–ø–∏—Å–∏
                    const problematicAgreements = agreements.filter(a => !a.partner_info || !a.supplier_info);
                    if (problematicAgreements.length > 0) {
                        addResult('‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏', 
                            JSON.stringify(problematicAgreements, null, 2), 
                            'error');
                    }
                    
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ API', JSON.stringify(result, null, 2), 'error');
                }
            } catch (error) {
                addResult('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', error.message, 'error');
            }
        }

        async function testPartnersAPI() {
            try {
                const response = await fetch(`${API_BASE}/agreements/partners`, {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    const partners = result.data;
                    addResult('üë• –ü–∞—Ä—Ç–Ω–µ—Ä—ã –¥–ª—è –≤—ã–±–æ—Ä–∞', 
                        `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${partners.length}\n\n${partners.map(p => 
                            `ID: ${p.id} | ${p.company_name} (${p.contact_person}) | –ê–∫—Ç–∏–≤–µ–Ω: ${p.is_active}`
                        ).join('\n')}`, 
                        'success');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤', JSON.stringify(result, null, 2), 'error');
                }
            } catch (error) {
                addResult('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ (–ø–∞—Ä—Ç–Ω–µ—Ä—ã)', error.message, 'error');
            }
        }

        async function testSuppliersAPI() {
            try {
                const response = await fetch(`${API_BASE}/agreements/suppliers`, {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    const suppliers = result.data;
                    addResult('üè≠ –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞', 
                        `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${suppliers.length}\n\n${suppliers.map(s => 
                            `ID: ${s.id} | ${s.name} (${s.firm_id}) | –ê–∫—Ç–∏–≤–µ–Ω: ${s.is_active} | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${s.priority}`
                        ).join('\n')}`, 
                        'success');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤', JSON.stringify(result, null, 2), 'error');
                }
            } catch (error) {
                addResult('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ (–ø–æ—Å—Ç–∞–≤—â–∏–∫–∏)', error.message, 'error');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            setTimeout(testAgreementsAPI, 500);
        });
    </script>
</body>
</html>