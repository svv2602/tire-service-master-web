<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π –∫–æ–º–∏—Å—Å–∏–∏</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .field-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 200px;
            font-weight: bold;
        }
        input, select {
            width: 200px;
            padding: 5px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π –∫–æ–º–∏—Å—Å–∏–∏</h1>
        
        <div class="test-section info">
            <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–µ</h3>
            <p><strong>–¶–µ–ª—å:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ PATCH –∑–∞–ø—Ä–æ—Å –∫ /api/v1/agreements/:id –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—è commission_amount, commission_percentage, commission_unit</p>
            <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> –ü–æ–ª—è –Ω–µ –±—ã–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã –≤ agreement_params –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞</p>
            <p><strong>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ agreement_params –∏ serialize_agreement</p>
        </div>

        <div class="test-section">
            <h3>üéØ –¢–µ—Å—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è agreement ID 2</h3>
            
            <div class="field-group">
                <label>–¢–∏–ø –∫–æ–º–∏—Å—Å–∏–∏:</label>
                <select id="commission_type">
                    <option value="fixed_amount">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞</option>
                    <option value="percentage">–ü—Ä–æ—Ü–µ–Ω—Ç</option>
                    <option value="custom">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</option>
                </select>
            </div>
            
            <div class="field-group">
                <label>–°—É–º–º–∞ –∫–æ–º–∏—Å—Å–∏–∏:</label>
                <input type="number" id="commission_amount" placeholder="100.00" step="0.01">
            </div>
            
            <div class="field-group">
                <label>–ü—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏:</label>
                <input type="number" id="commission_percentage" placeholder="5.5" step="0.1">
            </div>
            
            <div class="field-group">
                <label>–ï–¥–∏–Ω–∏—Ü–∞ –∫–æ–º–∏—Å—Å–∏–∏:</label>
                <select id="commission_unit">
                    <option value="per_order">–ó–∞ –∑–∞–∫–∞–∑</option>
                    <option value="per_item">–ó–∞ –µ–¥–∏–Ω–∏—Ü—É</option>
                </select>
            </div>
            
            <div class="field-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <input type="text" id="description" placeholder="–¢–µ—Å—Ç–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è –∫–æ–º–∏—Å—Å–∏–∏">
            </div>
            
            <button onclick="testUpdate()">üöÄ –¢–µ—Å—Ç PATCH –∑–∞–ø—Ä–æ—Å–∞</button>
            <button onclick="testGet()">üì• –¢–µ—Å—Ç GET –∑–∞–ø—Ä–æ—Å–∞</button>
            <button onclick="clearResults()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const AGREEMENT_ID = 2;

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.getElementById('commission_type').value = 'fixed_amount';
        document.getElementById('commission_amount').value = '50.00';
        document.getElementById('commission_percentage').value = '';
        document.getElementById('commission_unit').value = 'per_order';
        document.getElementById('description').value = '–¢–µ—Å—Ç–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è –∫–æ–º–∏—Å—Å–∏–∏ - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ';

        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testUpdate() {
            const commissType = document.getElementById('commission_type').value;
            const commissionAmount = document.getElementById('commission_amount').value;
            const commissionPercentage = document.getElementById('commission_percentage').value;
            const commissionUnit = document.getElementById('commission_unit').value;
            const description = document.getElementById('description').value;

            const requestBody = {
                agreement: {
                    commission_type: commissType,
                    commission_unit: commissionUnit,
                    description: description
                }
            };

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–º–∏—Å—Å–∏–∏
            if (commissType === 'fixed_amount' && commissionAmount) {
                requestBody.agreement.commission_amount = parseFloat(commissionAmount);
                requestBody.agreement.commission_percentage = null;
            } else if (commissType === 'percentage' && commissionPercentage) {
                requestBody.agreement.commission_percentage = parseFloat(commissionPercentage);
                requestBody.agreement.commission_amount = null;
            }

            try {
                addResult('üöÄ PATCH –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', JSON.stringify(requestBody, null, 2));

                const response = await fetch(`${API_BASE}/agreements/${AGREEMENT_ID}`, {
                    method: 'PATCH',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ PATCH –æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω—ã–π', JSON.stringify(result, null, 2), 'success');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—è –∫–æ–º–∏—Å—Å–∏–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –æ—Ç–≤–µ—Ç–µ
                    const data = result.data;
                    const commissionFields = {
                        commission_type: data.commission_type,
                        commission_amount: data.commission_amount,
                        commission_percentage: data.commission_percentage,
                        commission_unit: data.commission_unit
                    };
                    
                    addResult('üîç –ü–æ–ª—è –∫–æ–º–∏—Å—Å–∏–∏ –≤ –æ—Ç–≤–µ—Ç–µ', JSON.stringify(commissionFields, null, 2), 'info');
                } else {
                    addResult('‚ùå PATCH –æ—à–∏–±–∫–∞', JSON.stringify(result, null, 2), 'error');
                }
            } catch (error) {
                addResult('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ PATCH', error.message, 'error');
            }
        }

        async function testGet() {
            try {
                const response = await fetch(`${API_BASE}/agreements/${AGREEMENT_ID}`, {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    addResult('üì• GET –æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω—ã–π', JSON.stringify(result, null, 2), 'success');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—è –∫–æ–º–∏—Å—Å–∏–∏
                    const data = result.data;
                    const commissionSummary = {
                        commission_type: data.commission_type,
                        commission_amount: data.commission_amount,
                        commission_percentage: data.commission_percentage,
                        commission_unit: data.commission_unit,
                        description: data.description
                    };
                    
                    addResult('üí∞ –¢–µ–∫—É—â–∏–µ —É—Å–ª–æ–≤–∏—è –∫–æ–º–∏—Å—Å–∏–∏', JSON.stringify(commissionSummary, null, 2), 'info');
                } else {
                    addResult('‚ùå GET –æ—à–∏–±–∫–∞', JSON.stringify(result, null, 2), 'error');
                }
            } catch (error) {
                addResult('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ GET', error.message, 'error');
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞ –∫–æ–º–∏—Å—Å–∏–∏
        document.getElementById('commission_type').addEventListener('change', function() {
            const type = this.value;
            const amountField = document.getElementById('commission_amount');
            const percentageField = document.getElementById('commission_percentage');
            
            if (type === 'fixed_amount') {
                amountField.value = '50.00';
                percentageField.value = '';
            } else if (type === 'percentage') {
                amountField.value = '';
                percentageField.value = '5.5';
            } else {
                amountField.value = '';
                percentageField.value = '';
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            setTimeout(testGet, 500);
        });
    </script>
</body>
</html>