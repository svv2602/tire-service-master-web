<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –∑–∞–∫–∞–∑–æ–≤ –≤ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—è—Ö</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
        }
        .scenario {
            margin: 15px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .field-group {
            margin: 10px 0;
            display: inline-block;
            width: 30%;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        select, input {
            width: 90%;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –∑–∞–∫–∞–∑–æ–≤ –≤ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—è—Ö</h1>
        
        <div class="test-section info">
            <h3>üìã –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏</h3>
            <ul>
                <li><strong>–ü—Ä–∞–≤–∏–ª–æ 1:</strong> –£ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–º –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∑–∞–∫–∞–∑–æ–≤</li>
                <li><strong>–ü—Ä–∞–≤–∏–ª–æ 2:</strong> –ï—Å–ª–∏ –µ—Å—Ç—å —É—Å–ª–æ–≤–∏–µ "–û–±–∞ —Ç–∏–ø–∞", –Ω–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ –∫–æ—Ä–∑–∏–Ω—ã –∏–ª–∏ –≤—ã–¥–∞—á–∏</li>
                <li><strong>–ü—Ä–∞–≤–∏–ª–æ 3:</strong> –ï—Å–ª–∏ –µ—Å—Ç—å —É—Å–ª–æ–≤–∏–µ –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ –∫–æ—Ä–∑–∏–Ω—ã, –Ω–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —É—Å–ª–æ–≤–∏–µ "–û–±–∞ —Ç–∏–ø–∞"</li>
                <li><strong>–ü—Ä–∞–≤–∏–ª–æ 4:</strong> –ú–æ–∂–Ω–æ –∏–º–µ—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ –∫–æ—Ä–∑–∏–Ω—ã –∏ –≤—ã–¥–∞—á–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üéØ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π</h3>
            
            <div class="field-group">
                <label>–ü–∞—Ä—Ç–Ω–µ—Ä:</label>
                <select id="partner_id">
                    <option value="1">–ü–∞—Ä—Ç–Ω–µ—Ä 1</option>
                    <option value="2">–ü–∞—Ä—Ç–Ω–µ—Ä 2</option>
                </select>
            </div>
            
            <div class="field-group">
                <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫:</label>
                <select id="supplier_id">
                    <option value="1">–ü–æ—Å—Ç–∞–≤—â–∏–∫ 1</option>
                    <option value="2">–ü–æ—Å—Ç–∞–≤—â–∏–∫ 2</option>
                </select>
            </div>
            
            <div class="field-group">
                <label>–¢–∏–ø –∑–∞–∫–∞–∑–æ–≤:</label>
                <select id="order_types">
                    <option value="cart_orders">–ó–∞–∫–∞–∑ —Ç–æ–≤–∞—Ä–∞ (–∫–æ—Ä–∑–∏–Ω–∞)</option>
                    <option value="pickup_orders">–í—ã–¥–∞—á–∞ —Ç–æ–≤–∞—Ä–∞</option>
                    <option value="both">–û–±–∞ —Ç–∏–ø–∞</option>
                </select>
            </div>
            
            <br><br>
            
            <button onclick="createAgreement()">‚ûï –°–æ–∑–¥–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å</button>
            <button onclick="getExistingAgreements()">üìã –ü–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ</button>
            <button onclick="runValidationScenarios()">üß™ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏</button>
            <button onclick="clearResults()" class="danger">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';

        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function createAgreement() {
            const partnerId = document.getElementById('partner_id').value;
            const supplierId = document.getElementById('supplier_id').value;
            const orderTypes = document.getElementById('order_types').value;

            const requestBody = {
                agreement: {
                    partner_id: parseInt(partnerId),
                    supplier_id: parseInt(supplierId),
                    start_date: new Date().toISOString().split('T')[0],
                    commission_type: 'fixed_amount',
                    commission_amount: 100.0,
                    commission_unit: 'per_order',
                    order_types: orderTypes,
                    active: true,
                    description: `–¢–µ—Å—Ç–æ–≤–∞—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${orderTypes}`
                }
            };

            try {
                addResult('üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏', JSON.stringify(requestBody, null, 2));

                const response = await fetch(`${API_BASE}/agreements`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ –î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ', JSON.stringify(result, null, 2), 'success');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è (–æ–∂–∏–¥–∞–µ–º–∞—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏)', JSON.stringify(result, null, 2), 'warning');
                }
            } catch (error) {
                addResult('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', error.message, 'error');
            }
        }

        async function getExistingAgreements() {
            try {
                const response = await fetch(`${API_BASE}/agreements`, {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    const agreements = result.data;
                    const summary = agreements.map(a => ({
                        id: a.id,
                        partner: a.partner_info.company_name,
                        supplier: a.supplier_info.name,
                        order_types: a.order_types,
                        order_types_text: a.order_types_text,
                        active: a.active,
                        status: a.status_text
                    }));
                    
                    addResult('üìã –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏', JSON.stringify(summary, null, 2), 'info');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π', JSON.stringify(result, null, 2), 'error');
                }
            } catch (error) {
                addResult('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', error.message, 'error');
            }
        }

        async function runValidationScenarios() {
            addResult('üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏', '–¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –∑–∞–∫–∞–∑–æ–≤...', 'info');

            // –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–æ–∑–¥–∞–µ–º –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å "–û–±–∞ —Ç–∏–ø–∞"
            await testScenario('–ü–∞—Ä—Ç–Ω–µ—Ä 1 + –ü–æ—Å—Ç–∞–≤—â–∏–∫ 1 + –û–±–∞ —Ç–∏–ø–∞', 1, 1, 'both');
            
            // –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å "–ó–∞–∫–∞–∑ —Ç–æ–≤–∞—Ä–∞" (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)
            await testScenario('–ü–∞—Ä—Ç–Ω–µ—Ä 1 + –ü–æ—Å—Ç–∞–≤—â–∏–∫ 1 + –ó–∞–∫–∞–∑ —Ç–æ–≤–∞—Ä–∞ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞)', 1, 1, 'cart_orders');
            
            // –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å "–í—ã–¥–∞—á–∞ —Ç–æ–≤–∞—Ä–∞" (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)
            await testScenario('–ü–∞—Ä—Ç–Ω–µ—Ä 1 + –ü–æ—Å—Ç–∞–≤—â–∏–∫ 1 + –í—ã–¥–∞—á–∞ —Ç–æ–≤–∞—Ä–∞ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞)', 1, 1, 'pickup_orders');
            
            // –°—Ü–µ–Ω–∞—Ä–∏–π 4: –°–æ–∑–¥–∞–µ–º –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
            await testScenario('–ü–∞—Ä—Ç–Ω–µ—Ä 2 + –ü–æ—Å—Ç–∞–≤—â–∏–∫ 1 + –ó–∞–∫–∞–∑ —Ç–æ–≤–∞—Ä–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)', 2, 1, 'cart_orders');
            
            // –°—Ü–µ–Ω–∞—Ä–∏–π 5: –°–æ–∑–¥–∞–µ–º –¥–ª—è —Ç–æ–≥–æ –∂–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞, –Ω–æ –¥—Ä—É–≥–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
            await testScenario('–ü–∞—Ä—Ç–Ω–µ—Ä 2 + –ü–æ—Å—Ç–∞–≤—â–∏–∫ 2 + –û–±–∞ —Ç–∏–ø–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)', 2, 2, 'both');
        }

        async function testScenario(description, partnerId, supplierId, orderTypes) {
            const requestBody = {
                agreement: {
                    partner_id: partnerId,
                    supplier_id: supplierId,
                    start_date: new Date().toISOString().split('T')[0],
                    commission_type: 'fixed_amount',
                    commission_amount: 100.0,
                    commission_unit: 'per_order',
                    order_types: orderTypes,
                    active: true,
                    description: `–¢–µ—Å—Ç: ${description}`
                }
            };

            try {
                const response = await fetch(`${API_BASE}/agreements`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                
                if (response.ok) {
                    addResult(`‚úÖ ${description}`, `–£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å ID: ${result.data.id}`, 'success');
                } else {
                    if (result.errors && result.errors.length > 0) {
                        addResult(`üö´ ${description}`, `–í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ä–∞–±–æ—Ç–∞–ª–∞: ${result.errors.join(', ')}`, 'warning');
                    } else {
                        addResult(`‚ùå ${description}`, JSON.stringify(result, null, 2), 'error');
                    }
                }
            } catch (error) {
                addResult(`‚ùå ${description}`, `–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
            }

            // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            setTimeout(getExistingAgreements, 500);
        });
    </script>
</body>
</html>