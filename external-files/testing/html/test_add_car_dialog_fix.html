<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è AddCarToProfileDialog</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .code {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            border-left: 4px solid #007bff;
            margin: 10px 0;
        }
        .button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover { background-color: #0056b3; }
        .section {
            border-left: 4px solid #28a745;
            padding-left: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üöó –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è AddCarToProfileDialog</h1>
    
    <div class="test-container">
        <h2>üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</h2>
        <div class="error">
            <strong>–û—à–∏–±–∫–∞ 422:</strong> –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –≤ –ø—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥ AddCarToProfileDialog
        </div>
        
        <h3>üîç –ö–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</h3>
        <ul>
            <li><strong>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π model_id:</strong> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–π model_id: 1, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î</li>
            <li><strong>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π brand_id:</strong> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–π brand_id: 1 –≤–º–µ—Å—Ç–æ –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é</li>
            <li><strong>–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:</strong> –ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª–æ—Å—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ –∏ –º–æ–¥–µ–ª–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π</li>
        </ul>
    </div>

    <div class="test-container">
        <h2>‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
        
        <div class="section">
            <h3>1. –î–æ–±–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ –±—Ä–µ–Ω–¥–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é</h3>
            <div class="code">// –ù–∞—Ö–æ–¥–∏–º –±—Ä–µ–Ω–¥ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –µ–≥–æ ID
const foundBrand = carData.car_brand && carBrandsData?.data ? 
  carBrandsData.data.find(brand => 
    brand.name.toLowerCase() === carData.car_brand!.toLowerCase()
  ) : null;</div>
        </div>

        <div class="section">
            <h3>2. –î–æ–±–∞–≤–ª–µ–Ω API —Ö—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π –ø–æ –±—Ä–µ–Ω–¥—É</h3>
            <div class="code">// –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª–∏ –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞
const { data: carModelsData } = useGetCarModelsByBrandIdQuery(
  foundBrand ? { brandId: foundBrand.id.toString() } : { brandId: '0' },
  { skip: !foundBrand }
);</div>
        </div>

        <div class="section">
            <h3>3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –º–æ–¥–µ–ª–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é</h3>
            <div class="code">// –ò—â–µ–º –º–æ–¥–µ–ª—å –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≤ –Ω–∞–π–¥–µ–Ω–Ω–æ–º –±—Ä–µ–Ω–¥–µ
let modelId: number;
if (carData.car_model && carModelsData?.car_models) {
  const foundModel = carModelsData.car_models.find(model => 
    model.name.toLowerCase() === carData.car_model!.toLowerCase()
  );
  if (foundModel) {
    modelId = foundModel.id;
  } else {
    // Fallback –∫ –ø–µ—Ä–≤–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –º–æ–¥–µ–ª–∏
    modelId = carModelsData.car_models[0].id;
  }
}</div>
        </div>

        <div class="section">
            <h3>4. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫</h3>
            <div class="code">if (!carBrandsData?.data || carBrandsData.data.length === 0) {
  throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±—Ä–µ–Ω–¥—ã –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π');
}

if (!carModelsData?.car_models || carModelsData.car_models.length === 0) {
  throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –º–æ–¥–µ–ª–∏ –¥–ª—è –±—Ä–µ–Ω–¥–∞ ${foundBrand?.name}`);
}</div>
        </div>
    </div>

    <div class="test-container">
        <h2>üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏</h2>
        
        <div class="section">
            <h3>–°—Ü–µ–Ω–∞—Ä–∏–π 1: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±—Ä–µ–Ω–¥ –∏ –º–æ–¥–µ–ª—å</h3>
            <div class="info">
                <strong>–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong>
                <div class="code">{
  "license_plate": "AA 1234 BC",
  "car_brand": "Ford",
  "car_model": "Focus",
  "car_type_id": 17
}</div>
                <strong>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong> –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ brand_id –∏ model_id
            </div>
        </div>

        <div class="section">
            <h3>–°—Ü–µ–Ω–∞—Ä–∏–π 2: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±—Ä–µ–Ω–¥, –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –º–æ–¥–µ–ª—å</h3>
            <div class="warning">
                <strong>–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong>
                <div class="code">{
  "license_plate": "AA 5678 CD",
  "car_brand": "Ford",
  "car_model": "NonExistentModel",
  "car_type_id": 17
}</div>
                <strong>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –º–æ–¥–µ–ª–∏ Ford (–Ω–∞–ø—Ä–∏–º–µ—Ä, Focus)
            </div>
        </div>

        <div class="section">
            <h3>–°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±—Ä–µ–Ω–¥</h3>
            <div class="warning">
                <strong>–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong>
                <div class="code">{
  "license_plate": "AA 9012 EF",
  "car_brand": "NonExistentBrand",
  "car_model": "SomeModel",
  "car_type_id": 17
}</div>
                <strong>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞ –∏ –µ–≥–æ –ø–µ—Ä–≤–æ–π –º–æ–¥–µ–ª–∏
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>üîß API —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
        <div id="api-results"></div>
        
        <button class="button" onclick="testCarBrands()">–¢–µ—Å—Ç: –ü–æ–ª—É—á–∏—Ç—å –±—Ä–µ–Ω–¥—ã</button>
        <button class="button" onclick="testFordModels()">–¢–µ—Å—Ç: –ú–æ–¥–µ–ª–∏ Ford</button>
        <button class="button" onclick="testCreateCar()">–¢–µ—Å—Ç: –°–æ–∑–¥–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å</button>
        <button class="button" onclick="clearResults()">–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
    </div>

    <div class="test-container">
        <h2>üìù –ß–µ–∫-–ª–∏—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π</h2>
        <ul>
            <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç useGetCarModelsByBrandIdQuery</li>
            <li>‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–∏—Å–∫ –±—Ä–µ–Ω–¥–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é</li>
            <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω API –∑–∞–ø—Ä–æ—Å –º–æ–¥–µ–ª–µ–π –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞</li>
            <li>‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–∏—Å–∫ –º–æ–¥–µ–ª–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é</li>
            <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±—Ä–µ–Ω–¥–æ–≤/–º–æ–¥–µ–ª–µ–π</li>
            <li>‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏</li>
            <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏</li>
            <li>‚úÖ –£–ª—É—á—à–µ–Ω UI –¥–∏–∞–ª–æ–≥–∞ —Å –∫–∞—Ä—Ç–æ—á–∫–æ–π –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª—è</li>
        </ul>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let authToken = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
        async function getAuthToken() {
            if (authToken) return authToken;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        auth: {
                            email: 'svv2602@gmail.com',
                            password: '0111111111'
                        }
                    })
                });
                
                const data = await response.json();
                if (data.access_token) {
                    authToken = data.access_token;
                    return authToken;
                }
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
                throw err;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function addResult(status, title, content) {
            const resultsDiv = document.getElementById('api-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${status}`;
            resultDiv.innerHTML = `<strong>${title}</strong><div class="code">${content}</div>`;
            resultsDiv.appendChild(resultDiv);
        }

        // –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –±—Ä–µ–Ω–¥–æ–≤
        async function testCarBrands() {
            try {
                const token = await getAuthToken();
                const response = await fetch(`${API_BASE}/car_brands`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                addResult('success', '‚úÖ –ë—Ä–µ–Ω–¥—ã –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 
                    `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–µ–Ω–¥–æ–≤: ${data.car_brands?.length || 0}\n` +
                    `–ü–µ—Ä–≤—ã–µ 3 –±—Ä–µ–Ω–¥–∞: ${data.car_brands?.slice(0, 3).map(b => b.name).join(', ')}`
                );
            } catch (err) {
                addResult('error', '‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±—Ä–µ–Ω–¥–æ–≤', err.message);
            }
        }

        // –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π Ford
        async function testFordModels() {
            try {
                const token = await getAuthToken();
                // –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–µ–º ID Ford
                const brandsResponse = await fetch(`${API_BASE}/car_brands`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const brandsData = await brandsResponse.json();
                const fordBrand = brandsData.car_brands?.find(b => b.name.toLowerCase() === 'ford');
                
                if (!fordBrand) {
                    throw new Error('–ë—Ä–µ–Ω–¥ Ford –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }

                const modelsResponse = await fetch(`${API_BASE}/car_brands/${fordBrand.id}/car_models`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const modelsData = await modelsResponse.json();
                
                addResult('success', '‚úÖ –ú–æ–¥–µ–ª–∏ Ford –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 
                    `Ford ID: ${fordBrand.id}\n` +
                    `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–µ–π: ${modelsData.car_models?.length || 0}\n` +
                    `–ú–æ–¥–µ–ª–∏: ${modelsData.car_models?.map(m => m.name).join(', ')}`
                );
            } catch (err) {
                addResult('error', '‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π Ford', err.message);
            }
        }

        // –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è
        async function testCreateCar() {
            try {
                const token = await getAuthToken();
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è
                const brandsResponse = await fetch(`${API_BASE}/car_brands`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const brandsData = await brandsResponse.json();
                const fordBrand = brandsData.car_brands?.find(b => b.name.toLowerCase() === 'ford');
                
                if (!fordBrand) {
                    throw new Error('–ë—Ä–µ–Ω–¥ Ford –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }

                const modelsResponse = await fetch(`${API_BASE}/car_brands/${fordBrand.id}/car_models`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const modelsData = await modelsResponse.json();
                const focusModel = modelsData.car_models?.find(m => m.name.toLowerCase() === 'focus');
                
                if (!focusModel) {
                    throw new Error('–ú–æ–¥–µ–ª—å Focus –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }

                // –°–æ–∑–¥–∞–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª—å
                const carData = {
                    car: {
                        brand_id: fordBrand.id,
                        model_id: focusModel.id,
                        year: 2024,
                        license_plate: `TEST${Date.now()}`,
                        car_type_id: 17,
                        is_primary: false
                    }
                };

                const createResponse = await fetch(`${API_BASE}/auth/me/cars`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(carData)
                });
                
                const result = await createResponse.json();
                
                if (createResponse.ok) {
                    addResult('success', '‚úÖ –ê–≤—Ç–æ–º–æ–±–∏–ª—å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 
                        `ID: ${result.car?.id}\n` +
                        `–ë—Ä–µ–Ω–¥: ${result.car?.brand?.name}\n` +
                        `–ú–æ–¥–µ–ª—å: ${result.car?.model?.name}\n` +
                        `–ù–æ–º–µ—Ä: ${result.car?.license_plate}`
                    );
                } else {
                    addResult('error', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è', 
                        `–°—Ç–∞—Ç—É—Å: ${createResponse.status}\n` +
                        `–û—à–∏–±–∫–∏: ${JSON.stringify(result.errors || result.error, null, 2)}`
                    );
                }
            } catch (err) {
                addResult('error', '‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è', err.message);
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function clearResults() {
            document.getElementById('api-results').innerHTML = '';
        }
    </script>
</body>
</html> 