<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –ø—Ä–∏–≤—è–∑–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .step {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .step h3 {
            margin-top: 0;
            color: #333;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –ø—Ä–∏–≤—è–∑–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h1>
        <p>–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª–Ω—ã–π —Ñ–ª–æ—É —Å–æ–∑–¥–∞–Ω–∏—è –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –ø—Ä–∏–≤—è–∑–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –∫–ª–∏–µ–Ω—Ç—É.</p>
    </div>

    <div class="container">
        <div class="step info">
            <h3>üìã –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <p>–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–¥–∏–º –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.</p>
            
            <div class="form-group">
                <label>–ò–º—è:</label>
                <input type="text" id="firstName" value="–¢–µ—Å—Ç" />
            </div>
            <div class="form-group">
                <label>–§–∞–º–∏–ª–∏—è:</label>
                <input type="text" id="lastName" value="–¢–µ—Å—Ç–æ–≤" />
            </div>
            <div class="form-group">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <input type="text" id="phone" value="+380671234567" />
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="email" value="test@example.com" />
            </div>
            
            <button onclick="createGuestBooking()">–°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <div id="bookingResult" class="result"></div>
        </div>
    </div>

    <div class="container">
        <div class="step info">
            <h3>üë§ –®–∞–≥ 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞</h3>
            <p>–°–æ–∑–¥–∞–¥–∏–º –∞–∫–∫–∞—É–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞ —Å —Ç–µ–º–∏ –∂–µ –¥–∞–Ω–Ω—ã–º–∏.</p>
            
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="password" value="test123" />
            </div>
            
            <button onclick="registerClient()" disabled id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
            <div id="registerResult" class="result"></div>
        </div>
    </div>

    <div class="container">
        <div class="step info">
            <h3>üîó –®–∞–≥ 3: –ü—Ä–∏–≤—è–∑–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –∫–ª–∏–µ–Ω—Ç—É</h3>
            <p>–ü—Ä–∏–≤—è–∂–µ–º —Å–æ–∑–¥–∞–Ω–Ω–æ–µ –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –Ω–æ–≤–æ–º—É –∫–ª–∏–µ–Ω—Ç—É.</p>
            
            <button onclick="assignBookingToClient()" disabled id="assignBtn">–ü—Ä–∏–≤—è–∑–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <div id="assignResult" class="result"></div>
        </div>
    </div>

    <div class="container">
        <div class="step info">
            <h3>üîê –®–∞–≥ 4: –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            <p>–í–æ–π–¥–µ–º –≤ —Å–∏—Å—Ç–µ–º—É –ø–æ–¥ —Å–æ–∑–¥–∞–Ω–Ω—ã–º –∞–∫–∫–∞—É–Ω—Ç–æ–º.</p>
            
            <button onclick="loginClient()" disabled id="loginBtn">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
            <div id="loginResult" class="result"></div>
        </div>
    </div>

    <div class="container">
        <div class="step info">
            <h3>üìã –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –õ–ö</h3>
            <p>–ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—è–≤–∏–ª–æ—Å—å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.</p>
            
            <button onclick="checkBookings()" disabled id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
            <div id="checkResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let createdBooking = null;
        let createdClient = null;
        let authToken = null;
        let clientId = null;

        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };

            if (authToken) {
                defaultOptions.headers['Authorization'] = `Bearer ${authToken}`;
            }

            const response = await fetch(API_BASE + url, {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            });

            const data = await response.json();
            return { response, data };
        }

        // –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        async function createGuestBooking() {
            const resultDiv = document.getElementById('bookingResult');
            resultDiv.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...';

            try {
                const bookingData = {
                    booking: {
                        service_category_id: 1,
                        service_point_id: 1,
                        booking_date: '2025-01-15',
                        start_time: '10:00',
                        car_type_id: 1,
                        notes: '–¢–µ—Å—Ç–æ–≤–æ–µ –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ'
                    },
                    service_recipient: {
                        first_name: document.getElementById('firstName').value,
                        last_name: document.getElementById('lastName').value,
                        phone: document.getElementById('phone').value,
                        email: document.getElementById('email').value
                    },
                    car: {
                        license_plate: '–ê–ê1234–í–í',
                        car_brand: 'Toyota',
                        car_model: 'Camry'
                    }
                };

                const { response, data } = await apiRequest('/client_bookings', {
                    method: 'POST',
                    body: JSON.stringify(bookingData)
                });

                if (response.ok) {
                    createdBooking = data;
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ –ì–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!\nID: ${data.id}\n–°—Ç–∞—Ç—É—Å: ${data.status}\n–ö–ª–∏–µ–Ω—Ç ID: ${data.client_id || 'null (–≥–æ—Å—Ç–µ–≤–æ–µ)'}`;
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
                    document.getElementById('registerBtn').disabled = false;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        // –®–∞–≥ 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
        async function registerClient() {
            const resultDiv = document.getElementById('registerResult');
            resultDiv.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞...';

            try {
                const registrationData = {
                    client: {
                        first_name: document.getElementById('firstName').value,
                        last_name: document.getElementById('lastName').value,
                        phone: document.getElementById('phone').value,
                        email: document.getElementById('email').value,
                        password: document.getElementById('password').value
                    }
                };

                const { response, data } = await apiRequest('/clients/register', {
                    method: 'POST',
                    body: JSON.stringify(registrationData)
                });

                if (response.ok) {
                    createdClient = data.client;
                    clientId = data.client.id;
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ –ö–ª–∏–µ–Ω—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!\nID: ${data.client.id}\n–ò–º—è: ${data.client.first_name} ${data.client.last_name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${data.client.phone}`;
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
                    document.getElementById('assignBtn').disabled = false;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        // –®–∞–≥ 3: –ü—Ä–∏–≤—è–∑–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –∫–ª–∏–µ–Ω—Ç—É
        async function assignBookingToClient() {
            const resultDiv = document.getElementById('assignResult');
            resultDiv.textContent = '–ü—Ä–∏–≤—è–∑–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –∫–ª–∏–µ–Ω—Ç—É...';

            try {
                const assignData = {
                    client_id: createdClient.id
                };

                const { response, data } = await apiRequest(`/client_bookings/${createdBooking.id}/assign_to_client`, {
                    method: 'POST',
                    body: JSON.stringify(assignData)
                });

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ –∫ –∫–ª–∏–µ–Ω—Ç—É!\n–°–æ–æ–±—â–µ–Ω–∏–µ: ${data.message}\n–ö–ª–∏–µ–Ω—Ç ID: ${data.booking.client_id}`;
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
                    document.getElementById('loginBtn').disabled = false;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        // –®–∞–≥ 4: –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
        async function loginClient() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.textContent = '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É...';

            try {
                const loginData = {
                    auth: {
                        login: document.getElementById('phone').value,
                        password: document.getElementById('password').value
                    }
                };

                const { response, data } = await apiRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify(loginData)
                });

                if (response.ok) {
                    authToken = data.access_token;
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!\n–¢–æ–∫–µ–Ω: ${data.access_token.substring(0, 20)}...\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.first_name} ${data.user.last_name}\nClient ID: ${data.user.client_id || '–Ω–µ –Ω–∞–π–¥–µ–Ω'}`;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º client_id –∏–∑ –æ—Ç–≤–µ—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    if (data.user.client_id) {
                        clientId = data.user.client_id;
                    }
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
                    document.getElementById('checkBtn').disabled = false;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        // –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –õ–ö
        async function checkBookings() {
            const resultDiv = document.getElementById('checkResult');
            resultDiv.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π...';

            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                const { response: meResponse, data: meData } = await apiRequest('/auth/me');
                
                if (!meResponse.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ');
                }

                const userClientId = meData.client_id || clientId;
                if (!userClientId) {
                    throw new Error('–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞');
                }

                // –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∏–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
                const { response, data } = await apiRequest(`/clients/${userClientId}/bookings`);

                if (response.ok) {
                    const bookings = data.data || data.bookings || data;
                    const foundBooking = Array.isArray(bookings) ? bookings.find(b => b.id === createdBooking.id) : null;
                    
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\nClient ID: ${userClientId}\n–í—Å–µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: ${Array.isArray(bookings) ? bookings.length : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n–ù–∞–π–¥–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: ${foundBooking ? '–î–∞' : '–ù–µ—Ç'}\n\n–û—Ç–≤–µ—Ç API:\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }
    </script>
</body>
</html> 