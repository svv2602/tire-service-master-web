<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∫–∏ - –¢–æ–∫–µ–Ω Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        .code { background: #f5f5f5; padding: 10px; font-family: monospace; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>üîê –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∫–∏ - –¢–æ–∫–µ–Ω Debug</h1>
    
    <div class="test-section">
        <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
        <button onclick="checkAuthState()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
        <div id="auth-state"></div>
    </div>

    <div class="test-section">
        <h3>2. –õ–æ–≥–∏–Ω –∞–¥–º–∏–Ω–∞</h3>
        <button onclick="loginAdmin()">–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω</button>
        <div id="login-result"></div>
    </div>

    <div class="test-section">
        <h3>3. –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∑–∞–ø—Ä–æ—Å–æ–≤</h3>
        <button onclick="testApiWithoutAuth()">API –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
        <button onclick="testApiWithAuth()">API —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π</button>
        <div id="api-test-result"></div>
    </div>

    <div class="test-section">
        <h3>4. –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage –∏ cookies</h3>
        <button onclick="checkStorage()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å storage</button>
        <div id="storage-result"></div>
    </div>

    <script>
        let adminToken = null;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<div class="${className}">${message}</div>`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function checkAuthState() {
            clearLog('auth-state');
            log('auth-state', 'üîç –ü—Ä–æ–≤–µ—Ä—è—é —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...', 'info');
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/auth/me', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(adminToken && { 'Authorization': `Bearer ${adminToken}` })
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log('auth-state', `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${data.email} (${data.role})`, 'success');
                    log('auth-state', `<div class="code">–î–∞–Ω–Ω—ã–µ: ${JSON.stringify(data, null, 2)}</div>`, 'info');
                } else {
                    log('auth-state', `‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${response.status}`, 'error');
                    const errorText = await response.text();
                    log('auth-state', `<div class="code">–û—à–∏–±–∫–∞: ${errorText}</div>`, 'error');
                }
            } catch (error) {
                log('auth-state', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, 'error');
            }
        }

        async function loginAdmin() {
            clearLog('login-result');
            log('login-result', 'üîë –í—ã–ø–æ–ª–Ω—è—é –≤—Ö–æ–¥ –∞–¥–º–∏–Ω–∞...', 'info');
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/auth/login', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@test.com',
                        password: 'admin123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    adminToken = data.token || data.access_token;
                    log('login-result', '‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    log('login-result', `<div class="code">–¢–æ–∫–µ–Ω: ${adminToken ? adminToken.substring(0, 50) + '...' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</div>`, 'info');
                    log('login-result', `<div class="code">–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç: ${JSON.stringify(data, null, 2)}</div>`, 'info');
                } else {
                    log('login-result', `‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${response.status}`, 'error');
                    const errorText = await response.text();
                    log('login-result', `<div class="code">–û—à–∏–±–∫–∞: ${errorText}</div>`, 'error');
                }
            } catch (error) {
                log('login-result', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, 'error');
            }
        }

        async function testApiWithoutAuth() {
            clearLog('api-test-result');
            log('api-test-result', 'üåê –¢–µ—Å—Ç–∏—Ä—É—é API –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...', 'info');
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/service_points', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log('api-test-result', `‚úÖ API –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${data.data.length} —Ç–æ—á–µ–∫`, 'success');
                    data.data.forEach(point => {
                        log('api-test-result', `  ‚Ä¢ ID: ${point.id}, Name: ${point.name}, Status: ${point.work_status}`, 'info');
                    });
                } else {
                    log('api-test-result', `‚ùå –û—à–∏–±–∫–∞ API –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${response.status}`, 'error');
                }
            } catch (error) {
                log('api-test-result', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }

        async function testApiWithAuth() {
            if (!adminToken) {
                log('api-test-result', '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥!', 'warning');
                return;
            }

            log('api-test-result', 'üîê –¢–µ—Å—Ç–∏—Ä—É—é API —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π...', 'info');
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/service_points', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log('api-test-result', `‚úÖ API —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π: ${data.data.length} —Ç–æ—á–µ–∫`, 'success');
                    data.data.forEach(point => {
                        log('api-test-result', `  ‚Ä¢ ID: ${point.id}, Name: ${point.name}, Status: ${point.work_status}`, 'info');
                    });
                } else {
                    log('api-test-result', `‚ùå –û—à–∏–±–∫–∞ API —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π: ${response.status}`, 'error');
                }
            } catch (error) {
                log('api-test-result', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π: ${error.message}`, 'error');
            }
        }

        async function checkStorage() {
            clearLog('storage-result');
            log('storage-result', 'üíæ –ü—Ä–æ–≤–µ—Ä—è—é localStorage –∏ cookies...', 'info');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
            const keys = Object.keys(localStorage);
            log('storage-result', `üì¶ localStorage —Å–æ–¥–µ—Ä–∂–∏—Ç ${keys.length} –∫–ª—é—á–µ–π:`, 'info');
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                const preview = value && value.length > 50 ? value.substring(0, 50) + '...' : value;
                log('storage-result', `  ‚Ä¢ ${key}: ${preview}`, 'info');
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º cookies
            const cookies = document.cookie.split(';').map(c => c.trim()).filter(c => c);
            log('storage-result', `üç™ Cookies —Å–æ–¥–µ—Ä–∂–∞—Ç ${cookies.length} –∑–Ω–∞—á–µ–Ω–∏–π:`, 'info');
            cookies.forEach(cookie => {
                const [name, value] = cookie.split('=');
                const preview = value && value.length > 50 ? value.substring(0, 50) + '...' : value;
                log('storage-result', `  ‚Ä¢ ${name}: ${preview}`, 'info');
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∫–ª—é—á–∏
            const authToken = localStorage.getItem('authToken') || localStorage.getItem('access_token');
            if (authToken) {
                log('storage-result', `üîë –ù–∞–π–¥–µ–Ω —Ç–æ–∫–µ–Ω –≤ localStorage: ${authToken.substring(0, 50)}...`, 'success');
            } else {
                log('storage-result', '‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage', 'warning');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            log('auth-state', 'üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≤—ã–ø–æ–ª–Ω—è—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É...', 'info');
            setTimeout(() => {
                checkAuthState();
                checkStorage();
            }, 1000);
        };
    </script>
</body>
</html> 