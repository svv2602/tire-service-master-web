<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h1>
        
        <div class="step">
            <h3>–®–∞–≥ 1: –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            <button onclick="login()">üîë –í–æ–π—Ç–∏ –∫–∞–∫ admin</button>
            <div id="login-result"></div>
        </div>

        <div class="step">
            <h3>–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage</h3>
            <button onclick="checkLocalStorage()">üì¶ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage</button>
            <div id="storage-result"></div>
        </div>

        <div class="step">
            <h3>–®–∞–≥ 3: –°–∏–º—É–ª—è—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏</h3>
            <button onclick="simulateInit()">üöÄ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é</button>
            <div id="init-result"></div>
        </div>

        <div class="step">
            <h3>–®–∞–≥ 4: –û—á–∏—Å—Ç–∫–∞</h3>
            <button onclick="clearData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            <div id="clear-result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const TOKEN_KEY = 'tvoya_shina_token';
        const USER_KEY = 'tvoya_shina_user';

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}"><pre>${JSON.stringify(message, null, 2)}</pre></div>`;
        }

        async function login() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        auth: {
                            email: 'admin@test.com',
                            password: 'admin'
                        }
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
                    localStorage.setItem(TOKEN_KEY, data.auth_token);
                    localStorage.setItem(USER_KEY, JSON.stringify(data.user));
                    
                    showResult('login-result', {
                        success: true,
                        message: '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ',
                        user: data.user,
                        token_preview: data.auth_token.substring(0, 30) + '...',
                        saved_to_storage: {
                            token: !!localStorage.getItem(TOKEN_KEY),
                            user: !!localStorage.getItem(USER_KEY)
                        }
                    }, 'success');
                } else {
                    showResult('login-result', { error: data }, 'error');
                }
            } catch (error) {
                showResult('login-result', { error: error.message }, 'error');
            }
        }

        function checkLocalStorage() {
            const token = localStorage.getItem(TOKEN_KEY);
            const user = localStorage.getItem(USER_KEY);
            
            const result = {
                token_exists: !!token,
                user_exists: !!user,
                token_preview: token ? token.substring(0, 30) + '...' : null,
                user_preview: user ? JSON.parse(user) : null,
                all_keys: Object.keys(localStorage).filter(key => key.includes('tvoya_shina'))
            };

            const type = (token && user) ? 'success' : 'error';
            showResult('storage-result', result, type);
        }

        async function simulateInit() {
            const token = localStorage.getItem(TOKEN_KEY);
            
            if (!token) {
                showResult('init-result', { error: '–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏' }, 'error');
                return;
            }

            try {
                // –°–∏–º—É–ª–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å getCurrentUser
                const response = await fetch(`${API_BASE}/api/v1/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const userData = await response.json();
                
                if (response.ok) {
                    showResult('init-result', {
                        success: true,
                        message: '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ',
                        endpoint: '/api/v1/users/me',
                        user_data: userData,
                        status: response.status
                    }, 'success');
                } else {
                    showResult('init-result', {
                        error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                        endpoint: '/api/v1/users/me',
                        response: userData,
                        status: response.status
                    }, 'error');
                }
            } catch (error) {
                showResult('init-result', { error: error.message }, 'error');
            }
        }

        function clearData() {
            localStorage.removeItem(TOKEN_KEY);
            localStorage.removeItem(USER_KEY);
            
            showResult('clear-result', {
                message: '–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã',
                remaining_keys: Object.keys(localStorage).filter(key => key.includes('tvoya_shina'))
            }, 'info');
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html> 