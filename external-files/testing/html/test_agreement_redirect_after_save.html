<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .step {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ –¢–µ—Å—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏</h1>
        
        <div class="test-section info">
            <h3>üìã –û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞</h3>
            <p><strong>–¶–µ–ª—å:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–ø–∏—Å–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π.</p>
            <p><strong>–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:</strong></p>
            <ul>
                <li>–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è PATCH –∑–∞–ø—Ä–æ—Å</li>
                <li>–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞"</li>
                <li>–ß–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ <code>/admin/agreements</code></li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üß™ –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            
            <div class="step">
                <h4>1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h4>
                <p>–£–∫–∞–∂–∏—Ç–µ ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</p>
                <div class="form-group">
                    <label>ID –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:</label>
                    <input type="number" id="agreement_id" value="3" min="1">
                </div>
                <button onclick="loadAgreementData()">üìã –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏</button>
            </div>

            <div class="step">
                <h4>2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</h4>
                <p>–ò–∑–º–µ–Ω–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏–º:</p>
                <div class="form-group">
                    <label>–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="new_description" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...">–¢–µ—Å—Ç–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleString()}</textarea>
                </div>
                <button onclick="testAgreementUpdate()">üíæ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç</button>
            </div>

            <div class="step">
                <h4>3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞</h4>
                <p>–≠—Ç–æ—Ç —Ç–µ—Å—Ç —Å–∏–º—É–ª–∏—Ä—É–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ frontend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</p>
                <button onclick="simulateRedirect()">üîÑ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç</button>
                <button onclick="checkCurrentPage()">üìç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                <button onclick="clearResults()" class="danger">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const FRONTEND_BASE = 'http://localhost:3008';
        let currentAgreementData = null;

        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function loadAgreementData() {
            const agreementId = document.getElementById('agreement_id').value;
            
            try {
                addResult('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏', `–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å ID: ${agreementId}`, 'info');
                
                const response = await fetch(`${API_BASE}/agreements/${agreementId}`, {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentAgreementData = result.data;
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
                    const descriptionField = document.getElementById('new_description');
                    descriptionField.value = currentAgreementData.description || '–¢–µ—Å—Ç–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ' + new Date().toLocaleString();
                    
                    const summary = {
                        id: currentAgreementData.id,
                        partner_id: currentAgreementData.partner_id,
                        supplier_id: currentAgreementData.supplier_id,
                        commission_type: currentAgreementData.commission_type,
                        order_types: currentAgreementData.order_types,
                        active: currentAgreementData.active,
                        description: currentAgreementData.description
                    };
                    
                    addResult('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', JSON.stringify(summary, null, 2), 'success');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', JSON.stringify(result, null, 2), 'error');
                }
            } catch (error) {
                addResult('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', error.message, 'error');
            }
        }

        async function testAgreementUpdate() {
            const agreementId = document.getElementById('agreement_id').value;
            const newDescription = document.getElementById('new_description').value;
            
            if (!currentAgreementData) {
                addResult('‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ', '–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏', 'warning');
                return;
            }

            try {
                addResult('üíæ –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º PATCH –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏...', 'info');
                
                const updateData = {
                    agreement: {
                        ...currentAgreementData,
                        description: newDescription
                    }
                };

                const response = await fetch(`${API_BASE}/agreements/${agreementId}`, {
                    method: 'PATCH',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ', JSON.stringify(result.data, null, 2), 'success');
                    
                    // –°–∏–º—É–ª–∏—Ä—É–µ–º –ø–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    addResult('üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ', '–î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                    
                    // –°–∏–º—É–ª–∏—Ä—É–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                    addResult('‚è±Ô∏è –ó–∞–ø—É—Å–∫ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞', '–†–µ–¥–∏—Ä–µ–∫—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É...', 'info');
                    
                    setTimeout(() => {
                        addResult('üîÑ –†–µ–¥–∏—Ä–µ–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω', `–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É: /admin/agreements\n–í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤—ã –±—ã —Å–µ–π—á–∞—Å –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ —Å–ø–∏—Å–æ–∫ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π`, 'success');
                        
                        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –±—ã–ª –±—ã:
                        // navigate('/admin/agreements');
                        
                        // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–∫–∞–∂–µ–º —Å—Å—ã–ª–∫—É
                        const linkDiv = document.createElement('div');
                        linkDiv.className = 'test-section info';
                        linkDiv.innerHTML = `
                            <h3>üîó –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞</h3>
                            <p>–í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Å–µ–π—á–∞—Å –ø—Ä–æ–∏–∑–æ—à–µ–ª –±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞:</p>
                            <p><a href="${FRONTEND_BASE}/admin/agreements" target="_blank">${FRONTEND_BASE}/admin/agreements</a></p>
                            <button onclick="window.open('${FRONTEND_BASE}/admin/agreements', '_blank')">üåê –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π</button>
                        `;
                        document.getElementById('results').appendChild(linkDiv);
                        
                    }, 1000);
                    
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', JSON.stringify(result, null, 2), 'error');
                }
            } catch (error) {
                addResult('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', error.message, 'error');
            }
        }

        function simulateRedirect() {
            addResult('üîÑ –°–∏–º—É–ª—è—Ü–∏—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞', '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è navigate("/admin/agreements")', 'info');
            
            const steps = [
                '1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"',
                '2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è PATCH –∑–∞–ø—Ä–æ—Å –∫ API',
                '3. API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç (200 OK)',
                '4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞"',
                '5. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è setTimeout –Ω–∞ 1000ms',
                '6. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è navigate("/admin/agreements")',
                '7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π'
            ];
            
            steps.forEach((step, index) => {
                setTimeout(() => {
                    addResult(`–®–∞–≥ ${index + 1}`, step, index === steps.length - 1 ? 'success' : 'info');
                }, index * 500);
            });
        }

        function checkCurrentPage() {
            const currentUrl = window.location.href;
            const expectedPattern = '/admin/agreements';
            
            const pageInfo = {
                currentUrl: currentUrl,
                expectedRedirect: FRONTEND_BASE + expectedPattern,
                isCorrectPage: currentUrl.includes(expectedPattern),
                testPage: 'This is a test page, not the actual frontend'
            };
            
            addResult('üìç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ', JSON.stringify(pageInfo, null, 2), 'info');
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            addResult('üöÄ –¢–µ—Å—Ç –≥–æ—Ç–æ–≤', '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'info');
        });
    </script>
</body>
</html>