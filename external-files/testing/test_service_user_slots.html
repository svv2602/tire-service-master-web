<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест API слотов для служебных пользователей</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .results {
            margin-top: 20px;
        }
        .slot {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .slot.available {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .slot.unavailable {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .slot.service-only {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
        .debug {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .debug pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .auth-info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Тест API слотов для служебных пользователей</h1>
    
    <div class="container">
        <h2>Авторизация</h2>
        <div class="auth-info" id="authInfo">
            Статус авторизации: Проверяется...
        </div>
        
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" value="admin@test.com">
        </div>
        <div class="form-group">
            <label for="password">Пароль:</label>
            <input type="password" id="password" value="admin123">
        </div>
        <button onclick="login()">Войти как админ</button>
        <button onclick="checkCurrentUser()">Проверить текущего пользователя</button>
    </div>

    <div class="container">
        <h2>Тест API слотов</h2>
        <div class="form-group">
            <label for="servicePointId">ID сервисной точки:</label>
            <input type="number" id="servicePointId" value="1">
        </div>
        <div class="form-group">
            <label for="date">Дата:</label>
            <input type="date" id="date" value="2025-07-16">
        </div>
        <div class="form-group">
            <label for="categoryId">ID категории:</label>
            <input type="number" id="categoryId" value="1">
        </div>
        <button onclick="testSlotsAPI()">Получить слоты</button>
    </div>

    <div class="container results" id="results" style="display: none;">
        <h2>Результаты</h2>
        <div id="slotsContainer"></div>
    </div>

    <div class="debug" id="debug" style="display: none;">
        <h3>Отладочная информация</h3>
        <pre id="debugContent"></pre>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let currentUser = null;

        // Функция для авторизации
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include', // Важно для cookies
                    body: JSON.stringify({
                        auth: {
                            login: email,
                            password: password
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updateAuthInfo(`Авторизован как: ${data.user.email} (${data.user.role})`);
                    console.log('Авторизация успешна:', data);
                } else {
                    const error = await response.json();
                    updateAuthInfo(`Ошибка авторизации: ${error.message}`);
                    console.error('Ошибка авторизации:', error);
                }
            } catch (error) {
                updateAuthInfo(`Ошибка сети: ${error.message}`);
                console.error('Ошибка сети:', error);
            }
        }

        // Функция для проверки текущего пользователя
        async function checkCurrentUser() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    credentials: 'include',
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user || data;
                    updateAuthInfo(`Текущий пользователь: ${currentUser.email} (${currentUser.role})`);
                    console.log('Текущий пользователь:', currentUser);
                } else {
                    updateAuthInfo('Пользователь не авторизован');
                    currentUser = null;
                }
            } catch (error) {
                updateAuthInfo(`Ошибка проверки: ${error.message}`);
                console.error('Ошибка проверки пользователя:', error);
            }
        }

        // Функция для обновления информации об авторизации
        function updateAuthInfo(message) {
            document.getElementById('authInfo').textContent = message;
        }

        // Функция для тестирования API слотов
        async function testSlotsAPI() {
            const servicePointId = document.getElementById('servicePointId').value;
            const date = document.getElementById('date').value;
            const categoryId = document.getElementById('categoryId').value;

            if (!currentUser) {
                alert('Сначала авторизуйтесь!');
                return;
            }

            try {
                const url = `${API_BASE}/service_points/${servicePointId}/availability/slots_for_category?date=${date}&category_id=${categoryId}`;
                console.log('Запрос к API:', url);

                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayResults(data);
                    showDebugInfo(data);
                } else {
                    const error = await response.json();
                    alert(`Ошибка API: ${error.error}`);
                    console.error('Ошибка API:', error);
                }
            } catch (error) {
                alert(`Ошибка сети: ${error.message}`);
                console.error('Ошибка сети:', error);
            }
        }

        // Функция для отображения результатов
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const slotsContainer = document.getElementById('slotsContainer');
            
            resultsDiv.style.display = 'block';
            
            let html = `
                <p><strong>Сервисная точка:</strong> ${data.service_point_id}</p>
                <p><strong>Дата:</strong> ${data.date}</p>
                <p><strong>Категория:</strong> ${data.category_id}</p>
                <p><strong>Всего слотов:</strong> ${data.total_slots}</p>
                <p><strong>Служебный пользователь:</strong> ${data.is_service_user ? 'Да' : 'Нет'}</p>
                <h3>Слоты:</h3>
            `;

            if (data.slots && data.slots.length > 0) {
                data.slots.forEach(slot => {
                    const isAvailable = slot.available_posts > 0;
                    const isServiceSlot = !isAvailable && data.is_service_user;
                    
                    let slotClass = 'available';
                    if (!isAvailable && !data.is_service_user) {
                        slotClass = 'unavailable';
                    } else if (isServiceSlot) {
                        slotClass = 'service-only';
                    }

                    html += `
                        <div class="slot ${slotClass}">
                            <strong>${slot.start_time} - ${slot.end_time}</strong><br>
                            Доступно постов: ${slot.available_posts} из ${slot.total_posts}<br>
                            Бронирований: ${slot.bookings_count || 0}<br>
                            Доступность: ${slot.is_available ? 'Да' : 'Нет'}<br>
                            Статус загруженности: ${slot.occupancy_status || 'Не указан'}
                        </div>
                    `;
                });
            } else {
                html += '<p>Нет доступных слотов</p>';
            }

            slotsContainer.innerHTML = html;
        }

        // Функция для отображения отладочной информации
        function showDebugInfo(data) {
            const debugDiv = document.getElementById('debug');
            const debugContent = document.getElementById('debugContent');
            
            debugDiv.style.display = 'block';
            debugContent.textContent = JSON.stringify(data, null, 2);
        }

        // Проверяем текущего пользователя при загрузке страницы
        window.onload = function() {
            checkCurrentUser();
        };
    </script>
</body>
</html> 