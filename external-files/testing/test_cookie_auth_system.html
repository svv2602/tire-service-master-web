<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å cookies</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background-color: #f8fff8; }
        .error { border-color: #f44336; background-color: #fff8f8; }
        .info { border-color: #2196F3; background-color: #f8f9ff; }
        .warning { border-color: #ff9800; background-color: #fff8f0; }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .result {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        
        .step-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            display: inline-block;
            margin: 5px 0;
        }
        .status.success { background-color: #4CAF50; color: white; }
        .status.error { background-color: #f44336; color: white; }
        .status.info { background-color: #2196F3; color: white; }
        
        .cookie-info {
            background-color: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å cookies</h1>
        <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å HttpOnly cookies</p>
        
        <!-- –®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
        <div class="test-section info" id="step1">
            <div class="step-title">–®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>
            <div>
                <label>
                    <input type="radio" name="loginType" value="email" checked> Email
                </label>
                <label>
                    <input type="radio" name="loginType" value="phone"> –¢–µ–ª–µ—Ñ–æ–Ω
                </label>
            </div>
            <input type="text" id="login" placeholder="admin@test.com –∏–ª–∏ +380672220000">
            <input type="password" id="password" placeholder="admin123">
            <button onclick="testLogin()">–í–æ–π—Ç–∏</button>
            <div id="loginResult" class="result"></div>
        </div>
        
        <!-- –®–∞–≥ 2: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ cookies -->
        <div class="test-section info" id="step2">
            <div class="step-title">–®–∞–≥ 2: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ cookies</div>
            <button onclick="checkCookies()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å cookies</button>
            <div id="cookieInfo" class="cookie-info"></div>
        </div>
        
        <!-- –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ -->
        <div class="test-section info" id="step3">
            <div class="step-title">–®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞</div>
            <button onclick="testRefreshToken()">–û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
            <div id="refreshResult" class="result"></div>
        </div>
        
        <!-- –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ /auth/me -->
        <div class="test-section info" id="step4">
            <div class="step-title">–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <button onclick="testMe()">–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
            <div id="meResult" class="result"></div>
        </div>
        
        <!-- –®–∞–≥ 5: –í—ã—Ö–æ–¥ -->
        <div class="test-section info" id="step5">
            <div class="step-title">–®–∞–≥ 5: –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</div>
            <button onclick="testLogout()">–í—ã–π—Ç–∏</button>
            <div id="logoutResult" class="result"></div>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="test-section" id="results">
            <div class="step-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
            <div id="testResults"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let currentAccessToken = null;
        let testResults = [];
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç–µ—Å—Ç–∞
        function addResult(test, status, message) {
            testResults.push({ test, status, message });
            updateResultsDisplay();
        }
        
        function updateResultsDisplay() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = testResults.map(result => 
                `<div class="status ${result.status}">${result.test}: ${result.message}</div>`
            ).join('');
        }
        
        // –®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        async function testLogin() {
            const login = document.getElementById('login').value || 'admin@test.com';
            const password = document.getElementById('password').value || 'admin123';
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include', // –í–∞–∂–Ω–æ –¥–ª—è cookies
                    body: JSON.stringify({
                        auth: {
                            login: login,
                            password: password
                        }
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentAccessToken = data.access_token;
                    document.getElementById('loginResult').textContent = 
                        `‚úÖ –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è!\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.first_name} ${data.user.last_name}\n–†–æ–ª—å: ${data.user.role}\nAccess Token: ${data.access_token.substring(0, 50)}...`;
                    document.getElementById('step1').className = 'test-section success';
                    addResult('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'success', '–£—Å–ø–µ—à–Ω–æ');
                } else {
                    document.getElementById('loginResult').textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                    document.getElementById('step1').className = 'test-section error';
                    addResult('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error', data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                document.getElementById('loginResult').textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
                document.getElementById('step1').className = 'test-section error';
                addResult('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error', `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }
        
        // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ cookies
        function checkCookies() {
            const cookies = document.cookie;
            const cookieInfo = document.getElementById('cookieInfo');
            
            if (cookies) {
                const cookieArray = cookies.split(';').map(cookie => cookie.trim());
                const refreshCookie = cookieArray.find(cookie => cookie.startsWith('refresh_token='));
                
                if (refreshCookie) {
                    cookieInfo.innerHTML = `
                        <strong>‚úÖ Refresh token –Ω–∞–π–¥–µ–Ω –≤ cookies:</strong><br>
                        <code>${refreshCookie.substring(0, 100)}...</code><br>
                        <strong>–í—Å–µ cookies:</strong><br>
                        <code>${cookies}</code>
                    `;
                    document.getElementById('step2').className = 'test-section success';
                    addResult('Cookies', 'success', 'Refresh token –Ω–∞–π–¥–µ–Ω');
                } else {
                    cookieInfo.innerHTML = `
                        <strong>‚ö†Ô∏è Refresh token –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ cookies</strong><br>
                        <strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ cookies:</strong><br>
                        <code>${cookies || '–ù–µ—Ç cookies'}</code>
                    `;
                    document.getElementById('step2').className = 'test-section warning';
                    addResult('Cookies', 'error', 'Refresh token –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
            } else {
                cookieInfo.innerHTML = '<strong>‚ùå Cookies –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</strong>';
                document.getElementById('step2').className = 'test-section error';
                addResult('Cookies', 'error', 'Cookies –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            }
        }
        
        // –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
        async function testRefreshToken() {
            try {
                const response = await fetch(`${API_BASE}/auth/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include' // –í–∞–∂–Ω–æ –¥–ª—è cookies
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentAccessToken = data.access_token;
                    document.getElementById('refreshResult').textContent = 
                        `‚úÖ –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω!\n–ù–æ–≤—ã–π Access Token: ${data.access_token.substring(0, 50)}...\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.first_name} ${data.user.last_name}`;
                    document.getElementById('step3').className = 'test-section success';
                    addResult('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞', 'success', '–¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
                } else {
                    document.getElementById('refreshResult').textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                    document.getElementById('step3').className = 'test-section error';
                    addResult('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞', 'error', data.error);
                }
            } catch (error) {
                document.getElementById('refreshResult').textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
                document.getElementById('step3').className = 'test-section error';
                addResult('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞', 'error', `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }
        
        // –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ /auth/me
        async function testMe() {
            if (!currentAccessToken) {
                document.getElementById('meResult').textContent = '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentAccessToken}`,
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('meResult').textContent = 
                        `‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—É—á–µ–Ω!\n${JSON.stringify(data, null, 2)}`;
                    document.getElementById('step4').className = 'test-section success';
                    addResult('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'success', '–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã');
                } else {
                    document.getElementById('meResult').textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                    document.getElementById('step4').className = 'test-section error';
                    addResult('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error', data.error);
                }
            } catch (error) {
                document.getElementById('meResult').textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
                document.getElementById('step4').className = 'test-section error';
                addResult('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error', `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }
        
        // –®–∞–≥ 5: –í—ã—Ö–æ–¥
        async function testLogout() {
            try {
                const response = await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentAccessToken = null;
                    document.getElementById('logoutResult').textContent = `‚úÖ ${data.message}`;
                    document.getElementById('step5').className = 'test-section success';
                    addResult('–í—ã—Ö–æ–¥', 'success', '–£—Å–ø–µ—à–Ω–æ');
                } else {
                    document.getElementById('logoutResult').textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error}`;
                    document.getElementById('step5').className = 'test-section error';
                    addResult('–í—ã—Ö–æ–¥', 'error', data.error);
                }
            } catch (error) {
                document.getElementById('logoutResult').textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
                document.getElementById('step5').className = 'test-section error';
                addResult('–í—ã—Ö–æ–¥', 'error', `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('login').value = 'admin@test.com';
            document.getElementById('password').value = 'admin123';
        });
    </script>
</body>
</html> 