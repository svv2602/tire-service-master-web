<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h1>
    <p><strong>–¶–µ–ª—å:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</p>

    <div class="test-section info">
        <h3>üìã –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
        <ol>
            <li>‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å false)</li>
            <li>‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</li>
            <li>‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</li>
            <li>‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞</li>
            <li>‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ refresh —Ç–æ–∫–µ–Ω–∞</li>
        </ol>
    </div>

    <div class="step">
        <h3>üîç –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <button onclick="checkUserExists()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        <div id="checkUserResult"></div>
    </div>

    <div class="step">
        <h3>üë§ –®–∞–≥ 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞</h3>
        <button onclick="registerClient()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
        <div id="registerResult"></div>
    </div>

    <div class="step">
        <h3>üìÖ –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <button onclick="createBooking()">–°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        <div id="bookingResult"></div>
    </div>

    <div class="step">
        <h3>üìã –®–∞–≥ 4: –ü–æ–ª—É—á–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h3>
        <button onclick="getBookings()">–ü–æ–ª—É—á–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
        <div id="bookingsResult"></div>
    </div>

    <div class="step">
        <h3>üîÑ –®–∞–≥ 5: –¢–µ—Å—Ç refresh —Ç–æ–∫–µ–Ω–∞</h3>
        <button onclick="testRefreshToken()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å refresh</button>
        <div id="refreshResult"></div>
    </div>

    <div class="test-section">
        <h3>üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
        <div id="finalResults"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let testData = {
            user: null,
            client: null,
            tokens: null,
            booking: null
        };

        const testPhone = `38050${Math.floor(Math.random() * 1000000).toString().padStart(7, '0')}`;
        const testEmail = `test${Date.now()}@example.com`;

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function displayResult(elementId, result, stepName) {
            const element = document.getElementById(elementId);
            const className = result.success ? 'success' : 'error';
            
            element.innerHTML = `
                <div class="test-section ${className}">
                    <h4>${result.success ? '‚úÖ' : '‚ùå'} ${stepName}</h4>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${result.status || 'N/A'}</p>
                    <pre>${JSON.stringify(result.data || result.error, null, 2)}</pre>
                </div>
            `;
        }

        async function checkUserExists() {
            console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', testPhone, testEmail);
            
            const result = await apiCall(`/users/check_exists?phone=${testPhone}&email=${testEmail}`);
            displayResult('checkUserResult', result, '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            
            if (result.success && !result.data.exists) {
                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –º–æ–∂–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å');
            }
        }

        async function registerClient() {
            console.log('üë§ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç–∞');
            
            const userData = {
                user: {
                    first_name: "–¢–µ—Å—Ç",
                    last_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                    phone: testPhone,
                    email: testEmail,
                    password: "password123",
                    password_confirmation: "password123"
                }
            };

            const result = await apiCall('/clients/register', {
                method: 'POST',
                body: JSON.stringify(userData)
            });

            displayResult('registerResult', result, '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞');

            if (result.success) {
                testData.user = result.data.user;
                testData.client = result.data.client;
                testData.tokens = result.data.tokens;
                console.log('‚úÖ –ö–ª–∏–µ–Ω—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', testData);
            }
        }

        async function createBooking() {
            if (!testData.tokens) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞!');
                return;
            }

            console.log('üìÖ –°–æ–∑–¥–∞–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ');

            const bookingData = {
                client_booking: {
                    service_point_id: 1,
                    category_id: 1,
                    booking_date: "2025-08-01",
                    booking_time: "10:00",
                    car_brand: "Toyota",
                    car_model: "Camry",
                    car_year: 2020,
                    license_plate: "AA1234BB",
                    client_first_name: testData.user.first_name,
                    client_last_name: testData.user.last_name,
                    client_phone: testData.user.phone,
                    client_email: testData.user.email,
                    service_recipient_first_name: testData.user.first_name,
                    service_recipient_last_name: testData.user.last_name,
                    service_recipient_phone: testData.user.phone,
                    notes: "–¢–µ—Å—Ç–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
                }
            };

            const result = await apiCall('/client_bookings', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${testData.tokens.access}`
                },
                body: JSON.stringify(bookingData)
            });

            displayResult('bookingResult', result, '–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');

            if (result.success) {
                testData.booking = result.data;
                console.log('‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ:', testData.booking);
            }
        }

        async function getBookings() {
            if (!testData.client || !testData.tokens) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞!');
                return;
            }

            console.log('üìã –ü–æ–ª—É—á–∞–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞');

            const result = await apiCall(`/clients/${testData.client.id}/bookings`, {
                headers: {
                    'Authorization': `Bearer ${testData.tokens.access}`
                }
            });

            displayResult('bookingsResult', result, '–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π');
        }

        async function testRefreshToken() {
            console.log('üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º refresh —Ç–æ–∫–µ–Ω');

            const result = await apiCall('/auth/refresh', {
                method: 'POST',
                body: JSON.stringify({})
            });

            displayResult('refreshResult', result, '–¢–µ—Å—Ç refresh —Ç–æ–∫–µ–Ω–∞');
        }

        function updateFinalResults() {
            const results = document.getElementById('finalResults');
            results.innerHTML = `
                <div class="info">
                    <h4>üìä –°–≤–æ–¥–∫–∞:</h4>
                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${testPhone}</p>
                    <p><strong>Email:</strong> ${testEmail}</p>
                    <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID:</strong> ${testData.user?.id || 'N/A'}</p>
                    <p><strong>–ö–ª–∏–µ–Ω—Ç ID:</strong> ${testData.client?.id || 'N/A'}</p>
                    <p><strong>–¢–æ–∫–µ–Ω:</strong> ${testData.tokens?.access ? '–ü–æ–ª—É—á–µ–Ω' : '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
                    <p><strong>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> ${testData.booking ? '–°–æ–∑–¥–∞–Ω–æ' : '–ù–µ —Å–æ–∑–¥–∞–Ω–æ'}</p>
                </div>
            `;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        setInterval(updateFinalResults, 1000);

        // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        console.log(`
üß™ –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ:

1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
2. –ù–∞–∂–∏–º–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
3. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
4. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ —à–∞–≥–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

üìû –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:
- –¢–µ–ª–µ—Ñ–æ–Ω: ${testPhone}
- Email: ${testEmail}

üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- –®–∞–≥ 1: {"exists": false}
- –®–∞–≥ 2: 201 Created —Å —Ç–æ–∫–µ–Ω–∞–º–∏
- –®–∞–≥ 3: 201 Created —Å –¥–∞–Ω–Ω—ã–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- –®–∞–≥ 4: 200 OK —Å–æ —Å–ø–∏—Å–∫–æ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
- –®–∞–≥ 5: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–ª–∏—á–∏—è refresh —Ç–æ–∫–µ–Ω–∞ –≤ cookies
        `);
    </script>
</body>
</html> 