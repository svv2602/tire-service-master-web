<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Google OAuth</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f9f9f9; padding: 10px; border-left: 3px solid #007bff; margin: 10px 0; font-family: monospace; }
        .error { border-left-color: #dc3545; background: #ffebee; }
        .success { border-left-color: #28a745; background: #e8f5e9; }
        .warning { border-left-color: #ffc107; background: #fff8e1; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        #googleButton { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Google OAuth</h1>
        <p><strong>–¢–µ—Å—Ç–∏—Ä—É–µ–º:</strong> –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É Google OAuth —Å Redux –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º</p>
        
        <div class="test-section">
            <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º</h2>
            <button class="btn-warning" onclick="checkCurrentState()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
            <button class="btn-warning" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
            <div id="currentState"></div>
        </div>

        <div class="test-section">
            <h2>2. Google OAuth —Ç–µ—Å—Ç</h2>
            <p><strong>Google Client ID:</strong> <span id="clientId">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</span></p>
            <button class="btn-primary" onclick="initGoogleOAuth()">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Google OAuth</button>
            <div id="googleButton"></div>
            <div id="googleStatus"></div>
        </div>

        <div class="test-section">
            <h2>3. –õ–æ–≥–∏</h2>
            <button class="btn-success" onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        const GOOGLE_CLIENT_ID = '–ó–î–ï–°–¨_–î–û–õ–ñ–ï–ù_–ë–´–¢–¨_–í–ê–®_GOOGLE_CLIENT_ID';
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ message: logEntry, type });
            console.log(logEntry);
            updateLogsDisplay();
        }

        function updateLogsDisplay() {
            const logsContainer = document.getElementById('logs');
            logsContainer.innerHTML = logs.map(entry => 
                `<div class="log ${entry.type}">${entry.message}</div>`
            ).join('');
        }

        function clearLogs() {
            logs = [];
            updateLogsDisplay();
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function checkCurrentState() {
            try {
                log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...', 'info');
                
                const response = await fetch('/api/v1/auth/me', {
                    method: 'GET',
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${data.user.email} (${data.user.role})`, 'success');
                    document.getElementById('currentState').innerHTML = `
                        <div class="log success">
                            <strong>–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:</strong><br>
                            Email: ${data.user.email}<br>
                            –ò–º—è: ${data.user.first_name} ${data.user.last_name}<br>
                            –†–æ–ª—å: ${data.user.role}<br>
                            Client ID: ${data.user.client_id || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
                        </div>
                    `;
                } else {
                    log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', 'warning');
                    document.getElementById('currentState').innerHTML = `
                        <div class="log warning">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
                    `;
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        async function logout() {
            try {
                log('üö™ –í—ã—Ö–æ–¥–∏–º –∏–∑ —Å–∏—Å—Ç–µ–º—ã...', 'info');
                
                const response = await fetch('/api/v1/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    log('‚úÖ –£—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
                    checkCurrentState();
                } else {
                    log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º', 'warning');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ${error.message}`, 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google OAuth
        function initGoogleOAuth() {
            if (!window.google) {
                log('‚ùå Google SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }

            log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Google OAuth...', 'info');
            document.getElementById('clientId').textContent = GOOGLE_CLIENT_ID;

            try {
                window.google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleGoogleCallback,
                    auto_select: false,
                    cancel_on_tap_outside: true,
                    use_fedcm_for_prompt: true
                });

                log('‚úÖ Google OAuth –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É Google
                window.google.accounts.id.renderButton(
                    document.getElementById('googleButton'),
                    {
                        theme: 'outline',
                        size: 'large',
                        text: 'continue_with',
                        locale: 'ru'
                    }
                );

                document.getElementById('googleButton').style.display = 'block';
                document.getElementById('googleStatus').innerHTML = `
                    <div class="log success">Google –∫–Ω–æ–ø–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</div>
                `;

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Google: ${error.message}`, 'error');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Google OAuth callback
        async function handleGoogleCallback(response) {
            log('üéØ Google OAuth callback –ø–æ–ª—É—á–µ–Ω', 'info');
            log(`üìÑ Google credential: ${response.credential ? '–ø–æ–ª—É—á–µ–Ω' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}`, 'info');
            
            try {
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º JWT –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                if (response.credential) {
                    const base64Payload = response.credential.split('.')[1];
                    const decodedPayload = JSON.parse(atob(base64Payload));
                    log(`üë§ Google –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${decodedPayload.email} (${decodedPayload.name})`, 'info');
                    
                    const userInfo = {
                        provider_user_id: decodedPayload.sub,
                        email: decodedPayload.email,
                        first_name: decodedPayload.given_name || decodedPayload.name?.split(' ')[0] || '',
                        last_name: decodedPayload.family_name || decodedPayload.name?.split(' ').slice(1).join(' ') || ''
                    };

                    const requestData = {
                        provider: 'google',
                        token: response.credential,
                        ...userInfo
                    };

                    log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ backend...', 'info');
                    log(`üì§ –î–∞–Ω–Ω—ã–µ: ${JSON.stringify(requestData, null, 2)}`, 'info');

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
                    const apiResponse = await fetch('/api/v1/clients/social_auth', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify(requestData),
                    });

                    log(`üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${apiResponse.status}`, 'info');
                    const data = await apiResponse.json();
                    log(`üì• –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞: ${JSON.stringify(data, null, 2)}`, 'info');

                    if (apiResponse.ok) {
                        log('‚úÖ Google OAuth —É—Å–ø–µ—à–µ–Ω!', 'success');
                        log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.email} (ID: ${data.user.id})`, 'success');
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                        setTimeout(() => {
                            log('üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...', 'info');
                            checkCurrentState();
                        }, 1000);
                        
                    } else {
                        log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${data.error}`, 'error');
                        if (data.details) {
                            log(`üìã –î–µ—Ç–∞–ª–∏: ${data.details}`, 'error');
                        }
                    }
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Google callback: ${error.message}`, 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
            checkCurrentState();
        });
    </script>
</body>
</html> 