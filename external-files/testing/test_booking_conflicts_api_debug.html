<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ API –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1976D2; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #2196F3;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ API –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h1>
        <p>–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–º–æ–∂–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /admin/booking-conflicts</p>
        
        <div class="section">
            <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <div id="results"></div>
        </div>
        
        <div class="section">
            <h3>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <button onclick="testAuth()">1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
            <button onclick="testStatistics()">2. –¢–µ—Å—Ç API —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</button>
            <button onclick="testConflictsList()">3. –¢–µ—Å—Ç API —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤</button>
            <button onclick="testAllAPIs()">4. –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –≤—Å–µ—Ö API</button>
            <button onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let resultDiv = document.getElementById('results');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            resultDiv.appendChild(div);
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        function clearResults() {
            resultDiv.innerHTML = '';
        }

        async function makeRequest(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                ...options
            };

            try {
                log(`üåê –ó–∞–ø—Ä–æ—Å: ${url}`, 'info');
                const response = await fetch(url, defaultOptions);
                
                log(`üì° –°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå –û—à–∏–±–∫–∞: ${errorText}`, 'error');
                    return { error: true, status: response.status, message: errorText };
                }

                const data = await response.json();
                log(`‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã: ${JSON.stringify(data, null, 2)}`, 'success');
                return { error: false, data };
            } catch (error) {
                log(`üí• –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`, 'error');
                return { error: true, message: error.message };
            }
        }

        async function testAuth() {
            log('üîê === –¢–ï–°–¢ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===', 'info');
            
            const result = await makeRequest(`${API_BASE}/auth/me`);
            
            if (result.error) {
                log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', 'error');
                log('üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∫–∞–∫ –∞–¥–º–∏–Ω –Ω–∞ http://localhost:3008/login', 'warning');
                return false;
            } else {
                const user = result.data;
                log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫: ${user.email}`, 'success');
                log(`üë§ –†–æ–ª—å: ${user.role?.name || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`, 'info');
                log(`üîë –ê–¥–º–∏–Ω: ${user.is_admin ? '–î–∞' : '–ù–µ—Ç'}`, user.is_admin ? 'success' : 'warning');
                
                if (!user.is_admin) {
                    log('‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–æ–º', 'warning');
                    log('üí° –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞', 'warning');
                }
                return user.is_admin;
            }
        }

        async function testStatistics() {
            log('üìä === –¢–ï–°–¢ API –°–¢–ê–¢–ò–°–¢–ò–ö–ò ===', 'info');
            
            const result = await makeRequest(`${API_BASE}/booking_conflicts/statistics`);
            
            if (result.error) {
                if (result.status === 401) {
                    log('üîí –û—à–∏–±–∫–∞ 401: –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
                } else if (result.status === 403) {
                    log('üö´ –û—à–∏–±–∫–∞ 403: –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω (–Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞)', 'error');
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ ${result.status}: ${result.message}`, 'error');
                }
                return false;
            } else {
                const stats = result.data.statistics;
                log(`üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞:`, 'success');
                log(`   ‚Ä¢ –í—Å–µ–≥–æ pending: ${stats.total_pending}`, 'info');
                log(`   ‚Ä¢ –ü–æ —Ç–∏–ø–∞–º: ${JSON.stringify(stats.by_type)}`, 'info');
                log(`   ‚Ä¢ –ü–æ —Å—Ç–∞—Ç—É—Å–∞–º: ${JSON.stringify(stats.by_status)}`, 'info');
                return true;
            }
        }

        async function testConflictsList() {
            log('üìã === –¢–ï–°–¢ API –°–ü–ò–°–ö–ê –ö–û–ù–§–õ–ò–ö–¢–û–í ===', 'info');
            
            const result = await makeRequest(`${API_BASE}/booking_conflicts?page=1&per_page=10`);
            
            if (result.error) {
                if (result.status === 401) {
                    log('üîí –û—à–∏–±–∫–∞ 401: –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
                } else if (result.status === 403) {
                    log('üö´ –û—à–∏–±–∫–∞ 403: –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω (–Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞)', 'error');
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ ${result.status}: ${result.message}`, 'error');
                }
                return false;
            } else {
                const response = result.data;
                log(`üìã –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–æ–ª—É—á–µ–Ω:`, 'success');
                log(`   ‚Ä¢ –í—Å–µ–≥–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤: ${response.booking_conflicts?.length || 0}`, 'info');
                log(`   ‚Ä¢ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: ${JSON.stringify(response.meta)}`, 'info');
                
                if (response.booking_conflicts && response.booking_conflicts.length > 0) {
                    log(`   ‚Ä¢ –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç:`, 'info');
                    const first = response.booking_conflicts[0];
                    log(`     - ID: ${first.id}`, 'info');
                    log(`     - –¢–∏–ø: ${first.conflict_type_human}`, 'info');
                    log(`     - –°—Ç–∞—Ç—É—Å: ${first.status_human}`, 'info');
                    log(`     - –ü—Ä–∏—á–∏–Ω–∞: ${first.conflict_reason}`, 'info');
                } else {
                    log(`   ‚ö†Ô∏è –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç (–Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π)`, 'warning');
                }
                return true;
            }
        }

        async function testAllAPIs() {
            log('üöÄ === –ü–û–õ–ù–´–ô –¢–ï–°–¢ –í–°–ï–• API ===', 'info');
            
            const authResult = await testAuth();
            if (!authResult) {
                log('‚ùå –¢–µ—Å—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –Ω–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞', 'error');
                return;
            }
            
            log('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ 1 —Å–µ–∫—É–Ω–¥–∞...', 'info');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testStatistics();
            
            log('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ 1 —Å–µ–∫—É–Ω–¥–∞...', 'info');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testConflictsList();
            
            log('üéâ === –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û ===', 'success');
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            log('üîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...', 'info');
            setTimeout(testAllAPIs, 1000);
        };
    </script>
</body>
</html> 