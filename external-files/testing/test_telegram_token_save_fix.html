<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ Telegram</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #2196F3;
            background-color: #f8f9fa;
        }
        .success { border-left-color: #4CAF50; }
        .error { border-left-color: #f44336; }
        .warning { border-left-color: #ff9800; }
        button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #1976D2; }
        .token-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .result.success { background-color: #d4edda; color: #155724; }
        .result.error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ Telegram</h1>
        
        <div class="test-section">
            <h3>üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</h3>
            <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ Telegram –±–æ—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—ã—Ç–∞–ª–∞—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–µ 429 (Too Many Requests) –∏–∑-–∑–∞ rate limiting –≤ Telegram API.</p>
            
            <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong></p>
            <ul>
                <li>‚úÖ –£–±—Ä–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫</li>
                <li>‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ rate limiting (429)</li>
                <li>‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (5 –º–∏–Ω—É—Ç –≤–º–µ—Å—Ç–æ 1 –º–∏–Ω—É—Ç—ã)</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîß –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞</h3>
            <label for="botToken">–¢–æ–∫–µ–Ω –±–æ—Ç–∞ (—Ñ–æ—Ä–º–∞—Ç: 123456789:ABCDEFghijklmnop):</label>
            <input type="text" id="botToken" class="token-input" 
                   placeholder="8128980955:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw"
                   value="8128980955:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw">
            
            <div>
                <button onclick="testTokenSave()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
                <button onclick="getSettings()">üìñ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button onclick="testWebhookSeparately()">üîó –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook –æ—Ç–¥–µ–ª—å–Ω–æ</button>
            </div>
            
            <div id="saveResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üìä –õ–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <div id="testLog"></div>
        </div>

        <div class="test-section">
            <h3>‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h3>
            <ol>
                <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:8000</li>
                <li>–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (admin@test.com / admin123)</li>
                <li>–ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω" - –¥–æ–ª–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è –ë–ï–ó –ø–æ–ø—ã—Ç–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook</li>
                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ 429</li>
                <li>–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook –æ—Ç–¥–µ–ª—å–Ω–æ"</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `result ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        async function makeRequest(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };
            
            const response = await fetch(url, { ...defaultOptions, ...options });
            const data = await response.json();
            
            log(`${options.method || 'GET'} ${url} - ${response.status}`);
            
            return { response, data };
        }

        async function testTokenSave() {
            const botToken = document.getElementById('botToken').value.trim();
            const resultDiv = document.getElementById('saveResult');
            
            if (!botToken) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞';
                resultDiv.style.display = 'block';
                return;
            }
            
            log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞...', 'info');
            
            try {
                const { response, data } = await makeRequest(`${API_BASE}/telegram_settings`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        telegram_settings: {
                            bot_token: botToken,
                            enabled: true,
                            test_mode: true
                        }
                    })
                });

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!\n${data.message}`;
                    log('‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –±–µ–∑ –æ—à–∏–±–æ–∫ rate limiting', 'success');
                    log('üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ - –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ø—ã—Ç–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook', 'info');
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                    log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${data.message}`, 'error');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`;
                log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`, 'error');
            }
            
            resultDiv.style.display = 'block';
        }

        async function getSettings() {
            log('üìñ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...', 'info');
            
            try {
                const { response, data } = await makeRequest(`${API_BASE}/telegram_settings`);
                
                if (response.ok && data.telegram_settings) {
                    const settings = data.telegram_settings;
                    log(`üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:`, 'success');
                    log(`   - –¢–æ–∫–µ–Ω: ${settings.bot_token ? '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`, 'info');
                    log(`   - –í–∫–ª—é—á–µ–Ω: ${settings.enabled}`, 'info');
                    log(`   - –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: ${settings.test_mode}`, 'info');
                    log(`   - Webhook URL: ${settings.webhook_url || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`, 'info');
                    log(`   - –°—Ç–∞—Ç—É—Å: ${settings.status_text}`, 'info');
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: ${error.message}`, 'error');
            }
        }

        async function testWebhookSeparately() {
            const webhookUrl = 'https://877e149de4f1.ngrok-free.app/api/v1/telegram_webhook';
            log('üîó –¢–µ—Å—Ç–∏—Ä—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É webhook –æ—Ç–¥–µ–ª—å–Ω–æ...', 'info');
            
            try {
                const { response, data } = await makeRequest(`${API_BASE}/telegram_settings/set_webhook`, {
                    method: 'POST',
                    body: JSON.stringify({
                        webhook_url: webhookUrl
                    })
                });

                if (response.ok) {
                    log('‚úÖ Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                } else {
                    if (data.error_code === 429) {
                        log('‚è≥ Rate limiting - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç', 'warning');
                    } else {
                        log(`‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ webhook: ${data.message}`, 'error');
                    }
                }
            } catch (error) {
                log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ webhook: ${error.message}`, 'error');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = () => {
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...', 'info');
            getSettings();
        };
    </script>
</body>
</html>