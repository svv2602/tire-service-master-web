<!DOCTYPE html>
<html>
<head>
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .response { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
    </style>
</head>
<body>
    <h1>üß™ –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç API –ø–æ–∏—Å–∫–∞ —à–∏–Ω</h1>
    <button onclick="testSearch()">–¢–µ—Å—Ç: –º–µ—Ä—Å–µ–¥–µ—Å –∂–ª–µ</button>
    <button onclick="testResolve()">–¢–µ—Å—Ç: resolve –º–æ–¥–µ–ª—å 14114</button>
    
    <div id="results"></div>

    <script>
        async function testSearch() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>‚è≥ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫...</p>';
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/car_tire_search/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: "–º–µ—Ä—Å–µ–¥–µ—Å –∂–ª–µ", locale: "ru" })
                });
                
                const data = await response.json();
                
                let className = 'response ';
                className += data.status === 'success' ? 'success' : 
                           data.status.includes('not_found') ? 'error' : 'warning';
                
                results.innerHTML = `
                    <div class="${className}">
                        <h3>üîç –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ "–º–µ—Ä—Å–µ–¥–µ—Å –∂–ª–µ"</h3>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${data.status}</p>
                        <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${data.message}</p>
                        ${data.models ? `<p><strong>–ú–æ–¥–µ–ª–µ–π –Ω–∞–π–¥–µ–Ω–æ:</strong> ${data.models.length}</p>` : ''}
                        <details>
                            <summary>–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç JSON</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    </div>
                `;
                
                if (data.status === 'model_ambiguous' && data.models) {
                    const modelsHtml = data.models.map(model => 
                        `<button onclick="testResolveModel(${model.id}, '${model.name}')" style="margin: 5px; padding: 10px;">
                            ${model.name} (${model.configs_count} —Ä–∞–∑–º–µ—Ä–æ–≤)
                        </button>`
                    ).join('');
                    
                    results.innerHTML += `
                        <div class="response">
                            <h4>üéØ –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å:</h4>
                            ${modelsHtml}
                        </div>
                    `;
                }
                
            } catch (error) {
                results.innerHTML = `<div class="response error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        async function testResolveModel(modelId, modelName) {
            const results = document.getElementById('results');
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/car_tire_search/resolve_model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_id: modelId, locale: "ru" })
                });
                
                const data = await response.json();
                
                let className = 'response ';
                className += data.status === 'success' ? 'success' : 'error';
                
                results.innerHTML += `
                    <div class="${className}">
                        <h3>üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –º–æ–¥–µ–ª–∏: ${modelName}</h3>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${data.status}</p>
                        <p><strong>–†–∞–∑–º–µ—Ä–æ–≤ —à–∏–Ω:</strong> ${data.tire_sizes?.length || 0}</p>
                        <p><strong>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:</strong> ${data.tire_offers?.length || 0}</p>
                        
                        ${data.tire_sizes ? `
                            <h4>üìè –†–∞–∑–º–µ—Ä—ã –ø–æ –¥–∏–∞–º–µ—Ç—Ä–∞–º:</h4>
                            ${groupSizesByDiameter(data.tire_sizes)}
                        ` : ''}
                        
                        <details>
                            <summary>–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç JSON</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    </div>
                `;
                
            } catch (error) {
                results.innerHTML += `<div class="response error">‚ùå –û—à–∏–±–∫–∞ resolve: ${error.message}</div>`;
            }
        }
        
        function groupSizesByDiameter(tireSizes) {
            const groups = {};
            tireSizes.forEach(size => {
                if (!groups[size.diameter]) groups[size.diameter] = [];
                groups[size.diameter].push(size);
            });
            
            return Object.keys(groups).sort((a, b) => parseInt(a) - parseInt(b))
                .map(diameter => `
                    <div style="border: 1px solid #ddd; margin: 10px; padding: 15px; border-radius: 8px;">
                        <h5>üîò –î–∏–∞–º–µ—Ç—Ä R${diameter} (${groups[diameter].length} —Ä–∞–∑–º–µ—Ä–æ–≤)</h5>
                        ${groups[diameter].map(size => 
                            `<span style="background: #e3f2fd; padding: 5px 10px; margin: 5px; border-radius: 4px; display: inline-block;">
                                ${size.width}/${size.height}R${size.diameter}
                            </span>`
                        ).join('')}
                    </div>
                `).join('');
        }
        
        async function testResolve() {
            await testResolveModel(14114, 'GLE-Class');
        }
    </script>
</body>
</html>