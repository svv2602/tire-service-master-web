<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ Telegram</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #2196F3;
            background-color: #f8f9fa;
        }
        .success { border-left-color: #4CAF50; }
        .error { border-left-color: #f44336; }
        .warning { border-left-color: #ff9800; }
        button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #1976D2; }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .result.success { background-color: #d4edda; color: #155724; }
        .result.error { background-color: #f8d7da; color: #721c24; }
        .result.warning { background-color: #fff3cd; color: #856404; }
        .code {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            border: 1px solid #dee2e6;
        }
        .field-test {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .field-name {
            font-weight: bold;
            min-width: 150px;
        }
        .field-value {
            flex: 1;
            font-family: monospace;
            background-color: white;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .field-status {
            padding: 5px 10px;
            border-radius: 3px;
            color: white;
            font-size: 12px;
        }
        .field-status.ok { background-color: #28a745; }
        .field-status.error { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ Telegram</h1>
        
        <div class="test-section">
            <h3>üìã –û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π</h3>
            <p><strong>–ü—Ä–æ–±–ª–µ–º—ã:</strong></p>
            <ul>
                <li>‚ùå –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è (–±—ã–ª –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ "8128980955:...")</li>
                <li>‚ùå Admin Chat ID –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è –∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è</li>
                <li>‚ùå –ù–µ –±—ã–ª–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–≤–∏–¥–µ—Ç—å –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω</li>
            </ul>
            
            <p><strong>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</strong></p>
            <ul>
                <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä show_full_token –¥–ª—è –∞–¥–º–∏–Ω–æ–≤</li>
                <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è —Ç–æ–∫–µ–Ω–∞</li>
                <li>‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π</li>
                <li>‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ Admin Chat ID</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API</h3>
            <button onclick="testApiWithoutFullToken()">üì° –¢–µ—Å—Ç API –±–µ–∑ full_token</button>
            <button onclick="testApiWithFullToken()">üîì –¢–µ—Å—Ç API —Å full_token</button>
            <button onclick="testSaveSettings()">üíæ –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫</button>
            <button onclick="clearResults()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
            
            <div id="apiResults"></div>
        </div>

        <div class="test-section">
            <h3>üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π</h3>
            <div id="fieldsCheck">
                <div class="field-test">
                    <div class="field-name">Bot Token:</div>
                    <div class="field-value" id="botTokenValue">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="field-status" id="botTokenStatus">‚è≥</div>
                </div>
                <div class="field-test">
                    <div class="field-name">Admin Chat ID:</div>
                    <div class="field-value" id="adminChatIdValue">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="field-status" id="adminChatIdStatus">‚è≥</div>
                </div>
                <div class="field-test">
                    <div class="field-name">Bot Username:</div>
                    <div class="field-value" id="botUsernameValue">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="field-status" id="botUsernameStatus">‚è≥</div>
                </div>
            </div>
        </div>

        <div class="test-section warning">
            <h3>‚ö†Ô∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</h3>
            <ol>
                <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</li>
                <li>–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É <code>/admin/notifications/telegram</code></li>
                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª–µ "Bot Token" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ç–æ–∫–µ–Ω (–Ω–µ –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)</li>
                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–Ω–æ–ø–∫—É –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è —Ç–æ–∫–µ–Ω–∞ (–≥–ª–∞–∑)</li>
                <li>–í–≤–µ–¥–∏—Ç–µ Admin Chat ID –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</li>
                <li>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Chat ID –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üîç –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ</h3>
            
            <h4>‚úÖ –¢–æ–∫–µ–Ω –±–æ—Ç–∞:</h4>
            <div class="code">
// –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
bot_token: "8128980955:..."

// –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
bot_token: "8128980955:AAFO43qP_B_nG61gYktAJv3EESR7d8kxsEs"
            </div>

            <h4>‚úÖ Admin Chat ID:</h4>
            <div class="code">
// –î–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è:
admin_chat_id: "123456789"
            </div>

            <h4>‚úÖ UI —É–ª—É—á—à–µ–Ω–∏—è:</h4>
            <ul>
                <li>–ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è —Ç–æ–∫–µ–Ω–∞ (–≥–ª–∞–∑)</li>
                <li>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π</li>
                <li>–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π</li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('apiResults');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `result ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            resultsDiv.appendChild(logEntry);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        async function makeRequest(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };
            
            try {
                const response = await fetch(url, { ...defaultOptions, ...options });
                const data = await response.json();
                return { response, data, error: null };
            } catch (error) {
                return { response: null, data: null, error };
            }
        }

        async function testApiWithoutFullToken() {
            log('üîí –¢–µ—Å—Ç–∏—Ä—É–µ–º API –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ show_full_token...', 'info');
            
            const { response, data, error } = await makeRequest(`${API_BASE}/telegram_settings`);
            
            if (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
                return;
            }
            
            if (response.ok && data.telegram_settings) {
                const settings = data.telegram_settings;
                log(`üìä –¢–æ–∫–µ–Ω (–∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π): ${settings.bot_token || 'null'}`, 'info');
                log(`üìä Admin Chat ID: ${settings.admin_chat_id || 'null'}`, 'info');
                
                if (settings.bot_token && settings.bot_token.includes('...')) {
                    log('‚úÖ –¢–æ–∫–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏', 'success');
                } else {
                    log('‚ö†Ô∏è –¢–æ–∫–µ–Ω –Ω–µ –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 'warning');
                }
            } else {
                log(`‚ùå –û—à–∏–±–∫–∞ API: ${response.status}`, 'error');
            }
        }

        async function testApiWithFullToken() {
            log('üîì –¢–µ—Å—Ç–∏—Ä—É–µ–º API —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º show_full_token=true...', 'info');
            
            const { response, data, error } = await makeRequest(`${API_BASE}/telegram_settings?show_full_token=true`);
            
            if (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
                return;
            }
            
            if (response.ok && data.telegram_settings) {
                const settings = data.telegram_settings;
                log(`üìä –¢–æ–∫–µ–Ω (–ø–æ–ª–Ω—ã–π): ${settings.bot_token || 'null'}`, 'info');
                log(`üìä Admin Chat ID: ${settings.admin_chat_id || 'null'}`, 'info');
                
                updateFieldDisplay('botTokenValue', settings.bot_token);
                updateFieldDisplay('adminChatIdValue', settings.admin_chat_id);
                updateFieldDisplay('botUsernameValue', settings.bot_username);
                
                updateFieldStatus('botTokenStatus', settings.bot_token && !settings.bot_token.includes('...'));
                updateFieldStatus('adminChatIdStatus', !!settings.admin_chat_id);
                updateFieldStatus('botUsernameStatus', !!settings.bot_username);
                
                if (settings.bot_token && !settings.bot_token.includes('...')) {
                    log('‚úÖ –ü–æ–ª–Ω—ã–π —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                } else {
                    log('‚ùå –ü–æ–ª–Ω—ã–π —Ç–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω', 'error');
                }
            } else {
                log(`‚ùå –û—à–∏–±–∫–∞ API: ${response.status}`, 'error');
            }
        }

        async function testSaveSettings() {
            log('üíæ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫...', 'info');
            
            const testData = {
                admin_chat_id: '123456789',
                test_mode: true
            };
            
            const { response, data, error } = await makeRequest(`${API_BASE}/telegram_settings`, {
                method: 'PATCH',
                body: JSON.stringify({ telegram_settings: testData })
            });
            
            if (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
                return;
            }
            
            if (response.ok) {
                log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                log(`üìä –û—Ç–≤–µ—Ç: ${data.message}`, 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å
                setTimeout(() => testApiWithFullToken(), 1000);
            } else {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${response.status}`, 'error');
                if (data.errors) {
                    log(`üìã –û—à–∏–±–∫–∏: ${data.errors.join(', ')}`, 'error');
                }
            }
        }

        function updateFieldDisplay(elementId, value) {
            const element = document.getElementById(elementId);
            element.textContent = value || '–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û';
        }

        function updateFieldStatus(elementId, isOk) {
            const element = document.getElementById(elementId);
            element.textContent = isOk ? 'OK' : 'ERROR';
            element.className = `field-status ${isOk ? 'ok' : 'error'}`;
        }

        function clearResults() {
            document.getElementById('apiResults').innerHTML = '';
            
            // –°–±—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–ª–µ–π
            ['botTokenValue', 'adminChatIdValue', 'botUsernameValue'].forEach(id => {
                document.getElementById(id).textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            });
            
            ['botTokenStatus', 'adminChatIdStatus', 'botUsernameStatus'].forEach(id => {
                const element = document.getElementById(id);
                element.textContent = '‚è≥';
                element.className = 'field-status';
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ Telegram...', 'info');
            setTimeout(() => testApiWithFullToken(), 1000);
        };
    </script>
</body>
</html>