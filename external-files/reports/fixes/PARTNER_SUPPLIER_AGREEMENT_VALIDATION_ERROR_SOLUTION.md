# üö® –†–ï–®–ï–ù–ò–ï: –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–º

## üìä –°—Ç–∞—Ç—É—Å: ‚úÖ –ü–†–û–ë–õ–ï–ú–ê –î–ò–ê–ì–ù–û–°–¢–ò–†–û–í–ê–ù–ê

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå **–û—à–∏–±–∫–∞:** HTTP 422 Unprocessable Content
```
POST http://localhost:8000/api/v1/partner_supplier_agreements 422 (Unprocessable Content)
```

### üïµÔ∏è **–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
–£ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ ID=6 —Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–º ID=6 —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –î–í–ï –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:

```
ID: 2, Partner: 6, Supplier: 6, OrderTypes: cart_orders (–∑–∞–∫–∞–∑—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã)
ID: 3, Partner: 6, Supplier: 6, OrderTypes: pickup_orders (–∑–∞–∫–∞–∑—ã –≤—ã–¥–∞—á–∏)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ —Ç–∏–ø—ã –∑–∞–∫–∞–∑–æ–≤ —É–∂–µ –ø–æ–∫—Ä—ã—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—è–º–∏!

## üîß –õ–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### üìã –ü—Ä–∞–≤–∏–ª–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ (–∏–∑ `partner_supplier_agreement.rb`):
```ruby
# –í–∞–ª–∏–¥–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –ø–æ —Ç–∏–ø–∞–º –∑–∞–∫–∞–∑–æ–≤
def unique_active_agreement_per_order_type
  # –ù–∞—Ö–æ–¥–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º –∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–º
  existing_agreements = PartnerSupplierAgreement
    .where(partner_id: partner_id, supplier_id: supplier_id, active: true)
    .where.not(id: id)
    
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –∑–∞–∫–∞–∑–æ–≤
  if order_types_overlap?(current_order_types, existing_order_types)
    errors.add(:order_types, "–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å...")
  end
end
```

### üö´ **–ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:**
1. **cart_orders** + **cart_orders** ‚ùå
2. **pickup_orders** + **pickup_orders** ‚ùå  
3. **both** + **–ª—é–±–æ–π —Ç–∏–ø** ‚ùå
4. **cart_orders + pickup_orders** = –ø–æ–∫—Ä—ã–≤–∞—é—Ç **both** ‚ùå

## üí° –†–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã

### ‚úÖ **–í–∞—Ä–∏–∞–Ω—Ç 1: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å**
```bash
# –í–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π - –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ ID=2 –∏–ª–∏ ID=3
PUT /api/v1/partner_supplier_agreements/2
PUT /api/v1/partner_supplier_agreements/3
```

### ‚úÖ **–í–∞—Ä–∏–∞–Ω—Ç 2: –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏**
```bash
# –°–Ω–∞—á–∞–ª–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
PATCH /api/v1/partner_supplier_agreements/2 {"active": false}
PATCH /api/v1/partner_supplier_agreements/3 {"active": false}

# –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é
POST /api/v1/partner_supplier_agreements {"order_types": "both"}
```

### ‚úÖ **–í–∞—Ä–∏–∞–Ω—Ç 3: –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –∏–ª–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞**
```bash
# –°–æ–∑–¥–∞–π—Ç–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Å –¥—Ä—É–≥–æ–π –ø–∞—Ä–æ–π
POST /api/v1/partner_supplier_agreements {
  "partner_id": 7,    # –î—Ä—É–≥–æ–π –ø–∞—Ä—Ç–Ω–µ—Ä
  "supplier_id": 6,   # –¢–æ—Ç –∂–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫
  "order_types": "both"
}
```

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è UI

### üìù **–£–ª—É—á—à–µ–Ω–∏–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º** - –∑–∞–ø—Ä–æ—Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π
2. **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** - –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
3. **–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π** - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å/–≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ

### üîç **–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º:**
```typescript
// 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
const existingAgreements = await getAgreements({
  partner_id: formData.partner_id,
  supplier_id: formData.supplier_id,
  active: true
});

// 2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
const hasConflict = checkOrderTypesConflict(
  existingAgreements, 
  formData.order_types
);

// 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ —Ä–µ—à–µ–Ω–∏—è
if (hasConflict) {
  showConflictResolutionDialog({
    existing: existingAgreements,
    proposed: formData,
    actions: ['edit', 'deactivate', 'change_partner']
  });
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è

### ‚úÖ **–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
rails runner "PartnerSupplierAgreement.active.each { |a| puts \"ID: #{a.id}, Partner: #{a.partner_id}, Supplier: #{a.supplier_id}, OrderTypes: #{a.order_types}\" }"

# –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å
rails runner "PartnerSupplierAgreement.find(2).update(active: false)"

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —á–µ—Ä–µ–∑ API
curl -X POST "http://localhost:8000/api/v1/partner_supplier_agreements" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"partner_supplier_agreement": {"partner_id": 6, "supplier_id": 6, "order_types": "both", "commission_type": "percentage", "commission_percentage": 5, "start_date": "2025-01-01", "active": true}}'
```

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π

### üìà **–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- **–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö:** 2 –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
- **–ü–∞—Ä—Ç–Ω–µ—Ä 6 + –ü–æ—Å—Ç–∞–≤—â–∏–∫ 6:** 100% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–∏–ø–æ–≤ –∑–∞–∫–∞–∑–æ–≤
- **–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è:** 0 –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤

### üéØ **–ü–æ—Å–ª–µ —Ä–µ—à–µ–Ω–∏—è:**
- **–í–∞—Ä–∏–∞–Ω—Ç 1 (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):** 2 –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)
- **–í–∞—Ä–∏–∞–Ω—Ç 2 (–∑–∞–º–µ–Ω–∞):** 1 –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å (both)  
- **–í–∞—Ä–∏–∞–Ω—Ç 3 (–Ω–æ–≤—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä):** 3+ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:**
- [ ] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç —Ä–µ—à–µ–Ω–∏—è –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏

### 2. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ UI
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–∏–∞–ª–æ–≥ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- [ ] –£–ª—É—á—à–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### 3. **UX —É–ª—É—á—à–µ–Ω–∏—è:**
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π
- [ ] –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è, –∑–∞–º–µ–Ω–∞)

---

**üìÖ –î–∞—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:** 10 —è–Ω–≤–∞—Ä—è 2025  
**üîß –°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ—à–µ–Ω–∏—è  
**üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–±—Ä–∞—Ç—å –í–∞—Ä–∏–∞–Ω—Ç 2 (–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è + —Å–æ–∑–¥–∞–Ω–∏–µ both)

**–ü—Ä–æ–±–ª–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–µ—à–µ–Ω–∏—é! üéâ**