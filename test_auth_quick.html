<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; }
        .success { background: #4caf50; color: white; }
        .error { background: #f44336; color: white; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîê –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h1>
    
    <div>
        <button onclick="login()" class="success">üîë –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        <button onclick="checkToken()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
        <button onclick="testAPI()">üß™ –¢–µ—Å—Ç API</button>
        <button onclick="clearAuth()" class="error">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    
    <div>
        <h3>–°—Ç–∞—Ç—É—Å:</h3>
        <div id="status"></div>
    </div>
    
    <div>
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
        <pre id="result"></pre>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const TOKEN_KEY = 'tvoya_shina_token';

        function log(message, isError = false) {
            document.getElementById('status').innerHTML = 
                `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
        }

        function showResult(data) {
            document.getElementById('result').textContent = JSON.stringify(data, null, 2);
        }

        async function login() {
            try {
                log('üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ö–æ–¥...');
                
                const response = await fetch(`${API_BASE}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        auth: {
                            login: 'admin@test.com',
                            password: 'admin123'
                        }
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.tokens?.access) {
                    localStorage.setItem(TOKEN_KEY, data.tokens.access);
                    localStorage.setItem('tvoya_shina_user', JSON.stringify(data.user));
                    log('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    showResult({
                        success: true,
                        user: data.user,
                        tokenSaved: !!localStorage.getItem(TOKEN_KEY)
                    });
                } else {
                    log('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', true);
                    showResult(data);
                }
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', true);
                showResult({ error: error.message });
            }
        }

        function checkToken() {
            const token = localStorage.getItem(TOKEN_KEY);
            const user = localStorage.getItem('tvoya_shina_user');
            
            if (token) {
                log('‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω');
                showResult({
                    hasToken: true,
                    hasUser: !!user,
                    tokenPreview: token.substring(0, 20) + '...',
                    allKeys: Object.keys(localStorage).filter(k => k.includes('tvoya_shina'))
                });
            } else {
                log('‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω', true);
                showResult({ hasToken: false });
            }
        }

        async function testAPI() {
            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', true);
                return;
            }

            try {
                log('üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º API...');
                
                const response = await fetch(`${API_BASE}/api/v1/service_categories`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                
                if (response.ok) {
                    log('‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç!');
                    showResult({
                        success: true,
                        categoriesCount: data.data?.length || 0,
                        response: data
                    });
                } else {
                    log('‚ùå –û—à–∏–±–∫–∞ API', true);
                    showResult(data);
                }
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', true);
                showResult({ error: error.message });
            }
        }

        function clearAuth() {
            localStorage.removeItem(TOKEN_KEY);
            localStorage.removeItem('tvoya_shina_user');
            log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
            showResult({ cleared: true });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            checkToken();
        };
    </script>
</body>
</html>
