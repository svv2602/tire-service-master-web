<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
        }
        .diagnostic-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
        
        .test-result {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 12px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            border-radius: 4px;
        }
        .test-result.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .test-result.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background 0.2s;
        }
        button:hover { background: #0056b3; }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover { background: #545b62; }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="diagnostic-card">
        <h1>üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h1>
        <p>–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ API –∑–∞–ø—Ä–æ—Å–æ–≤</p>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        
        <div id="overall-status" class="test-result">
            –ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        </div>
    </div>

    <div class="test-grid">
        <div class="diagnostic-card">
            <h3>üîê –¢–µ—Å—Ç –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            <button onclick="runAuthTest()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
            <button onclick="clearAuthData()" class="secondary">–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            <div id="auth-result" class="test-result"></div>
        </div>

        <div class="diagnostic-card">
            <h3>üìã –¢–µ—Å—Ç API –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h3>
            <button onclick="runBookingsTest()">–¢–µ—Å—Ç /api/v1/bookings</button>
            <button onclick="runDetailedBookingsTest()">–î–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç</button>
            <div id="bookings-result" class="test-result"></div>
        </div>

        <div class="diagnostic-card">
            <h3>üç™ –¢–µ—Å—Ç Cookie –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h3>
            <button onclick="runCookieTest()">–¢–µ—Å—Ç HttpOnly cookies</button>
            <button onclick="runRefreshTest()">–¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞</button>
            <div id="cookie-result" class="test-result"></div>
        </div>

        <div class="diagnostic-card">
            <h3>üîÑ –¢–µ—Å—Ç Redux —Å–æ—Å—Ç–æ—è–Ω–∏—è</h3>
            <button onclick="simulateReduxFlow()">–°–∏–º—É–ª—è—Ü–∏—è Redux</button>
            <button onclick="checkFrontendState()">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è</button>
            <div id="redux-result" class="test-result"></div>
        </div>

        <div class="diagnostic-card">
            <h3>üåê –¢–µ—Å—Ç CORS –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤</h3>
            <button onclick="runCORSTest()">–ü—Ä–æ–≤–µ—Ä–∫–∞ CORS</button>
            <button onclick="runHeadersTest()">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤</button>
            <div id="cors-result" class="test-result"></div>
        </div>

        <div class="diagnostic-card">
            <h3>üñ•Ô∏è –°—Å—ã–ª–∫–∏ –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h3>
            <button onclick="openAdminInterface()">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</button>
            <button onclick="openClientInterface()">–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</button>
            <div id="interface-result" class="test-result"></div>
        </div>
    </div>

    <div class="diagnostic-card">
        <h2>üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç</h2>
        <button onclick="runFullDiagnostic()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
        <button onclick="exportReport()" class="secondary">–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞</button>
        <div id="full-report" class="test-result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const FRONTEND_BASE = 'http://localhost:3008';
        const TOKEN_KEY = 'tvoya_shina_token';
        const USER_KEY = 'tvoya_shina_user';
        
        let diagnosticResults = {
            auth: null,
            bookings: null,
            cookies: null,
            redux: null,
            cors: null
        };
        
        let currentStep = 0;
        const totalSteps = 5;

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progress').style.width = progress + '%';
        }

        function logResult(elementId, result, status = 'info') {
            const element = document.getElementById(elementId);
            element.className = `test-result ${status}`;
            
            const timestamp = new Date().toLocaleTimeString();
            let output = `[${timestamp}] `;
            
            if (typeof result === 'object') {
                output += JSON.stringify(result, null, 2);
            } else {
                output += result;
            }
            
            element.textContent = output;
            return result;
        }

        function updateOverallStatus(message, status = 'info') {
            const element = document.getElementById('overall-status');
            element.className = `test-result ${status}`;
            element.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        }

        // === –¢–ï–°–¢ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===
        async function runAuthTest() {
            try {
                updateOverallStatus('–¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...', 'info');
                
                // –®–∞–≥ 1: –õ–æ–≥–∏–Ω
                const loginResponse = await fetch(`${API_BASE}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: 'admin@test.com',
                        password: 'admin123'
                    })
                });

                const loginData = await loginResponse.json();
                
                if (!loginResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${loginData.error || loginResponse.statusText}`);
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
                if (loginData.tokens?.access) {
                    localStorage.setItem(TOKEN_KEY, loginData.tokens.access);
                }
                if (loginData.user) {
                    localStorage.setItem(USER_KEY, JSON.stringify(loginData.user));
                }

                // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ /auth/me
                const meResponse = await fetch(`${API_BASE}/api/v1/auth/me`, {
                    credentials: 'include'
                });
                
                const meData = await meResponse.json();

                const result = {
                    login: {
                        success: loginResponse.ok,
                        hasTokens: !!loginData.tokens,
                        hasUser: !!loginData.user,
                        user: loginData.user
                    },
                    authMe: {
                        success: meResponse.ok,
                        user: meData.user || meData
                    },
                    localStorage: {
                        token: !!localStorage.getItem(TOKEN_KEY),
                        user: !!localStorage.getItem(USER_KEY)
                    }
                };

                diagnosticResults.auth = result;
                currentStep = 1;
                updateProgress();
                
                logResult('auth-result', result, loginResponse.ok && meResponse.ok ? 'success' : 'error');
                updateOverallStatus('–¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω', loginResponse.ok && meResponse.ok ? 'success' : 'error');
                
            } catch (error) {
                const errorResult = { error: error.message };
                diagnosticResults.auth = errorResult;
                logResult('auth-result', errorResult, 'error');
                updateOverallStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
            }
        }

        // === –¢–ï–°–¢ API –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ô ===
        async function runBookingsTest() {
            try {
                updateOverallStatus('–¢–µ—Å—Ç–∏—Ä—É–µ–º API –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π...', 'info');
                
                const token = localStorage.getItem(TOKEN_KEY);
                if (!token) {
                    throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.');
                }

                // –¢–µ—Å—Ç —Å Bearer —Ç–æ–∫–µ–Ω–æ–º
                const bearerResponse = await fetch(`${API_BASE}/api/v1/bookings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const bearerData = await bearerResponse.json();

                // –¢–µ—Å—Ç —Ç–æ–ª—å–∫–æ —Å cookies
                const cookieResponse = await fetch(`${API_BASE}/api/v1/bookings`, {
                    credentials: 'include'
                });

                const cookieData = await cookieResponse.json();

                const result = {
                    withBearerToken: {
                        success: bearerResponse.ok,
                        status: bearerResponse.status,
                        hasData: !!bearerData.data,
                        count: bearerData.data?.length || 0,
                        totalCount: bearerData.pagination?.total_count || 0
                    },
                    withCookiesOnly: {
                        success: cookieResponse.ok,
                        status: cookieResponse.status,
                        hasData: !!cookieData.data,
                        count: cookieData.data?.length || 0,
                        totalCount: cookieData.pagination?.total_count || 0
                    },
                    comparison: {
                        bothWork: bearerResponse.ok && cookieResponse.ok,
                        sameResults: (bearerData.data?.length || 0) === (cookieData.data?.length || 0)
                    }
                };

                diagnosticResults.bookings = result;
                currentStep = 2;
                updateProgress();
                
                logResult('bookings-result', result, 
                    (bearerResponse.ok || cookieResponse.ok) ? 'success' : 'error');
                updateOverallStatus('–¢–µ—Å—Ç API –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω', 
                    (bearerResponse.ok || cookieResponse.ok) ? 'success' : 'error');
                
            } catch (error) {
                const errorResult = { error: error.message };
                diagnosticResults.bookings = errorResult;
                logResult('bookings-result', errorResult, 'error');
                updateOverallStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ API –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π', 'error');
            }
        }

        // === –î–ï–¢–ê–õ–¨–ù–´–ô –¢–ï–°–¢ –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ô ===
        async function runDetailedBookingsTest() {
            try {
                const token = localStorage.getItem(TOKEN_KEY);
                if (!token) {
                    throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.');
                }

                // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                const tests = [
                    { name: '–ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å', url: '/api/v1/bookings' },
                    { name: '–° –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π', url: '/api/v1/bookings?page=1&per_page=5' },
                    { name: '–° —Ñ–∏–ª—å—Ç—Ä–æ–º', url: '/api/v1/bookings?status=pending' },
                    { name: '–ü–æ–∏—Å–∫', url: '/api/v1/bookings?query=test' }
                ];

                const results = {};
                
                for (const test of tests) {
                    const response = await fetch(`${API_BASE}${test.url}`, {
                        headers: { 'Authorization': `Bearer ${token}` },
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    
                    results[test.name] = {
                        success: response.ok,
                        status: response.status,
                        count: data.data?.length || 0,
                        pagination: data.pagination
                    };
                }

                logResult('bookings-result', results, 'success');
                
            } catch (error) {
                logResult('bookings-result', { error: error.message }, 'error');
            }
        }

        // === –¢–ï–°–¢ COOKIES ===
        async function runCookieTest() {
            try {
                updateOverallStatus('–¢–µ—Å—Ç–∏—Ä—É–µ–º Cookie –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é...', 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ API —Ç–æ–ª—å–∫–æ —Å cookies
                const response = await fetch(`${API_BASE}/api/v1/auth/me`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                const result = {
                    cookieAuth: {
                        success: response.ok,
                        status: response.status,
                        user: data.user || data
                    },
                    visibleCookies: document.cookie || '–Ω–µ—Ç –≤–∏–¥–∏–º—ã—Ö cookies',
                    httpOnlyNote: 'HttpOnly cookies –Ω–µ –≤–∏–¥–Ω—ã –∏–∑ JavaScript (—ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)'
                };

                diagnosticResults.cookies = result;
                currentStep = 3;
                updateProgress();
                
                logResult('cookie-result', result, response.ok ? 'success' : 'error');
                updateOverallStatus('–¢–µ—Å—Ç Cookie –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω', response.ok ? 'success' : 'error');
                
            } catch (error) {
                const errorResult = { error: error.message };
                diagnosticResults.cookies = errorResult;
                logResult('cookie-result', errorResult, 'error');
                updateOverallStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ cookies', 'error');
            }
        }

        // === –¢–ï–°–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø –¢–û–ö–ï–ù–ê ===
        async function runRefreshTest() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/refresh`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.tokens?.access) {
                    localStorage.setItem(TOKEN_KEY, data.tokens.access);
                }

                logResult('cookie-result', {
                    refresh: {
                        success: response.ok,
                        hasNewToken: !!data.tokens?.access,
                        data: data
                    }
                }, response.ok ? 'success' : 'error');
                
            } catch (error) {
                logResult('cookie-result', { refreshError: error.message }, 'error');
            }
        }

        // === –°–ò–ú–£–õ–Ø–¶–ò–Ø REDUX ===
        function simulateReduxFlow() {
            const token = localStorage.getItem(TOKEN_KEY);
            const userStr = localStorage.getItem(USER_KEY);
            
            try {
                const user = userStr ? JSON.parse(userStr) : null;
                
                // –°–∏–º—É–ª–∏—Ä—É–µ–º Redux state
                const mockReduxState = {
                    auth: {
                        accessToken: token,
                        refreshToken: null, // –í HttpOnly cookies
                        user: user,
                        isAuthenticated: !!(token && user),
                        loading: false,
                        error: null,
                        isInitialized: true
                    }
                };
                
                // –°–∏–º—É–ª–∏—Ä—É–µ–º prepareHeaders –∏–∑ baseApi
                const mockHeaders = {};
                if (token) {
                    mockHeaders['Authorization'] = `Bearer ${token}`;
                }
                
                const result = {
                    reduxState: mockReduxState,
                    preparedHeaders: mockHeaders,
                    shouldWork: !!(token && user),
                    issues: []
                };
                
                if (!token) result.issues.push('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç accessToken');
                if (!user) result.issues.push('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç user');
                
                diagnosticResults.redux = result;
                currentStep = 4;
                updateProgress();
                
                logResult('redux-result', result, result.shouldWork ? 'success' : 'error');
                updateOverallStatus('–°–∏–º—É–ª—è—Ü–∏—è Redux –∑–∞–≤–µ—Ä—à–µ–Ω–∞', result.shouldWork ? 'success' : 'error');
                
            } catch (error) {
                const errorResult = { error: error.message };
                diagnosticResults.redux = errorResult;
                logResult('redux-result', errorResult, 'error');
                updateOverallStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–º—É–ª—è—Ü–∏–∏ Redux', 'error');
            }
        }

        // === –ü–†–û–í–ï–†–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø –§–†–û–ù–¢–ï–ù–î–ê ===
        function checkFrontendState() {
            const checks = {
                localStorage: {
                    token: !!localStorage.getItem(TOKEN_KEY),
                    user: !!localStorage.getItem(USER_KEY),
                    allKeys: Object.keys(localStorage).filter(k => k.includes('tvoya_shina'))
                },
                expectedBehavior: {
                    shouldHaveToken: '–î–∞, –¥–ª—è Bearer –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏',
                    shouldHaveUser: '–î–∞, –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞',
                    shouldHaveCookies: '–î–∞, –¥–ª—è refresh —Ç–æ–∫–µ–Ω–∞'
                },
                recommendations: []
            };
            
            if (!checks.localStorage.token) {
                checks.recommendations.push('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å accessToken –≤ localStorage –∏–ª–∏ Redux state');
            }
            if (!checks.localStorage.user) {
                checks.recommendations.push('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage');
            }
            
            logResult('redux-result', checks, 
                checks.localStorage.token && checks.localStorage.user ? 'success' : 'warning');
        }

        // === –¢–ï–°–¢ CORS ===
        async function runCORSTest() {
            try {
                updateOverallStatus('–¢–µ—Å—Ç–∏—Ä—É–µ–º CORS –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏...', 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º OPTIONS –∑–∞–ø—Ä–æ—Å
                const optionsResponse = await fetch(`${API_BASE}/api/v1/bookings`, {
                    method: 'OPTIONS',
                    credentials: 'include'
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ CORS
                const corsHeaders = {
                    'Access-Control-Allow-Origin': optionsResponse.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Credentials': optionsResponse.headers.get('Access-Control-Allow-Credentials'),
                    'Access-Control-Allow-Methods': optionsResponse.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': optionsResponse.headers.get('Access-Control-Allow-Headers')
                };
                
                const result = {
                    options: {
                        success: optionsResponse.ok,
                        status: optionsResponse.status
                    },
                    corsHeaders: corsHeaders,
                    frontendOrigin: window.location.origin,
                    apiOrigin: API_BASE
                };

                diagnosticResults.cors = result;
                currentStep = 5;
                updateProgress();
                
                logResult('cors-result', result, 'info');
                updateOverallStatus('–¢–µ—Å—Ç CORS –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
                
            } catch (error) {
                const errorResult = { error: error.message };
                diagnosticResults.cors = errorResult;
                logResult('cors-result', errorResult, 'error');
                updateOverallStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ CORS', 'error');
            }
        }

        // === –¢–ï–°–¢ –ó–ê–ì–û–õ–û–í–ö–û–í ===
        async function runHeadersTest() {
            const token = localStorage.getItem(TOKEN_KEY);
            
            if (!token) {
                logResult('cors-result', { error: '–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω' }, 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/bookings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const responseHeaders = {};
                response.headers.forEach((value, key) => {
                    responseHeaders[key] = value;
                });
                
                logResult('cors-result', {
                    request: {
                        headers: {
                            'Authorization': `Bearer ${token.substring(0, 20)}...`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    },
                    response: {
                        status: response.status,
                        headers: responseHeaders
                    }
                }, response.ok ? 'success' : 'error');
                
            } catch (error) {
                logResult('cors-result', { error: error.message }, 'error');
            }
        }

        // === –û–¢–ö–†–´–¢–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–û–í ===
        function openAdminInterface() {
            window.open(`${FRONTEND_BASE}/bookings`, '_blank');
            logResult('interface-result', `–û—Ç–∫—Ä—ã—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–≤—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: ${FRONTEND_BASE}/bookings`, 'info');
        }

        function openClientInterface() {
            window.open(`${FRONTEND_BASE}/client/booking/new-with-availability`, '_blank');
            logResult('interface-result', `–û—Ç–∫—Ä—ã—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: ${FRONTEND_BASE}/client/booking/new-with-availability`, 'info');
        }

        // === –û–ß–ò–°–¢–ö–ê –î–ê–ù–ù–´–• ===
        function clearAuthData() {
            localStorage.removeItem(TOKEN_KEY);
            localStorage.removeItem(USER_KEY);
            
            // –û—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            diagnosticResults = {
                auth: null,
                bookings: null,
                cookies: null,
                redux: null,
                cors: null
            };
            
            currentStep = 0;
            updateProgress();
            
            updateOverallStatus('–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—á–∏—â–µ–Ω—ã', 'info');
            logResult('auth-result', '–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'info');
        }

        // === –ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ===
        async function runFullDiagnostic() {
            updateOverallStatus('–ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...', 'info');
            currentStep = 0;
            updateProgress();
            
            await runAuthTest();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await runBookingsTest();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await runCookieTest();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            simulateReduxFlow();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await runCORSTest();
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
            const report = {
                timestamp: new Date().toLocaleString(),
                results: diagnosticResults,
                summary: {
                    authWorks: !!diagnosticResults.auth?.login?.success,
                    bookingsAPIWorks: !!diagnosticResults.bookings?.withBearerToken?.success || !!diagnosticResults.bookings?.withCookiesOnly?.success,
                    cookiesWork: !!diagnosticResults.cookies?.cookieAuth?.success,
                    reduxSimulation: !!diagnosticResults.redux?.shouldWork,
                    corsOK: !!diagnosticResults.cors
                },
                recommendations: []
            };
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            if (!report.summary.authWorks) {
                report.recommendations.push('‚ùå –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
            }
            if (!report.summary.bookingsAPIWorks) {
                report.recommendations.push('‚ùå –ò—Å–ø—Ä–∞–≤–∏—Ç—å API –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∏–ª–∏ –ø–µ—Ä–µ–¥–∞—á—É —Ç–æ–∫–µ–Ω–æ–≤');
            }
            if (!report.summary.cookiesWork) {
                report.recommendations.push('‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ HttpOnly cookies');
            }
            if (!report.summary.reduxSimulation) {
                report.recommendations.push('‚ùå –ò—Å–ø—Ä–∞–≤–∏—Ç—å Redux —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
            }
            
            if (report.recommendations.length === 0) {
                report.recommendations.push('‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!');
            }
            
            logResult('full-report', report, 
                report.recommendations.length === 1 && report.recommendations[0].startsWith('‚úÖ') ? 'success' : 'warning');
            
            updateOverallStatus('–ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 
                report.recommendations.length === 1 && report.recommendations[0].startsWith('‚úÖ') ? 'success' : 'warning');
        }

        // === –≠–ö–°–ü–û–†–¢ –û–¢–ß–ï–¢–ê ===
        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                results: diagnosticResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auth-diagnostic-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateOverallStatus('–û—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            updateOverallStatus('–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const hasToken = !!localStorage.getItem(TOKEN_KEY);
            const hasUser = !!localStorage.getItem(USER_KEY);
            
            if (hasToken && hasUser) {
                updateOverallStatus('–ù–∞–π–¥–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'info');
            } else {
                updateOverallStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
            }
        };
    </script>
</body>
</html>
