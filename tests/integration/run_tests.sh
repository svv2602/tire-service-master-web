#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-–±—ç–∫–µ–Ω–¥
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./run_tests.sh [node|browser|all]

set -e

API_URL="http://localhost:8000"
FRONTEND_URL="http://localhost:3000"

echo "üß™ =============================================="
echo "    –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –§–†–û–ù–¢–ï–ù–î-–ë–≠–ö–ï–ù–î"
echo "=============================================="
echo

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
check_services() {
    echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ API
    if curl -s "$API_URL/api/v1/health" > /dev/null; then
        echo "‚úÖ API ($API_URL) - –î–û–°–¢–£–ü–ï–ù"
    else
        echo "‚ùå API ($API_URL) - –ù–ï–î–û–°–¢–£–ü–ï–ù"
        echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ API: cd ../../../tire-service-master-api && bundle exec rails server -p 8000"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
    if curl -s "$FRONTEND_URL" > /dev/null; then
        echo "‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ ($FRONTEND_URL) - –î–û–°–¢–£–ü–ï–ù"
    else
        echo "‚ùå –§—Ä–æ–Ω—Ç–µ–Ω–¥ ($FRONTEND_URL) - –ù–ï–î–û–°–¢–£–ü–ï–ù"
        echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥: cd ../../ && npm start"
        exit 1
    fi
    echo
}

# –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ Node.js —Ç–µ—Å—Ç–æ–≤
run_node_tests() {
    echo "üîß –ó–∞–ø—É—Å–∫ Node.js —Ç–µ—Å—Ç–æ–≤..."
    echo "=========================================="
    
    if command -v node >/dev/null 2>&1; then
        node test_frontend_integration.js
    else
        echo "‚ùå Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Node.js –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤."
        exit 1
    fi
    echo
}

# –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
run_browser_tests() {
    echo "üåê –ó–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
    echo "=========================================="
    echo "–ó–∞–ø—É—Å–∫ HTTP —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8080..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –ø–æ—Ä—Ç 8080
    if lsof -Pi :8080 -sTCP:LISTEN -t >/dev/null 2>&1; then
        echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 8080 —É–∂–µ –∑–∞–Ω—è—Ç. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç."
        echo "   –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: lsof -Pi :8080 -sTCP:LISTEN"
    else
        echo "üöÄ HTTP —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:8080"
        echo "üìñ –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:8080/test_frontend_browser.html"
        echo "‚èπÔ∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
        echo
        python3 -m http.server 8080
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –ø–æ–º–æ—â–∏
show_help() {
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–û–ü–¶–ò–Ø]"
    echo
    echo "–û–ü–¶–ò–ò:"
    echo "  node     - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ Node.js —Ç–µ—Å—Ç—ã"
    echo "  browser  - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Ç–µ—Å—Ç—ã"
    echo "  all      - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
    echo "  help     - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0           # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã"
    echo "  $0 node      # –¢–æ–ª—å–∫–æ Node.js —Ç–µ—Å—Ç—ã"
    echo "  $0 browser   # –¢–æ–ª—å–∫–æ –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Ç–µ—Å—Ç—ã"
    echo
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
case "${1:-all}" in
    "node")
        check_services
        run_node_tests
        echo "‚úÖ Node.js —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
        ;;
    "browser")
        check_services
        run_browser_tests
        ;;
    "all")
        check_services
        run_node_tests
        echo "üéØ Node.js —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã! –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Ç–µ—Å—Ç—ã..."
        echo "   –ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–ª–∏ Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞"
        read -r
        run_browser_tests
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    *)
        echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø—Ü–∏—è: $1"
        echo
        show_help
        exit 1
        ;;
esac 