<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥ - –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>–¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥</h1>
    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="results"></div>
    
    <script>
        const API_URL = 'http://localhost:8000/api/v1';
        
        async function runTests() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                statusDiv.textContent = '–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è...';
                
                // 1. –õ–æ–≥–∏–Ω–∏–º—Å—è
                const loginResponse = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        auth: {
                            login: 'admin@test.com',
                            password: 'admin123'
                        }
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${loginResponse.status}`);
                }
                
                const loginData = await loginResponse.json();
                const token = loginData.tokens?.access;
                
                if (!token) {
                    throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω –∏–∑ –æ—Ç–≤–µ—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
                
                statusDiv.textContent = '–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞';
                resultsDiv.innerHTML += '<p>‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞</p>';
                
                // 2. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥
                statusDiv.textContent = '–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—Å–ª—É–≥...';
                
                const servicesResponse = await fetch(`${API_URL}/service_categories/3/services`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!servicesResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å–ª—É–≥: ${servicesResponse.status}`);
                }
                
                const services = await servicesResponse.json();
                resultsDiv.innerHTML += `<p>‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —É—Å–ª—É–≥: ${services.length}</p>`;
                
                if (services.length === 0) {
                    resultsDiv.innerHTML += '<p>‚ö†Ô∏è –ù–µ—Ç —É—Å–ª—É–≥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è</p>';
                    statusDiv.textContent = '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω - –Ω–µ—Ç —É—Å–ª—É–≥';
                    return;
                }
                
                // 3. –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —É—Å–ª—É–≥—É
                const serviceToDelete = services[services.length - 1];
                statusDiv.textContent = `–£–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏ "${serviceToDelete.name}"...`;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ URL
                const categoryId = '3';
                const serviceId = String(serviceToDelete.id);
                const deleteUrl = `${API_URL}/service_categories/${categoryId}/services/${serviceId}`;
                
                resultsDiv.innerHTML += `<p>üîó URL —É–¥–∞–ª–µ–Ω–∏—è: ${deleteUrl}</p>`;
                resultsDiv.innerHTML += `<p>üìã ID —É—Å–ª—É–≥–∏: ${serviceId} (—Ç–∏–ø: ${typeof serviceToDelete.id})</p>`;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –Ω–∞–ª–∏—á–∏–µ [object Object]
                if (deleteUrl.includes('[object') || deleteUrl.includes('undefined')) {
                    resultsDiv.innerHTML += '<p>‚ùå –û–®–ò–ë–ö–ê: URL —Å–æ–¥–µ—Ä–∂–∏—Ç [object Object] –∏–ª–∏ undefined!</p>';
                    statusDiv.textContent = '–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è URL';
                    return;
                }
                
                resultsDiv.innerHTML += '<p>‚úÖ URL —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</p>';
                
                // 4. –í—ã–ø–æ–ª–Ω—è–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
                const deleteResponse = await fetch(deleteUrl, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                resultsDiv.innerHTML += `<p>üì° –û—Ç–≤–µ—Ç DELETE: ${deleteResponse.status} ${deleteResponse.statusText}</p>`;
                
                if (deleteResponse.ok) {
                    resultsDiv.innerHTML += '<p>‚úÖ –£—Å–ª—É–≥–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!</p>';
                    
                    // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É—Å–ª—É–≥–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–µ–Ω–∞
                    statusDiv.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è...';
                    
                    const checkResponse = await fetch(`${API_URL}/service_categories/3/services`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const remainingServices = await checkResponse.json();
                        const stillExists = remainingServices.find(s => s.id === serviceToDelete.id);
                        
                        if (stillExists) {
                            resultsDiv.innerHTML += '<p>‚ùå –ü–†–û–ë–õ–ï–ú–ê: –£—Å–ª—É–≥–∞ –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</p>';
                        } else {
                            resultsDiv.innerHTML += '<p>‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û: –£—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞</p>';
                        }
                        
                        resultsDiv.innerHTML += `<p>üìä –£—Å–ª—É–≥ –æ—Å—Ç–∞–ª–æ—Å—å: ${remainingServices.length}</p>`;
                    }
                    
                    statusDiv.textContent = '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ';
                } else {
                    const errorText = await deleteResponse.text();
                    resultsDiv.innerHTML += `<p>‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${errorText}</p>`;
                    statusDiv.textContent = '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è';
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<p>‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}</p>`;
                statusDiv.textContent = '–¢–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω';
                console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞:', error);
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        runTests();
    </script>
</body>
</html>
